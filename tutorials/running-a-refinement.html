

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Running a Refinement (in detail) &mdash; MDMC 0.2 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../_static/nbsphinx-code-cells.css?v=2aa19091" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=10f1778b"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
      <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
      <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Understanding scientific units in MDMC" href="understanding-units.html" />
    <link rel="prev" title="Equilibrating simulations" href="equilibrating-a-simulation.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            MDMC
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Overview</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../introduction.html">1. Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contributing.html">2. Contributing to MDMC</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="Argon-a-to-z.html">Argon A-to-Z</a></li>
<li class="toctree-l1"><a class="reference internal" href="accessing-atom-properties.html">Creating Atoms and Accessing Properties</a></li>
<li class="toctree-l1"><a class="reference internal" href="equilibrating-a-simulation.html">Equilibrating simulations</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Running a Refinement (in detail)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#Refinement">Refinement</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Experimental-datasets">Experimental datasets</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Controlling-the-refinement">Controlling the refinement</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Controlling-the-parameters">Controlling the parameters</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Controlling-the-figure-of-merit">Controlling the figure of merit</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Running-the-refinement">Running the refinement</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Resolution-Function">Resolution Function</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Refinement-Output">Refinement Output</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Refinement-plotting">Refinement plotting</a></li>
<li class="toctree-l2"><a class="reference internal" href="#FoM-and-Parameter-Plotting">FoM and Parameter Plotting</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="understanding-units.html">Understanding scientific units in MDMC</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">How-to</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../how-to/use-MDMC.html">How to use MDMC</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how-to/installation.html">Installation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../reference/api/modules.html">MDMC</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Explanation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../explanation/explanation.html">Explanation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../developer/overview.html">Developer Documentation</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">MDMC</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Running a Refinement (in detail)</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/tutorials/running-a-refinement.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="Running-a-Refinement-(in-detail)">
<h1>Running a Refinement (in detail)<a class="headerlink" href="#Running-a-Refinement-(in-detail)" title="Link to this heading"></a></h1>
<p>This tutorial walks through running a refinement in more detail than the <a class="reference internal" href="Argon-a-to-z.html"><span class="doc">Argon a-to-z tutorial</span></a>. The following tutorials in brackets also provide more detail on creating the simulation setup for this tutorial.</p>
<p>By the end of this tutorial, a reader familiar with MD simulation should be capable of applying MDMC refinements to their own datasets and simulations.</p>
<p>In order to refine potential parameters the following is required:</p>
<ul class="simple">
<li><p>A <code class="docutils literal notranslate"><span class="pre">Universe</span></code> which contains one or more atoms. (<a class="reference external" href="../how-to/use-MDMC/notebooks/building-a-universe.ipynb">Building a Universe</a>)</p></li>
<li><p>A <code class="docutils literal notranslate"><span class="pre">Simulation</span></code> which runs using the <code class="docutils literal notranslate"><span class="pre">Universe</span></code>. (<a class="reference internal" href="../how-to/use-MDMC/notebooks/running-a-simulation.html"><span class="doc">Running a Simulation</span></a>)</p></li>
<li><p>One or more <code class="docutils literal notranslate"><span class="pre">Parameters</span></code> to refine. (<a class="reference internal" href="../how-to/use-MDMC/notebooks/selecting-fitting-parameters.html"><span class="doc">Selecting fitting Parameters</span></a>)</p></li>
<li><p>One or more experimental datasets.</p></li>
</ul>
<p>If you would like more detail on these, please see the tutorials in brackets; the actual setup of the simulation will be done quite concisely here.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="c1"># This setting tells MDMC how many physical cores on your computer it should use</span>
<span class="c1"># for simulation and refinement calculations.</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;OMP_NUM_THREADS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;4&quot;</span>
</pre></div>
</div>
</div>
<section id="Refinement">
<h2>Refinement<a class="headerlink" href="#Refinement" title="Link to this heading"></a></h2>
<p>By ‘refinement’ we mean <a class="reference external" href="https://en.wikipedia.org/wiki/Simulation-based_optimization">optimising a simulation</a> to match an experimental dataset. We do this by running the simulation with some given parameters (for example, with a Lennard-Jones potential these parameters are the sigma (<span class="math notranslate nohighlight">\(\sigma\)</span>) and epsilon (<span class="math notranslate nohighlight">\(\varepsilon\)</span>) that define the potential energy), and calculating the <a class="reference external" href="https://mathworld.wolfram.com/MeritFunction.html">figure of merit (FoM)</a>; this is simply a number
representing how different our simulation is to our dataset.</p>
<p>The goal of the refinement is to minimize the figure of merit (make it as close to zero as possible); we do this by tweaking the parameters and seeing how this changes the figure of merit. Over time, the MDMC <code class="docutils literal notranslate"><span class="pre">Minimizer</span></code> uses this to build up an understanding of how the simulation changes when the parameters change, and thus find what combination of parameters produces the smallest figure of merit. We call this a “parameter space”; for two parameters (say, the Lennard-Jones <span class="math notranslate nohighlight">\(\sigma\)</span> and
<span class="math notranslate nohighlight">\(\varepsilon\)</span>), picture a topographical map with <span class="math notranslate nohighlight">\(\sigma\)</span> on the x-axis, <span class="math notranslate nohighlight">\(\varepsilon\)</span> on the y-axis, and the hills and valleys corresponding to the figure of merit at those values. Our minimizer aims to find the lowest valley on the map.</p>
<p>This is done in a variety of ways by different minimisers; for example, the <a class="reference external" href="https://en.wikipedia.org/wiki/Metropolis%E2%80%93Hastings_algorithm">Metropolis-Hastings minimizer</a> (<code class="docutils literal notranslate"><span class="pre">&quot;MMC&quot;</span></code> in MDMC) will ‘walk around’ the parameter space and backtrack if it finds the figure of merit increasing in that direction; or the <a class="reference external" href="https://scikit-learn.org/stable/modules/gaussian_process.html">Gaussian process minimizer</a> (<code class="docutils literal notranslate"><span class="pre">&quot;GPR&quot;</span></code> in MDMC) will aim to ‘map out’ the parameter space to find where the
lowest points are.</p>
<p>Please see the relevant explanation pages if you would like to learn more about <a class="reference internal" href="../explanation/minimizers.html"><span class="doc">minimizers</span></a> or the <a class="reference internal" href="../explanation/figure-of-merit.html"><span class="doc">figure of merit</span></a>.</p>
</section>
<section id="Experimental-datasets">
<h2>Experimental datasets<a class="headerlink" href="#Experimental-datasets" title="Link to this heading"></a></h2>
<p>MDMC’s support for experimental datasets requires two things: the relevant <code class="docutils literal notranslate"><span class="pre">Observable</span></code> (e.g. dynamic structure factor <span class="math notranslate nohighlight">\(S(Q,w)\)</span>) must be available, and a <code class="docutils literal notranslate"><span class="pre">Reader</span></code> for the specific file format of the data must be implemented (e.g. the <code class="docutils literal notranslate"><span class="pre">LAMPSQw</span></code> <code class="docutils literal notranslate"><span class="pre">Reader</span></code>, which reads the LAMP output file format for dynamic structure factors). If this is not the case for a dataset you’d like to use, please file an issue in the MDMC github repository or contact
<a class="reference external" href="mailto://support&#37;&#52;&#48;mdmcproject&#46;org">support<span>&#64;</span>mdmcproject<span>&#46;</span>org</a>.</p>
<p>Each experimental dataset must be specified by a Python dictionary containing the following:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">file_name</span></code> : A string with the file name of the experimental data</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">type</span></code> : A string specifying the type of <code class="docutils literal notranslate"><span class="pre">Observable</span></code> which describes the data (e.g. SQw if the data is the dynamic structure factor, PDF if the data is the pair distribution function).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">reader</span></code> : A string specifying the name of the <code class="docutils literal notranslate"><span class="pre">ObservableReader</span></code> which will be used to read the file.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">weight</span></code> : A float which determines the relative importance weighting of this dataset to other datasets, if multiple datasets are being refined at the same time.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">rescale_factor</span></code>, optional : A float which rescales the experimental data linearly in order to match the absolute scale of the simulated data when calculating the Figure of Merit (FoM). Default is <code class="docutils literal notranslate"><span class="pre">1.</span></code>, i.e. no change to the data.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">auto_scale</span></code>, optional : A boolean specifying whether to automatically set the <code class="docutils literal notranslate"><span class="pre">rescale_factor</span></code> at each step of the refinement to the value which minimizes the FoM. Default is <code class="docutils literal notranslate"><span class="pre">False</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">use_FFT</span></code>, optional : A boolean specifying whether to use the Fast Fourier Transform (FFT) in the calculation of variables from MD, which are faster but can impose restrictions on the uniformity of variables. Default is <code class="docutils literal notranslate"><span class="pre">True</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">resolution</span></code> : a one-line dict of format <code class="docutils literal notranslate"><span class="pre">{'file'</span> <span class="pre">:</span> <span class="pre">str}</span></code> or <code class="docutils literal notranslate"><span class="pre">{key</span> <span class="pre">:</span> <span class="pre">float}</span></code>. if <code class="docutils literal notranslate"><span class="pre">{'file'</span> <span class="pre">:</span> <span class="pre">str}</span></code>, the <code class="docutils literal notranslate"><span class="pre">str</span></code> should be a file in the same format as <code class="docutils literal notranslate"><span class="pre">file_name</span></code> containing results of a vanadium sample which is used to determine instrument energy resolution for this dataset. If <code class="docutils literal notranslate"><span class="pre">{key</span> <span class="pre">:</span> <span class="pre">float}</span></code>, the key should be the type of numeric resolution, with the key being the function type (e.g. <code class="docutils literal notranslate"><span class="pre">'gaussian'</span></code> or <code class="docutils literal notranslate"><span class="pre">'lorentzian'</span></code>), and the float the FWHM for that function.</p></li>
</ul>
<p>For this tutorial we are using <a class="reference external" href="https://doi.org/10.1063/1.3578472">Johan Qvist et al (2011)</a>’s data for supercooled water.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Dataset from: Johan Qvist et al, J. Chem. Phys. 134, 144508 (2011)</span>
<span class="n">QENS</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;file_name&#39;</span><span class="p">:</span><span class="s1">&#39;data/263K05Awat_LAMP&#39;</span><span class="p">,</span>
        <span class="s1">&#39;type&#39;</span><span class="p">:</span><span class="s1">&#39;SQw&#39;</span><span class="p">,</span>
        <span class="s1">&#39;reader&#39;</span><span class="p">:</span><span class="s1">&#39;LAMPSQw&#39;</span><span class="p">,</span>
        <span class="s1">&#39;weight&#39;</span><span class="p">:</span><span class="mf">1.</span><span class="p">,</span>
        <span class="s1">&#39;auto_scale&#39;</span><span class="p">:</span><span class="kc">True</span><span class="p">,</span>
        <span class="s1">&#39;use_FFT&#39;</span><span class="p">:</span><span class="kc">False</span><span class="p">,</span>
        <span class="s1">&#39;resolution&#39;</span><span class="p">:{</span><span class="s1">&#39;file&#39;</span><span class="p">:</span> <span class="s1">&#39;data/262p7K0A5van_LAMP&#39;</span><span class="p">}}</span>
</pre></div>
</div>
</div>
<p>As the dataset we are using has both negative energy values and non-uniform spacing, the default behaviour of <code class="docutils literal notranslate"><span class="pre">use_FFT=True</span></code> would cause the data to be interpolated as part of the refinement process. Setting this to <code class="docutils literal notranslate"><span class="pre">False</span></code> allows us to preserve the original energy values.</p>
<p>The default behaviour of the scaling (<code class="docutils literal notranslate"><span class="pre">rescale_factor=1.</span></code>, <code class="docutils literal notranslate"><span class="pre">auto_scale=False</span></code>) assumes that the dataset provided has been properly scaled and normalised for the refinement process. This is the preferred way of using MDMC, and arbitrary or automatic rescaling should be undertaken with care. For example, using <code class="docutils literal notranslate"><span class="pre">auto_scale</span></code> to determine the scaling does not take into account any physical aspects of scaling the data, such as the presence or absence of background events from peaks outside its
range.</p>
<p>The specific manner in which the <code class="docutils literal notranslate"><span class="pre">weight</span></code> applies to calculating the figure of merit (FoM) depends on the particular FoM which is used for the refinement. By default this is a least-squares difference weighted by the experimental error (<code class="docutils literal notranslate"><span class="pre">StandardFoMCalculator</span></code>):</p>
<p><span class="math notranslate nohighlight">\(FoM_{total} = \sum_{i} FoM_{i}\)</span></p>
<p>where the sum is over the number of experimental datasets and we calculate a weighted FoM for the <span class="math notranslate nohighlight">\(i\)</span>-th dataset as follows:</p>
<p><span class="math notranslate nohighlight">\(FoM_{i} = w_{i} \sum_{j} \left( \frac{D_{j}^{exp} - D_{j}^{sim}}{\sigma_{j}^{exp}} \right)^2\)</span></p>
<p><span class="math notranslate nohighlight">\(D_{j}\)</span> is an observable, <span class="math notranslate nohighlight">\(\sigma_{j}\)</span> is the error associated with the observable, and <span class="math notranslate nohighlight">\(exp\)</span> and <span class="math notranslate nohighlight">\(sim\)</span> refer to the experimental and simulated data respectively. <span class="math notranslate nohighlight">\(D_{j}\)</span> and <span class="math notranslate nohighlight">\(\sigma_{j}\)</span> are N-dimensional arrays of all the data points for a dataset.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">exp_datasets</span></code> parameter which is passed to <code class="docutils literal notranslate"><span class="pre">Control</span></code> is a list of all dataset dictionaries. In this instance there is only a single experimental dataset:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">exp_datasets</span> <span class="o">=</span> <span class="p">[</span><span class="n">QENS</span><span class="p">]</span>
</pre></div>
</div>
</div>
<p>If another dataset were to be included, for example the pair distribution function, this would require its own dictionary:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n_diffraction</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;file_name&#39;</span><span class="p">:</span><span class="s1">&#39;data/water_PDF&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;type&#39;</span><span class="p">:</span><span class="s1">&#39;PDF&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;reader&#39;</span><span class="p">:</span><span class="s1">&#39;ASCII&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;weight&#39;</span><span class="p">:</span><span class="mf">1.</span><span class="p">,</span>
                 <span class="s1">&#39;auto_scale&#39;</span><span class="p">:</span><span class="kc">True</span><span class="p">,</span>
                 <span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;gaussian&#39;</span><span class="p">:</span> <span class="mi">84</span><span class="p">}}</span>
<span class="n">two_exp_datasets</span> <span class="o">=</span> <span class="p">[</span><span class="n">QENS</span><span class="p">,</span> <span class="n">n_diffraction</span><span class="p">]</span>
</pre></div>
</div>
</div>
</section>
<section id="Controlling-the-refinement">
<h2>Controlling the refinement<a class="headerlink" href="#Controlling-the-refinement" title="Link to this heading"></a></h2>
<p>As in the <a class="reference internal" href="../how-to/use-MDMC/notebooks/running-a-simulation.html"><span class="doc">Running a Simulation</span></a> guide, we use a <code class="docutils literal notranslate"><span class="pre">Universe</span></code> filled with SPCE water molecules. This simulation uses a force field for interactions, and also features constraint algorithms and long-range interaction solvers; a lot more advanced than the simulation used for argon!</p>
<p>As this minimizes and equilibrates a small simulation, it may take a small while to execute.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">MDMC.MD</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>

<span class="n">universe</span> <span class="o">=</span> <span class="n">Universe</span><span class="p">(</span><span class="n">dimensions</span><span class="o">=</span><span class="mf">21.75</span><span class="p">,</span> <span class="n">constraint_algorithm</span><span class="o">=</span><span class="n">Shake</span><span class="p">(</span><span class="mf">1e-4</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span> <span class="n">electrostatic_solver</span><span class="o">=</span><span class="n">PPPM</span><span class="p">(</span><span class="n">accuracy</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">))</span>
<span class="n">H1</span> <span class="o">=</span> <span class="n">Atom</span><span class="p">(</span><span class="s1">&#39;H&#39;</span><span class="p">)</span>
<span class="n">H2</span> <span class="o">=</span> <span class="n">Atom</span><span class="p">(</span><span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="n">position</span><span class="o">=</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.63298</span><span class="p">,</span> <span class="mf">0.</span><span class="p">))</span>
<span class="n">O</span> <span class="o">=</span> <span class="n">Atom</span><span class="p">(</span><span class="s1">&#39;O&#39;</span><span class="p">,</span> <span class="n">position</span><span class="o">=</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.81649</span><span class="p">,</span> <span class="mf">0.57736</span><span class="p">))</span>
<span class="n">H_coulombic</span> <span class="o">=</span> <span class="n">Coulombic</span><span class="p">(</span><span class="n">atoms</span><span class="o">=</span><span class="p">[</span><span class="n">H1</span><span class="p">,</span> <span class="n">H2</span><span class="p">],</span> <span class="n">cutoff</span><span class="o">=</span><span class="mf">10.</span><span class="p">)</span>
<span class="n">O_coulombic</span> <span class="o">=</span> <span class="n">Coulombic</span><span class="p">(</span><span class="n">atoms</span><span class="o">=</span><span class="n">O</span><span class="p">,</span> <span class="n">cutoff</span><span class="o">=</span><span class="mf">10.</span><span class="p">)</span>
<span class="n">water_mol</span> <span class="o">=</span> <span class="n">Molecule</span><span class="p">(</span><span class="n">position</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                     <span class="n">velocity</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                     <span class="n">atoms</span><span class="o">=</span><span class="p">[</span><span class="n">H1</span><span class="p">,</span> <span class="n">H2</span><span class="p">,</span> <span class="n">O</span><span class="p">],</span>
                     <span class="n">interactions</span><span class="o">=</span><span class="p">[</span><span class="n">Bond</span><span class="p">((</span><span class="n">H1</span><span class="p">,</span> <span class="n">O</span><span class="p">),</span> <span class="p">(</span><span class="n">H2</span><span class="p">,</span> <span class="n">O</span><span class="p">),</span> <span class="n">constrained</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                                   <span class="n">BondAngle</span><span class="p">(</span><span class="n">H1</span><span class="p">,</span> <span class="n">O</span><span class="p">,</span> <span class="n">H2</span><span class="p">,</span> <span class="n">constrained</span><span class="o">=</span><span class="kc">True</span><span class="p">)],</span>
                     <span class="n">name</span><span class="o">=</span><span class="s1">&#39;water&#39;</span><span class="p">)</span>
<span class="n">universe</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">water_mol</span><span class="p">,</span> <span class="n">num_density</span><span class="o">=</span><span class="mf">0.03356718472021752</span><span class="p">)</span>
<span class="n">O_dispersion</span> <span class="o">=</span> <span class="n">Dispersion</span><span class="p">(</span><span class="n">universe</span><span class="p">,</span> <span class="p">[</span><span class="n">O</span><span class="o">.</span><span class="n">atom_type</span><span class="p">,</span> <span class="n">O</span><span class="o">.</span><span class="n">atom_type</span><span class="p">],</span> <span class="n">cutoff</span><span class="o">=</span><span class="mf">10.</span><span class="p">,</span> <span class="n">vdw_tail_correction</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">universe</span><span class="o">.</span><span class="n">add_force_field</span><span class="p">(</span><span class="s1">&#39;SPCE&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Our <code class="docutils literal notranslate"><span class="pre">Simulation</span></code> object also sets a specific thermostat and barostat for MD simulation, and various other settings. See <a class="reference internal" href="../how-to/use-MDMC/notebooks/running-a-simulation.html"><span class="doc">Running a Simulation</span></a> for more details.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">simulation</span> <span class="o">=</span> <span class="n">Simulation</span><span class="p">(</span><span class="n">universe</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;lammps&#39;</span><span class="p">,</span> <span class="n">time_step</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="mf">300.</span><span class="p">,</span>
                        <span class="n">pressure</span><span class="o">=</span><span class="mf">101325.</span><span class="p">,</span> <span class="n">traj_step</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">thermostat</span><span class="o">=</span><span class="s1">&#39;nose&#39;</span><span class="p">,</span>
                        <span class="n">barostat</span><span class="o">=</span><span class="s1">&#39;nose&#39;</span><span class="p">,</span> <span class="n">t_damp</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">p_damp</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>

<span class="n">simulation</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="n">minimize_every</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">simulation</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="n">equilibration</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">simulation</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="mi">2000</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="Controlling-the-parameters">
<h2>Controlling the parameters<a class="headerlink" href="#Controlling-the-parameters" title="Link to this heading"></a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">Parameter</span></code>s of the <code class="docutils literal notranslate"><span class="pre">Universe</span></code> can have various restrictions placed on them for the purposes of refinement.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">universe</span> <span class="o">=</span> <span class="n">simulation</span><span class="o">.</span><span class="n">universe</span>
<span class="n">fit_parameters</span> <span class="o">=</span> <span class="n">universe</span><span class="o">.</span><span class="n">parameters</span>
<span class="nb">print</span><span class="p">(</span><span class="n">fit_parameters</span><span class="p">[</span><span class="s1">&#39;epsilon&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<p>The value of one <code class="docutils literal notranslate"><span class="pre">Parameter</span></code> can be <code class="docutils literal notranslate"><span class="pre">tied</span></code> to that of another if there is some physical reason why it should be dependent on it. For example, in a water molecule setting the charge of the oxygen to be -2 times that of the hydrogen:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fit_parameters</span><span class="p">[</span><span class="s1">&#39;charge&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_tie</span><span class="p">(</span><span class="n">fit_parameters</span><span class="p">[</span><span class="s1">&#39;charge&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39; * - 2&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">fit_parameters</span><span class="p">[</span><span class="s1">&#39;charge&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
</div>
<p>The value of a <code class="docutils literal notranslate"><span class="pre">Parameter</span></code> can have <code class="docutils literal notranslate"><span class="pre">constraints</span></code> set to limit it’s value to a certain range:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fit_parameters</span><span class="p">[</span><span class="s1">&#39;epsilon&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">constraints</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">fit_parameters</span><span class="p">[</span><span class="s1">&#39;epsilon&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<p>Finally, a <code class="docutils literal notranslate"><span class="pre">Parameter</span></code> can be <code class="docutils literal notranslate"><span class="pre">fixed</span></code> outright to whatever value it currently has.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fit_parameters</span><span class="p">[</span><span class="s1">&#39;equilibrium_state&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">fixed</span> <span class="o">=</span> <span class="kc">True</span>
<span class="nb">print</span><span class="p">(</span><span class="n">fit_parameters</span><span class="p">[</span><span class="s1">&#39;equilibrium_state&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
</div>
<p>Note that <code class="docutils literal notranslate"><span class="pre">Parameter</span></code>s that are <code class="docutils literal notranslate"><span class="pre">fixed</span></code>, <code class="docutils literal notranslate"><span class="pre">tied</span></code>, or equal to 0 cannot be refined and so will not be passed to the <code class="docutils literal notranslate"><span class="pre">Minimizer</span></code> when the <code class="docutils literal notranslate"><span class="pre">Control</span></code> object is created. If <code class="docutils literal notranslate"><span class="pre">constraints</span></code> are set then refinement will occur however any proposed values that happen to lie outside the range of the <code class="docutils literal notranslate"><span class="pre">constraints</span></code> will be clipped.</p>
<p>Restricting the value of a <code class="docutils literal notranslate"><span class="pre">Parameter</span></code> in these ways applies to the Monte Carlo aspect of MDMC. Namely, it affects how the <code class="docutils literal notranslate"><span class="pre">Parameter</span></code> is allowed to change between refinement steps. It should not be confused with the use of <code class="docutils literal notranslate"><span class="pre">constraint_algorithm</span></code>s when creating a <code class="docutils literal notranslate"><span class="pre">Universe</span></code> (see <a class="reference external" href="../how-to/use-MDMC/notebooks/building-a-universe.ipynb">Building a Universe</a>). The latter controls whether or not aspects of the <code class="docutils literal notranslate"><span class="pre">Universe</span></code> such as bonds are treated as rigid or not during molecular
dynamics. It is entirely possible to have a rigid bond but allow the length of that bond to change between refinement steps, or conversely have a bond that is free to oscillate during MD but the equilibrium length is not altered as part of the refinement.</p>
</section>
<section id="Controlling-the-figure-of-merit">
<h2>Controlling the figure of merit<a class="headerlink" href="#Controlling-the-figure-of-merit" title="Link to this heading"></a></h2>
<p>The figure of merit (FoM) used in the refinement process to assess the goodness of fit between MD and experimental data can be configured using a dictionary with the following key/value pairs:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">error</span></code> : <code class="docutils literal notranslate"><span class="pre">{'exp',</span> <span class="pre">'none'}</span></code> Whether to weight the FoM using the experimental errors of the data or not (respectively). The former results in values with larger (relative) error contributing less to the overall FoM.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">norm</span></code> : <code class="docutils literal notranslate"><span class="pre">{'data_points',</span> <span class="pre">'dof',</span> <span class="pre">'none'}</span></code> Whether to normalise the FoM using the total number of data points, the degrees of freedom (for the chi-squared figure of merit, this is number of data points minus the number of varying parameters), or not at all.</p></li>
</ul>
<p>If not provided then the FoM defaults to using the first options, namely:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">FoM_options</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span><span class="s1">&#39;exp&#39;</span><span class="p">,</span> <span class="s1">&#39;norm&#39;</span><span class="p">:</span><span class="s1">&#39;data_points&#39;</span><span class="p">}</span>
</pre></div>
</div>
</div>
<p>Currently, the only option for the overall form of the FoM is that of a <a class="reference external" href="https://en.wikipedia.org/wiki/Goodness_of_fit#Pearson's_chi-square_test">chi-squared test</a>. Details of the implementation can be found at <a class="reference internal" href="../explanation/figure-of-merit.html"><span class="doc">this explanation page</span></a>.</p>
</section>
<section id="Running-the-refinement">
<h2>Running the refinement<a class="headerlink" href="#Running-the-refinement" title="Link to this heading"></a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">Control</span></code> object sets up and runs the refinement (using <code class="docutils literal notranslate"><span class="pre">Control.refine</span></code>). It uses the experimental datasets to refine the fitting <code class="docutils literal notranslate"><span class="pre">Parameters</span></code> for the specified <code class="docutils literal notranslate"><span class="pre">Simulation</span></code>:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Assuming a Universe called universe and a Simulation called simulation have been created</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">MDMC.control</span><span class="w"> </span><span class="kn">import</span> <span class="n">Control</span>

<span class="n">control</span> <span class="o">=</span> <span class="n">Control</span><span class="p">(</span><span class="n">simulation</span><span class="o">=</span><span class="n">simulation</span><span class="p">,</span>
                  <span class="n">exp_datasets</span><span class="o">=</span><span class="n">exp_datasets</span><span class="p">,</span>
                  <span class="n">fit_parameters</span><span class="o">=</span><span class="n">fit_parameters</span><span class="p">,</span>
                  <span class="n">MC_norm</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                  <span class="n">minimizer_type</span><span class="o">=</span><span class="s2">&quot;GPO&quot;</span><span class="p">,</span>
                  <span class="n">FoM_options</span> <span class="o">=</span> <span class="n">FoM_options</span><span class="p">,</span>
                  <span class="n">MD_steps</span><span class="o">=</span><span class="mi">424620</span><span class="p">,</span>
                  <span class="n">equilibration_steps</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
                  <span class="n">results_filename</span><span class="o">=</span><span class="s1">&#39;results_output_filename.csv&#39;</span><span class="p">,</span>
                  <span class="n">data_printer</span><span class="o">=</span><span class="s1">&#39;ipython&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Note that most of these parameters are what we’ve been setting up so far, and we’re just plugging them into the <code class="docutils literal notranslate"><span class="pre">Control</span></code> object which brings everything together and communicates between the components. See the <a class="reference internal" href="../how-to/use-MDMC/notebooks/running-a-simulation.html"><span class="doc">guide on running a simulation</span></a> for more information on the <code class="docutils literal notranslate"><span class="pre">Control</span></code> parameters.</p>
<p>During the refinement, in addition to running the simulation to calculate <code class="docutils literal notranslate"><span class="pre">Observable</span></code>s, the <code class="docutils literal notranslate"><span class="pre">Universe</span></code> can be equilibrated during refinement by providing a number of <code class="docutils literal notranslate"><span class="pre">equilibration_steps</span></code> that will be run in between the refinement steps. In general what constitutes an appropriate amount of equilibration will depend on both the <code class="docutils literal notranslate"><span class="pre">Universe</span></code> and the <code class="docutils literal notranslate"><span class="pre">Parameters</span></code> being varied. However, provided the changes caused by the refinement process are small, less equilibration should be needed
between steps than would be when first creating the <code class="docutils literal notranslate"><span class="pre">Simulation</span></code> object. <code class="docutils literal notranslate"><span class="pre">equilibration_steps</span></code> is an optional argument, with a default value of 0 (no equilibration).</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># So that the MD simulation size can be minimized, the Q min is increased and</span>
<span class="c1"># the Q resolution is reduced.</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="n">exp_obs</span> <span class="o">=</span> <span class="n">control</span><span class="o">.</span><span class="n">observable_pairs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">exp_obs</span>
<span class="n">Q_slice</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">exp_obs</span><span class="o">.</span><span class="n">Q</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">Q</span> <span class="o">=</span> <span class="n">exp_obs</span><span class="o">.</span><span class="n">Q</span><span class="p">[</span><span class="n">Q_slice</span><span class="p">]</span>
<span class="n">E</span> <span class="o">=</span> <span class="n">exp_obs</span><span class="o">.</span><span class="n">E</span>
<span class="c1"># copy the updated Q values back to the control.observable</span>
<span class="n">control</span><span class="o">.</span><span class="n">observable_pairs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">exp_obs</span><span class="o">.</span><span class="n">independent_variables</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;E&#39;</span><span class="p">:</span><span class="n">E</span><span class="p">,</span> <span class="s1">&#39;Q&#39;</span><span class="p">:</span><span class="n">Q</span><span class="p">}</span>
<span class="n">control</span><span class="o">.</span><span class="n">observable_pairs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">MD_obs</span><span class="o">.</span><span class="n">independent_variables</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;E&#39;</span><span class="p">:</span><span class="n">E</span><span class="p">,</span> <span class="s1">&#39;Q&#39;</span><span class="p">:</span><span class="n">Q</span><span class="p">}</span>
</pre></div>
</div>
</div>
</section>
<section id="Resolution-Function">
<h2>Resolution Function<a class="headerlink" href="#Resolution-Function" title="Link to this heading"></a></h2>
<p>As the dataset included a vanadium sample, this will be used to determine the instrument resolution as a function of momentum. This function is then used in calculations involving that corresponding dataset. Note for numerically defined reoslutions, the resolution function is not accessible as an array. The resolution function can be accessed from the <code class="docutils literal notranslate"><span class="pre">Observable</span></code> (note that it is transformed into the time domain to enable it to be applied multiplicatively to <code class="docutils literal notranslate"><span class="pre">FQt</span></code> rather than convolving
with <code class="docutils literal notranslate"><span class="pre">SQw</span></code>):</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">exp_obs</span> <span class="o">=</span> <span class="n">control</span><span class="o">.</span><span class="n">observable_pairs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">exp_obs</span>
<span class="c1">#help(exp_obs.resolution)</span>
<span class="n">resolution_function</span> <span class="o">=</span> <span class="n">exp_obs</span><span class="o">.</span><span class="n">resolution</span><span class="o">.</span><span class="n">resolution_function</span>
<span class="c1"># Note that for multidimensional resolution functions, the innermost independent variable should be passed first</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1e5</span><span class="p">)</span>
<span class="n">resolution_array</span> <span class="o">=</span> <span class="n">resolution_function</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">Q</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>The real and imaginary components of this can then be plotted as a 3D surface (note that for a Gaussian lineshape in the energy domain, one would expect no imaginary components and another Gaussian shape in the time domain):</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">matplotlib</span> notebook

<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">cm</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mpl_toolkits.mplot3d</span><span class="w"> </span><span class="kn">import</span> <span class="n">Axes3D</span>

<span class="k">def</span><span class="w"> </span><span class="nf">plot_SQw</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span> <span class="n">SQw</span><span class="p">):</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">projection</span><span class="o">=</span><span class="s1">&#39;3d&#39;</span><span class="p">)</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">E</span><span class="p">,</span> <span class="n">Q</span><span class="p">)</span>
    <span class="n">surf</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot_surface</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">SQw</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">viridis</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_SQw</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">resolution_array</span><span class="p">))</span>
<span class="n">plot_SQw</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="n">resolution_array</span><span class="p">))</span>
</pre></div>
</div>
</div>
<p>Note that for values outside the original range of the vanadium sample, nearest neighbour extrapolation is used.</p>
<p>When applied to calculated data the resolution window is normalised to have a value of 1 at time zero for all momentum. As the zero time component is directly proportional to the integral in the energy domain, this is equivalent to enforcing that the static structure factor of vanadium is constant for all momentum.</p>
<p>Once normalised in this way, this can be compared to the resolution from assuming a Gaussian lineshape with a FWHM of 84 ueV at a specific Q value:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">MDMC.common.constants</span><span class="w"> </span><span class="kn">import</span> <span class="n">h</span>
<span class="n">sigma_e</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span> <span class="o">*</span> <span class="mf">0.084</span>
<span class="c1"># h is in units of eV s whereas system units are meV fs, so apply a factor of 1e3 * 1e15 to convert it</span>
<span class="n">sigma_t</span> <span class="o">=</span> <span class="n">h</span> <span class="o">*</span> <span class="mf">1e18</span> <span class="o">/</span> <span class="n">sigma_e</span>
<span class="n">control</span><span class="o">.</span><span class="n">observable_pairs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">exp_obs</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="n">t</span>
<span class="n">time_resolution</span> <span class="o">=</span> <span class="n">exp_obs</span><span class="o">.</span><span class="n">_calculate_resolution_window</span><span class="p">(</span><span class="n">resolution_function</span><span class="p">)</span>
<span class="n">Q_index</span> <span class="o">=</span> <span class="mi">10</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">time_resolution</span><span class="p">)[</span><span class="n">Q_index</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Vanadium Resolution&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">t</span> <span class="o">/</span> <span class="n">sigma_t</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Gaussian Resolution&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
</div>
</section>
<section id="Refinement-Output">
<h2>Refinement Output<a class="headerlink" href="#Refinement-Output" title="Link to this heading"></a></h2>
<p>To refine the specified <code class="docutils literal notranslate"><span class="pre">fit_parameters</span></code>, run <code class="docutils literal notranslate"><span class="pre">control.refine</span></code> with the number of refinement steps specified.</p>
<p>If 0 steps are passed, an MD simulation is performed, the simulation <code class="docutils literal notranslate"><span class="pre">Observable</span></code> is calculated, and the FoM is calculated, however the <code class="docutils literal notranslate"><span class="pre">fit_parameters</span></code> are not modified. This can be used to determine the existing agreement between a simulation with the current <code class="docutils literal notranslate"><span class="pre">fit_parameters</span></code> and the experimental data.</p>
<p>As a refinement is running, it will print information from each step as it goes. By default this is to the terminal (<code class="docutils literal notranslate"><span class="pre">stdout</span></code>). The specific information depends on which minimizer is selected, however it will always include the current Figure of Merit and the values of the refined parameters. This information will also be saved to a CSV file named <code class="docutils literal notranslate"><span class="pre">results[time].csv</span></code> where <code class="docutils literal notranslate"><span class="pre">[time]</span></code> is a string of the current date and time.</p>
<p>Upon the completion of the refinement, the final parameter values will be output to the terminal. If <code class="docutils literal notranslate"><span class="pre">auto_scale</span></code> is set for any of the datasets, then the relevant scale factor(s) will also be printed. For stochastic minimization algorithms, such as MMC (Metropolis Monte Carlo), these values may not be the parameter values which resulted in the minimum Figure of Merit; however it is highly probable that these values will produce a Figure of Merit which is not significantly larger than the
minimum achieved.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">control</span><span class="o">.</span><span class="n">refine</span><span class="p">(</span><span class="n">n_steps</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="Refinement-plotting">
<h2>Refinement plotting<a class="headerlink" href="#Refinement-plotting" title="Link to this heading"></a></h2>
<p>If MDMC is being run in a Jupyter notebook, and matplotlib and ipywidgets are installed, it is also possible to dynamically plot one or more variables while the refinement is running. For example, it might be desirable to see how the FoM and one or more potential parameters change over time:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Install matplotlib and ipywidgets if they are not already installed</span>
<span class="o">%</span><span class="k">pip</span> install matplotlib
<span class="o">%</span><span class="k">pip</span> install ipywidgets

<span class="kn">from</span><span class="w"> </span><span class="nn">MDMC.utilities.plotting</span><span class="w"> </span><span class="kn">import</span> <span class="n">plot_progress</span>
<span class="n">charge_parameter</span> <span class="o">=</span> <span class="n">fit_parameters</span><span class="p">[</span><span class="s1">&#39;charge&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>
<span class="n">control</span> <span class="o">=</span> <span class="n">plot_progress</span><span class="p">(</span><span class="n">control</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;FoM&#39;</span><span class="p">,</span> <span class="n">charge_parameter</span><span class="p">])</span>
<span class="n">control</span><span class="o">.</span><span class="n">refine</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>If dynamic plotting is used, only the last 5 steps of the text will be shown, so that the plots are always visible. For the same reason, it is recommended that a maximum of 8 plots are displayed at any time.</p>
</section>
<section id="FoM-and-Parameter-Plotting">
<h2>FoM and Parameter Plotting<a class="headerlink" href="#FoM-and-Parameter-Plotting" title="Link to this heading"></a></h2>
<p>After a refinement has completed, the results can be read in and plotted with pandas. Unlike dynamic plotting, this can be done whether or not the refinement has been run within a Jupyter notebook, but it still requires matplotlib to be installed:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">control</span><span class="o">.</span><span class="n">results_filename</span><span class="p">)</span>

<span class="c1"># If only the y variable is provided (e.g. &#39;FoM&#39;), it is plotted against the number of steps)</span>
<span class="n">results</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="s1">&#39;FoM&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># The x axis can also be specified</span>
<span class="n">results</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;FoM&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">charge_parameter</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="equilibrating-a-simulation.html" class="btn btn-neutral float-left" title="Equilibrating simulations" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="understanding-units.html" class="btn btn-neutral float-right" title="Understanding scientific units in MDMC" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>