<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Running a Refinement &mdash; MDMC 0.2 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
        <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Argon A-to-Z" href="Argon-a-to-z.html" />
    <link rel="prev" title="Selecting Fitting Parameters" href="selecting-fitting-parameters.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> MDMC
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Overview</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../pages/introduction.html">1. Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pages/installation.html">2. Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pages/simulations.html">3. Simulations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pages/parameter-refinement.html">4. Parameter Refinement</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pages/contributing.html">5. Contributing to MDMC</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="building-a-universe.html">Building an MDMC Universe</a></li>
<li class="toctree-l1"><a class="reference internal" href="read-configurations.html">Reading atoms from configuration files</a></li>
<li class="toctree-l1"><a class="reference internal" href="units.html">Units in MDMC</a></li>
<li class="toctree-l1"><a class="reference internal" href="applying-a-forcefield.html">Applying a <code class="docutils literal notranslate"><span class="pre">ForceField</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="solvating-a-universe.html">Solvating an MDMC Universe</a></li>
<li class="toctree-l1"><a class="reference internal" href="molecular-visualization.html">Molecular Visualization</a></li>
<li class="toctree-l1"><a class="reference internal" href="running-a-simulation.html">Running a Simulation in MDMC</a></li>
<li class="toctree-l1"><a class="reference internal" href="creating-an-observable.html">Creating an Observable from a Simulation</a></li>
<li class="toctree-l1"><a class="reference internal" href="selecting-fitting-parameters.html">Selecting Fitting Parameters</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Running a Refinement</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#Experimental-datasets">Experimental datasets</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Controlling-the-refinement">Controlling the refinement</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Controlling-the-parameters">Controlling the parameters</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Controlling-the-figure-of-merit">Controlling the figure of merit</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Running-the-refinement">Running the refinement</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#Resolution-Function">Resolution Function</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Refinement-Output">Refinement Output</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Refinement-plotting">Refinement plotting</a></li>
<li class="toctree-l2"><a class="reference internal" href="#FoM-and-Parameter-Plotting">FoM and Parameter Plotting</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Observable-Plotting">Observable Plotting</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="Argon-a-to-z.html">Argon A-to-Z</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../pages/developer/overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pages/developer/coding_standards.html">Coding Standards</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pages/developer/documentation.html">Documentation Standards</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pages/developer/units.html">Units</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pages/developer/testing.html">Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pages/developer/management.html">MDMC Software Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pages/developer/containers.html">Containers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pages/developer/vscode.html">Debugging inside Containers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pages/developer/recipes.html">Recipes for ‘simple’ additions</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Modules</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../pages/modules/common.html">common</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pages/modules/control.html">control</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pages/modules/gui.html">gui</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pages/modules/md.html">MD</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pages/modules/readers.html">readers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pages/modules/refinement.html">refinement</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pages/modules/trajectory_analysis.html">trajectory_analysis</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">MDMC</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Running a Refinement</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/tutorials/running-a-refinement.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt .copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="section" id="Running-a-Refinement">
<h1>Running a Refinement<a class="headerlink" href="#Running-a-Refinement" title="Permalink to this headline"></a></h1>
<p>In order to refine potential parameters the following is required:</p>
<ul class="simple">
<li><p>A <code class="docutils literal notranslate"><span class="pre">Universe</span></code> which contains one or more atoms. (<a class="reference internal" href="building-a-universe.html"><span class="doc">Building a Universe</span></a>)</p></li>
<li><p>A <code class="docutils literal notranslate"><span class="pre">Simulation</span></code> which runs using the <code class="docutils literal notranslate"><span class="pre">Universe</span></code>. (<a class="reference internal" href="running-a-simulation.html"><span class="doc">Running a Simulation</span></a>)</p></li>
<li><p>One or more <code class="docutils literal notranslate"><span class="pre">Parameters</span></code> to refine. (<a class="reference internal" href="selecting-fitting-parameters.html"><span class="doc">Selecting fitting Parameters</span></a>)</p></li>
<li><p>One or more experimental datasets.</p></li>
</ul>
<p>For more information on how to produce the first three of these, please see the tutorials in the brackets.</p>
<div class="section" id="Experimental-datasets">
<h2>Experimental datasets<a class="headerlink" href="#Experimental-datasets" title="Permalink to this headline"></a></h2>
<p>Whether or not an experimental dataset can be refined against depends on:</p>
<ul class="simple">
<li><p>if the relevant experimental <code class="docutils literal notranslate"><span class="pre">Observable</span></code> (e.g. dynamic structure factor, S(Q,w)) has been implemented.</p></li>
<li><p>if a <code class="docutils literal notranslate"><span class="pre">Reader</span></code> for the specific file format of the data has been implemented (e.g. the <code class="docutils literal notranslate"><span class="pre">LAMPSQw</span></code> <code class="docutils literal notranslate"><span class="pre">Reader</span></code>, which reads the LAMP output file format).</p></li>
</ul>
<p>If both of these exist, an experimental experimental dataset can be used. If only the former has been implemented, then it would be necessary to add a subclass of the <code class="docutils literal notranslate"><span class="pre">ObservableReader</span></code> class to use the experimental dataset; more information about how to do is included within the <code class="docutils literal notranslate"><span class="pre">ObservableReader</span></code> documentation.</p>
<p>Each experimental dataset must be specified by a dictionary containing the following:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">file_name</span></code> : A string with the file name of the experimental data</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">type</span></code> : A string specifying the type of <code class="docutils literal notranslate"><span class="pre">Observable</span></code> which describes the data (e.g. SQw if the data is the dynamic structure factor, PDF if the data is the pair distribution function).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">reader</span></code> : A string specifying the name of the <code class="docutils literal notranslate"><span class="pre">ObservableReader</span></code> which will be used to read the file.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">weight</span></code> : A float which determines the relative importance weighting of this dataset to other datasets.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">rescale_factor</span></code>, optional : A float which rescales the experimental data linearly in order to match the absolute scale of the simulated data when calculating the Figure of Merit (FoM). Default is <code class="docutils literal notranslate"><span class="pre">1.</span></code>, i.e. no change to the data.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">auto_scale</span></code>, optional : A boolean specifying whether to automatically set the aforementioned <code class="docutils literal notranslate"><span class="pre">rescale_factor</span></code> at each step of the refinement to the value which minimizes the FoM. Default is <code class="docutils literal notranslate"><span class="pre">False</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">use_FFT</span></code>, optional : A boolean specifying whether to use the Fast Fourier Transform (FFT) in the calculation of variables from MD, which are faster but can impose restrictions on the uniformity of variables. Default is <code class="docutils literal notranslate"><span class="pre">True</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">resolution</span></code> : a one-line dict of format <code class="docutils literal notranslate"><span class="pre">{'file'</span> <span class="pre">:</span> <span class="pre">str}</span></code> or <code class="docutils literal notranslate"><span class="pre">{key</span> <span class="pre">:</span> <span class="pre">float}</span></code>. if <code class="docutils literal notranslate"><span class="pre">{'file'</span> <span class="pre">:</span> <span class="pre">str}</span></code>, the <code class="docutils literal notranslate"><span class="pre">str</span></code> should be a file in the same format as <code class="docutils literal notranslate"><span class="pre">file_name</span></code> containing results of a vanadium sample which is used to determine instrument energy resolution for this dataset. If <code class="docutils literal notranslate"><span class="pre">{key</span> <span class="pre">:</span> <span class="pre">float}</span></code>, the key should be the type of numeric resolution, with the key being the function type (e.g. <code class="docutils literal notranslate"><span class="pre">'gaussian'</span></code> or <code class="docutils literal notranslate"><span class="pre">'lorentzian'</span></code>), and the float the FWHM for that function.</p></li>
</ul>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Dataset from: Johan Qvist et al, J. Chem. Phys. 134, 144508 (2011)</span>
<span class="n">QENS</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;file_name&#39;</span><span class="p">:</span><span class="s1">&#39;data/263K05Awat_LAMP&#39;</span><span class="p">,</span>
        <span class="s1">&#39;type&#39;</span><span class="p">:</span><span class="s1">&#39;SQw&#39;</span><span class="p">,</span>
        <span class="s1">&#39;reader&#39;</span><span class="p">:</span><span class="s1">&#39;LAMPSQw&#39;</span><span class="p">,</span>
        <span class="s1">&#39;weight&#39;</span><span class="p">:</span><span class="mf">1.</span><span class="p">,</span>
        <span class="s1">&#39;auto_scale&#39;</span><span class="p">:</span><span class="kc">True</span><span class="p">,</span>
        <span class="s1">&#39;use_FFT&#39;</span><span class="p">:</span><span class="kc">False</span><span class="p">,</span>
        <span class="s1">&#39;resolution&#39;</span><span class="p">:{</span><span class="s1">&#39;file&#39;</span><span class="p">:</span> <span class="s1">&#39;data/262p7K0A5van_LAMP&#39;</span><span class="p">}}</span>
</pre></div>
</div>
</div>
<p>As the dataset we are using has both negative energy values and non-uniform spacing, the default behaviour of <code class="docutils literal notranslate"><span class="pre">use_FFT=True</span></code> would cause the data to be interpolated as part of the refinement process. Setting this to <code class="docutils literal notranslate"><span class="pre">False</span></code> allows us to preserve the original energy values.</p>
<p>The default behaviour of the scaling (<code class="docutils literal notranslate"><span class="pre">rescale_factor=1.</span></code>, <code class="docutils literal notranslate"><span class="pre">auto_scale=False</span></code>) assumes that the dataset provided has been properly scaled and normalised for the refinement process. This is the preferred way of using MDMC, and arbitrary or automatic rescaling should be undertaken with care. For example, using <code class="docutils literal notranslate"><span class="pre">auto_scale</span></code> to determine the scaling does not take into account any physical aspects of scaling the data, such as the presence or absence of background events from peaks outside its
range.</p>
<p>The specific manner in which the <code class="docutils literal notranslate"><span class="pre">weight</span></code> applies to calculating the FoM depends on the particular FoM which is used for the refinement. By default this is a least-squares difference weighted by the experimental error (<code class="docutils literal notranslate"><span class="pre">StandardFoMCalculator</span></code>):</p>
<p><span class="math notranslate nohighlight">\(FoM_{total} = \sum_{i} FoM_{i}\)</span></p>
<p>where the sum is over the number of experimental datasets and we calculate a weighted FoM for the <span class="math notranslate nohighlight">\(i\)</span>-th dataset as follows:</p>
<p><span class="math notranslate nohighlight">\(FoM_{i} = w_{i} \sum_{j} \left( \frac{D_{j}^{exp} - D_{j}^{sim}}{\sigma_{j}^{exp}} \right)^2\)</span></p>
<p><span class="math notranslate nohighlight">\(D_{j}\)</span> is an observable, <span class="math notranslate nohighlight">\(\sigma_{j}\)</span> is the error associated with the observable, and <span class="math notranslate nohighlight">\(exp\)</span> and <span class="math notranslate nohighlight">\(sim\)</span> refer to the experimental and simulated data respectively. <span class="math notranslate nohighlight">\(D_{j}\)</span> and <span class="math notranslate nohighlight">\(\sigma_{j}\)</span> are N-dimensional arrays of all the data points for a dataset.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">exp_datasets</span></code> parameter which is passed to <code class="docutils literal notranslate"><span class="pre">Control</span></code> is a list of all dataset dictionaries. In this instance there is only a single experimental dataset:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">exp_datasets</span> <span class="o">=</span> <span class="p">[</span><span class="n">QENS</span><span class="p">]</span>
</pre></div>
</div>
</div>
<p>If another dataset were to be included, for example the pair distribution function, this would require its own dictionary:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n_diffraction</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;file_name&#39;</span><span class="p">:</span><span class="s1">&#39;data/water_PDF&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;type&#39;</span><span class="p">:</span><span class="s1">&#39;PDF&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;reader&#39;</span><span class="p">:</span><span class="s1">&#39;ASCII&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;weight&#39;</span><span class="p">:</span><span class="mf">1.</span><span class="p">,</span>
                 <span class="s1">&#39;auto_scale&#39;</span><span class="p">:</span><span class="kc">True</span><span class="p">,</span>
                 <span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;gaussian&#39;</span><span class="p">:</span> <span class="mi">84</span><span class="p">}}</span>
<span class="n">two_exp_datasets</span> <span class="o">=</span> <span class="p">[</span><span class="n">QENS</span><span class="p">,</span> <span class="n">n_diffraction</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Controlling-the-refinement">
<h2>Controlling the refinement<a class="headerlink" href="#Controlling-the-refinement" title="Permalink to this headline"></a></h2>
<p>Continuing from the <a class="reference internal" href="running-a-simulation.html"><span class="doc">Running a Simulation</span></a> tutorial, using a <code class="docutils literal notranslate"><span class="pre">Universe</span></code> filled with SPCE water molecules. As this minimizes and equilibrates a small simulation, it may take ~90s to execute.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">%%capture</span></code> and <code class="docutils literal notranslate"><span class="pre">%run</span></code> commands below simply executes the <a class="reference internal" href="running-a-simulation.html"><span class="doc">Running a Simulation</span></a> notebook and captures the variables into this notebook. They are only valid if they are executed in the same folder as the <a class="reference internal" href="running-a-simulation.html"><span class="doc">Running a Simulation</span></a> notebook. Otherwise, please start from the <a class="reference internal" href="running-a-simulation.html"><span class="doc">Running a Simulation</span></a> to set the same state.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%capture</span>
<span class="c1"># Run Running a Simulation notebook and hide output</span>
<span class="o">%</span><span class="n">run</span> <span class="s2">&quot;running-a-simulation.ipynb&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="Controlling-the-parameters">
<h3>Controlling the parameters<a class="headerlink" href="#Controlling-the-parameters" title="Permalink to this headline"></a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">Parameter</span></code>s of the <code class="docutils literal notranslate"><span class="pre">Universe</span></code> can have various restrictions placed on them for the purposes of refinement.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">universe</span> <span class="o">=</span> <span class="n">simulation</span><span class="o">.</span><span class="n">universe</span>
<span class="n">fit_parameters</span> <span class="o">=</span> <span class="n">universe</span><span class="o">.</span><span class="n">parameters</span>
<span class="n">fit_parameters</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">p</span> <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">fit_parameters</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>The value of one <code class="docutils literal notranslate"><span class="pre">Parameter</span></code> can be <code class="docutils literal notranslate"><span class="pre">tied</span></code> to that of another if there is some physical reason why it should be dependent on it. For example, in a water molecule setting the charge of the oxygen to be -2 times that of the hydrogen:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fit_parameters</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_tie</span><span class="p">(</span><span class="n">fit_parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39; * - 2&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">fit_parameters</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
</div>
<p>The value of a <code class="docutils literal notranslate"><span class="pre">Parameter</span></code> can have <code class="docutils literal notranslate"><span class="pre">constraints</span></code> set to limit it’s value to a certain range:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fit_parameters</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">constraints</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">fit_parameters</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
</pre></div>
</div>
</div>
<p>Finally, a <code class="docutils literal notranslate"><span class="pre">Parameter</span></code> can be <code class="docutils literal notranslate"><span class="pre">fixed</span></code> outright to whatever value it currently has.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fit_parameters</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">.</span><span class="n">fixed</span> <span class="o">=</span> <span class="kc">True</span>
<span class="nb">print</span><span class="p">(</span><span class="n">fit_parameters</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span>
</pre></div>
</div>
</div>
<p>Note that <code class="docutils literal notranslate"><span class="pre">Parameter</span></code>s that are <code class="docutils literal notranslate"><span class="pre">fixed</span></code>, <code class="docutils literal notranslate"><span class="pre">tied</span></code>, or equal to 0 cannot be refined and so will not be passed to the <code class="docutils literal notranslate"><span class="pre">Minimizer</span></code> when the <code class="docutils literal notranslate"><span class="pre">Control</span></code> object is created. If <code class="docutils literal notranslate"><span class="pre">constraints</span></code> are set then refinement will occur however any proposed values that happen to lie outside the range of the <code class="docutils literal notranslate"><span class="pre">constraints</span></code> will be clipped.</p>
<p>Restricting the value of a <code class="docutils literal notranslate"><span class="pre">Parameter</span></code> in these ways applies to the Monte Carlo aspect of MDMC. Namely, it affects how the <code class="docutils literal notranslate"><span class="pre">Parameter</span></code> is allowed to change between refinement steps. It should not be confused with the use of <code class="docutils literal notranslate"><span class="pre">constraint_algorithm</span></code>s when creating a <code class="docutils literal notranslate"><span class="pre">Universe</span></code> (see <a class="reference internal" href="building-a-universe.html"><span class="doc">Building a Universe</span></a>). The latter controls whether or not aspects of the <code class="docutils literal notranslate"><span class="pre">Universe</span></code> such as bonds are treated as rigid or not during molecular dynamics. It is entirely possible
to have a rigid bond but allow the length of that bond to change between refinement steps, or conversely have a bond that is free to oscillate during MD but the equilibrium length is not altered as part of the refinement.</p>
</div>
<div class="section" id="Controlling-the-figure-of-merit">
<h3>Controlling the figure of merit<a class="headerlink" href="#Controlling-the-figure-of-merit" title="Permalink to this headline"></a></h3>
<p>The figure of merit (FoM) used in the refinement process to assess the goodness of fit between MD and experimental data can be configured using a dictionary with the following key/value pairs: - <code class="docutils literal notranslate"><span class="pre">error</span></code> : <code class="docutils literal notranslate"><span class="pre">{'exp',</span> <span class="pre">'none'}</span></code> Whether to weight the FoM using the experimental errors of the data or not (respectively). The former results in values with larger (relative) error contributing less to the overall FoM. - <code class="docutils literal notranslate"><span class="pre">norm</span></code> : <code class="docutils literal notranslate"><span class="pre">{'data_points',</span> <span class="pre">'dof',</span> <span class="pre">'none'}</span></code> Whether to normalise the FoM using the
total number of data points, the degrees of freedom (number of data points less the number of varying parameters), or not at all.</p>
<p>If not provided then the FoM defaults to using the first options, namely:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">FoM_options</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span><span class="s1">&#39;exp&#39;</span><span class="p">,</span> <span class="s1">&#39;norm&#39;</span><span class="p">:</span><span class="s1">&#39;data_points&#39;</span><span class="p">}</span>
</pre></div>
</div>
</div>
<p>Currently, the only option for the overall form of the FoM is that of a Chi-square. Details of the implementation can be obtained by using <code class="docutils literal notranslate"><span class="pre">help</span></code>, for example:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">MDMC.refinement.FoM</span> <span class="kn">import</span> <span class="n">ChiSquaredExpError</span>
<span class="n">help</span><span class="p">(</span><span class="n">ChiSquaredExpError</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Running-the-refinement">
<h3>Running the refinement<a class="headerlink" href="#Running-the-refinement" title="Permalink to this headline"></a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">Control</span></code> object sets up and runs the refinement (using <code class="docutils literal notranslate"><span class="pre">Control.refine</span></code>). It uses the experimental datasets to refine the fitting <code class="docutils literal notranslate"><span class="pre">Parameters</span></code> for the specified <code class="docutils literal notranslate"><span class="pre">Simulation</span></code>:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Assuming a Universe called universe and a Simulation called simulation have been created</span>
<span class="kn">from</span> <span class="nn">MDMC.control</span> <span class="kn">import</span> <span class="n">Control</span>

<span class="n">control</span> <span class="o">=</span> <span class="n">Control</span><span class="p">(</span><span class="n">simulation</span><span class="o">=</span><span class="n">simulation</span><span class="p">,</span>
                  <span class="n">exp_datasets</span><span class="o">=</span><span class="n">exp_datasets</span><span class="p">,</span>
                  <span class="n">fit_parameters</span><span class="o">=</span><span class="n">fit_parameters</span><span class="p">,</span>
                  <span class="n">MC_norm</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                  <span class="n">minimizer_type</span><span class="o">=</span><span class="s2">&quot;MMC&quot;</span><span class="p">,</span>
                  <span class="n">FoM_options</span> <span class="o">=</span> <span class="n">FoM_options</span><span class="p">,</span>
                  <span class="n">MD_steps</span><span class="o">=</span><span class="mi">424620</span><span class="p">,</span>
                  <span class="n">equilibration_steps</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>To refine the specified <code class="docutils literal notranslate"><span class="pre">fit_parameters</span></code>, pass the number of refinement steps to <code class="docutils literal notranslate"><span class="pre">Control.refine</span></code>.</p>
<p>If 0 steps are passed, an MD simulation is performed, the simulation <code class="docutils literal notranslate"><span class="pre">Observable</span></code> is calculated, and the FoM is calculated, however the <code class="docutils literal notranslate"><span class="pre">fit_parameters</span></code> are not modified. This can be used to determine the agreement between a simulation with the current <code class="docutils literal notranslate"><span class="pre">fit_parameters</span></code> and the experimental data.</p>
<p>During the refinement, in addition to running the MD that is used to calculate <code class="docutils literal notranslate"><span class="pre">Observable</span></code>s, the <code class="docutils literal notranslate"><span class="pre">Universe</span></code> can be equilibrated by providing a number of <code class="docutils literal notranslate"><span class="pre">equilibration_steps</span></code> that will be run in between the refinement steps. In general what constitutes an appropriate amount of equilibration will depend on both the <code class="docutils literal notranslate"><span class="pre">Universe</span></code> and the <code class="docutils literal notranslate"><span class="pre">Parameters</span></code> being varied. However, provided the changes caused by the refinement process are small, less equilibration should be needed between steps
than would be when first creating the <code class="docutils literal notranslate"><span class="pre">Simulation</span></code> object. <code class="docutils literal notranslate"><span class="pre">equilibration_steps</span></code> is an optional argument, with a default value of 0 (no equilibration).</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># So that the MD simulation size can be minimized, the Q min is increased and</span>
<span class="c1"># the Q resolution is reduced.</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="n">exp_obs</span> <span class="o">=</span> <span class="n">control</span><span class="o">.</span><span class="n">observable_pairs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">exp_obs</span>
<span class="n">Q_slice</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">exp_obs</span><span class="o">.</span><span class="n">Q</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">Q</span> <span class="o">=</span> <span class="n">exp_obs</span><span class="o">.</span><span class="n">Q</span><span class="p">[</span><span class="n">Q_slice</span><span class="p">]</span>
<span class="n">E</span> <span class="o">=</span> <span class="n">exp_obs</span><span class="o">.</span><span class="n">E</span>
<span class="c1"># copy the updated Q values back to the control.observable</span>
<span class="n">control</span><span class="o">.</span><span class="n">observable_pairs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">exp_obs</span><span class="o">.</span><span class="n">independent_variables</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;E&#39;</span><span class="p">:</span><span class="n">E</span><span class="p">,</span> <span class="s1">&#39;Q&#39;</span><span class="p">:</span><span class="n">Q</span><span class="p">}</span>
<span class="n">control</span><span class="o">.</span><span class="n">observable_pairs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">MD_obs</span><span class="o">.</span><span class="n">independent_variables</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;E&#39;</span><span class="p">:</span><span class="n">E</span><span class="p">,</span> <span class="s1">&#39;Q&#39;</span><span class="p">:</span><span class="n">Q</span><span class="p">}</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="Resolution-Function">
<h2>Resolution Function<a class="headerlink" href="#Resolution-Function" title="Permalink to this headline"></a></h2>
<p>As the dataset included a vanadium sample, this will be used to determine the instrument resolution as a function of momentum. This function is then used in calculations involving that corresponding dataset. Note for numerically defined reoslutions, the resolution function is not accessible as an array. The resolution function can be accessed from the <code class="docutils literal notranslate"><span class="pre">Observable</span></code> (note that it is transformed into the time domain to enable it to be applied multiplicatively to <code class="docutils literal notranslate"><span class="pre">FQt</span></code> rather than convolving
with <code class="docutils literal notranslate"><span class="pre">SQw</span></code>):</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">exp_obs</span> <span class="o">=</span> <span class="n">control</span><span class="o">.</span><span class="n">observable_pairs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">exp_obs</span>
<span class="n">resolution_function</span> <span class="o">=</span> <span class="n">exp_obs</span><span class="o">.</span><span class="n">resolution_functions</span><span class="p">[</span><span class="s1">&#39;SQw&#39;</span><span class="p">]</span>
<span class="c1"># Note that for multidimensional resolution functions, the innermost independent variable should be passed first</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1e5</span><span class="p">)</span>
<span class="n">resolution_array</span> <span class="o">=</span> <span class="n">resolution_function</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">Q</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>The real and imaginary components of this can then be plotted as a 3D surface (note that for a Gaussian lineshape in the energy domain, one would expect no imaginary components and another Gaussian shape in the time domain):</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">matplotlib</span> notebook

<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">cm</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">mpl_toolkits.mplot3d</span> <span class="kn">import</span> <span class="n">Axes3D</span>

<span class="k">def</span> <span class="nf">plot_SQw</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span> <span class="n">SQw</span><span class="p">):</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">gca</span><span class="p">(</span><span class="n">projection</span><span class="o">=</span><span class="s1">&#39;3d&#39;</span><span class="p">)</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">E</span><span class="p">,</span> <span class="n">Q</span><span class="p">)</span>
    <span class="n">surf</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot_surface</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">SQw</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">viridis</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_SQw</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">resolution_array</span><span class="p">))</span>
<span class="n">plot_SQw</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="n">resolution_array</span><span class="p">))</span>
</pre></div>
</div>
</div>
<p>Note that for values outside the original range of the vanadium sample, nearest neighbour extrapolation is used.</p>
<p>When applied to calculated data the resolution window is normalised to have a value of 1 at time zero for all momentum. As the zero time component is directly proportional to the integral in the energy domain, this is equivalent to enforcing the static structure factor of vanadium is constant for all momentum.</p>
<p>Once normalised in this way, this can be compared to the resolution from assuming a Gaussian lineshape with a FWHM of 84 ueV at a specific Q value:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">MDMC.common.constants</span> <span class="kn">import</span> <span class="n">h</span>
<span class="n">sigma_e</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span> <span class="o">*</span> <span class="mf">0.084</span>
<span class="c1"># h is in units of eV s whereas system units are meV fs, so apply a factor of 1e3 * 1e15 to convert it</span>
<span class="n">sigma_t</span> <span class="o">=</span> <span class="n">h</span> <span class="o">*</span> <span class="mf">1e18</span> <span class="o">/</span> <span class="n">sigma_e</span>
<span class="n">control</span><span class="o">.</span><span class="n">observable_pairs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">exp_obs</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="n">t</span>
<span class="n">time_resolution</span> <span class="o">=</span> <span class="n">exp_obs</span><span class="o">.</span><span class="n">_calculate_resolution_window</span><span class="p">(</span><span class="n">resolution_function</span><span class="p">)</span>
<span class="n">Q_index</span> <span class="o">=</span> <span class="mi">10</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">time_resolution</span><span class="p">)[</span><span class="n">Q_index</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Vanadium Resolution&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">t</span> <span class="o">/</span> <span class="n">sigma_t</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Gaussian Resolution&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Refinement-Output">
<h2>Refinement Output<a class="headerlink" href="#Refinement-Output" title="Permalink to this headline"></a></h2>
<p>As a refinement is running, it will print information from each step to the terminal (<code class="docutils literal notranslate"><span class="pre">stdout</span></code>). The specific information depends on which minimizer is selected, however it will always include the current Figure of Merit and the values of the refined parameters. This information will also be saved to the comma separated variable file, results.csv. <strong>It is important to note that this will overwrite any results.csv which exists in the directory</strong>.</p>
<p>Upon the completion of the refinement, the final parameter values will be output to the terminal. If <code class="docutils literal notranslate"><span class="pre">auto_scale</span></code> is set for any of the datasets, then the relevant scale factor(s) will also be printed. For stochastic minimization algorithms, such as MMC (Metropolis Monte Carlo), these values may not be the parameter values which resulted in the minimum Figure of Merit; however it is highly probable that these values will produce a Figure of Merit which is not significantly larger than the
minimum achieved.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">control</span><span class="o">.</span><span class="n">refine</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Refinement-plotting">
<h2>Refinement plotting<a class="headerlink" href="#Refinement-plotting" title="Permalink to this headline"></a></h2>
<p>If MDMC is being run in a Jupyter notebook, and matplotlib and ipywidgets are installed, it is also possible to dynamically plot one or more variables while the refinement is running. For example, it might be desirable to see how the FoM and one or more potential parameters change over time:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Install matplotlib and ipywidgets if they are not already installed</span>
<span class="o">!</span>pip install matplotlib
<span class="o">!</span>pip install ipywidgets

<span class="kn">from</span> <span class="nn">MDMC.utilities</span> <span class="kn">import</span> <span class="n">plot_progress</span>
<span class="n">contol</span> <span class="o">=</span> <span class="n">plot_progress</span><span class="p">(</span><span class="n">control</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;FoM&#39;</span><span class="p">,</span> <span class="s1">&#39;charge&#39;</span><span class="p">])</span>
<span class="n">control</span><span class="o">.</span><span class="n">refine</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>If dynamic plotting is used, only the last 5 steps of the text will be shown, so that the plots are always visible. For the same reason, it is recommended that a maximum of 8 plots are displayed at any time.</p>
</div>
<div class="section" id="FoM-and-Parameter-Plotting">
<h2>FoM and Parameter Plotting<a class="headerlink" href="#FoM-and-Parameter-Plotting" title="Permalink to this headline"></a></h2>
<p>After a refinement has completed, the results can be read in and plotted with pandas. Unlike dynamic plotting, this can be done whether or not the refinement has been run within a Jupyter notebook, but it still requires matplotlib to be installed:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;results.csv&#39;</span><span class="p">)</span>

<span class="c1"># If only the y variable is provided (e.g. &#39;FoM&#39;), it is plotted against the number of steps)</span>
<span class="n">results</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="s1">&#39;FoM&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># The x axis can also be specified</span>
<span class="n">results</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;FoM&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;charge&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Observable-Plotting">
<h2>Observable Plotting<a class="headerlink" href="#Observable-Plotting" title="Permalink to this headline"></a></h2>
<p>Plotting software can be used to visualize the experimental and simulation <code class="docutils literal notranslate"><span class="pre">Observable</span></code> objects. Here <code class="docutils literal notranslate"><span class="pre">matplotlib</span></code> is used to define a function for plotting the dynamic structure factor, <code class="docutils literal notranslate"><span class="pre">SQw</span></code>.</p>
<p>Each comparable experimental and simulation <code class="docutils literal notranslate"><span class="pre">Observable</span></code> will be part of an <code class="docutils literal notranslate"><span class="pre">ObservablePair</span></code>. These will have the same order as the <code class="docutils literal notranslate"><span class="pre">exp_datasets</span></code> that were passed to <code class="docutils literal notranslate"><span class="pre">Control</span></code>. So the QENS experimental data will be part of the first (zero index) <code class="docutils literal notranslate"><span class="pre">ObservablePair</span></code>:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">obs_pairs</span> <span class="o">=</span> <span class="n">control</span><span class="o">.</span><span class="n">observable_pairs</span>
<span class="n">QENS_pair</span> <span class="o">=</span> <span class="n">obs_pairs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<p>Each <code class="docutils literal notranslate"><span class="pre">ObservablePair</span></code> must have an <code class="docutils literal notranslate"><span class="pre">Observable</span></code> from experimental data (<code class="docutils literal notranslate"><span class="pre">ObservablePair.exp_obs</span></code>) and an <code class="docutils literal notranslate"><span class="pre">Observable</span></code> from simulation (<code class="docutils literal notranslate"><span class="pre">ObservablePair.MD_obs</span></code>). Note that as the <code class="docutils literal notranslate"><span class="pre">rescale_factor</span></code> is only taken into account when calculating the FoM, <code class="docutils literal notranslate"><span class="pre">ObservablePair.exp_obs</span></code> will not be scaled. In order to ensure the scales match, <code class="docutils literal notranslate"><span class="pre">ObservablePair.rescale_factor</span></code> can be accessed directly. In the case of the QENS <code class="docutils literal notranslate"><span class="pre">ObservablePair</span></code> (and other 2-D data), these can be plotted using the
<code class="docutils literal notranslate"><span class="pre">plot_SQw</span></code> function defined above.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">E</span> <span class="o">=</span> <span class="n">QENS_pair</span><span class="o">.</span><span class="n">exp_obs</span><span class="o">.</span><span class="n">E</span>
<span class="n">Q</span> <span class="o">=</span> <span class="n">QENS_pair</span><span class="o">.</span><span class="n">exp_obs</span><span class="o">.</span><span class="n">Q</span>

<span class="c1"># Plot the experimental SQw</span>
<span class="n">plot_SQw</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span> <span class="n">QENS_pair</span><span class="o">.</span><span class="n">exp_obs</span><span class="o">.</span><span class="n">SQw</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot the simulation SQw</span>
<span class="n">plot_SQw</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span> <span class="n">QENS_pair</span><span class="o">.</span><span class="n">MD_obs</span><span class="o">.</span><span class="n">SQw</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot the experimental SQw with rescaling</span>
<span class="n">plot_SQw</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span> <span class="n">QENS_pair</span><span class="o">.</span><span class="n">MD_obs</span><span class="o">.</span><span class="n">SQw</span> <span class="o">*</span> <span class="n">QENS_pair</span><span class="o">.</span><span class="n">rescale_factor</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="selecting-fitting-parameters.html" class="btn btn-neutral float-left" title="Selecting Fitting Parameters" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="Argon-a-to-z.html" class="btn btn-neutral float-right" title="Argon A-to-Z" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>