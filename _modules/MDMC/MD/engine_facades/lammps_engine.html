<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MDMC.MD.engine_facades.lammps_engine &mdash; MDMC 0.2 documentation</title>
      <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/underscore.js"></script>
        <script src="../../../../_static/doctools.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../../index.html" class="icon icon-home"> MDMC
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Overview</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../pages/introduction.html">1. Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../pages/installation.html">2. Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../pages/simulations.html">3. Simulations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../pages/parameter-refinement.html">4. Parameter Refinement</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../pages/contributing.html">5. Contributing to MDMC</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorials/building-a-universe.html">Building an MDMC Universe</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorials/read-configurations.html">Reading atoms from configuration files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorials/units.html">Units in MDMC</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorials/applying-a-forcefield.html">Applying a <code class="docutils literal notranslate"><span class="pre">ForceField</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorials/solvating-a-universe.html">Solvating an MDMC Universe</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorials/molecular-visualization.html">Molecular Visualization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorials/running-a-simulation.html">Running a Simulation in MDMC</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorials/creating-an-observable.html">Creating an Observable from a Simulation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorials/selecting-fitting-parameters.html">Selecting Fitting Parameters</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorials/running-a-refinement.html">Running a Refinement</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorials/Argon-a-to-z.html">Argon A-to-Z</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../pages/developer/overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../pages/developer/coding_standards.html">Coding Standards</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../pages/developer/documentation.html">Documentation Standards</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../pages/developer/units.html">Units</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../pages/developer/testing.html">Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../pages/developer/management.html">MDMC Software Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../pages/developer/containers.html">Containers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../pages/developer/vscode.html">Debugging inside Containers</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Modules</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../pages/modules/common.html">common</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../pages/modules/control.html">control</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../pages/modules/gui.html">gui</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../pages/modules/md.html">MD</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../pages/modules/readers.html">readers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../pages/modules/refinement.html">refinement</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../pages/modules/trajectory_analysis.html">trajectory_analysis</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">MDMC</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../../index.html">Module code</a> &raquo;</li>
      <li>MDMC.MD.engine_facades.lammps_engine</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for MDMC.MD.engine_facades.lammps_engine</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Facade for LAMMPS MD engine</span>

<span class="sd">This is a facade to ``PyLammps`` (added in 30th-Jul-2016 version), a convenience</span>
<span class="sd">wrapper for the LAMMPS Python interface i.e. where Python is extended with</span>
<span class="sd">LAMMPS.</span>

<span class="sd">Defining all interaction types requires that LAMMPS was built with the MOLECULE</span>
<span class="sd">package.</span>

<span class="sd">Notes</span>
<span class="sd">-----</span>
<span class="sd">When variables are either passed to or from ``PyLammps``, the ctypes conversion</span>
<span class="sd">can mean that they are unnecessarily cast, particularly from `float` to `int`.</span>
<span class="sd">This can cause issues as LAMMPS requires certain variables, e.g. number of</span>
<span class="sd">steps, to be `int`.  Therefore it is always a good idea to be cast these</span>
<span class="sd">variables when they are read from ``PyLammps`` e.g.</span>
<span class="sd">``int(lmp.variables[&#39;steps&#39;].value)``.</span>

<span class="sd">A minor bug in LAMMPS (Dec 2018 version) means that ``nangletypes`` returned</span>
<span class="sd">by ``PyLammps`` is incorrectly set to ``ndihedraltypes``.  This was corrected in</span>
<span class="sd">Mar 2020 release.</span>

<span class="sd">The PyLammps class (which is what MDMC interfaces to) only outputs on the rank 0</span>
<span class="sd">process when using MPI. This means that accessing PyLammps properties should</span>
<span class="sd">only be done on rank 0, and broadcast to other ranks if necessary. This is also</span>
<span class="sd">true of calls to PyLammps.eval, and may also occur in other cases (anything that</span>
<span class="sd">ends up using the OutputCapture class).</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span><span class="p">,</span> <span class="n">namedtuple</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">copy</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">chain</span><span class="p">,</span> <span class="n">combinations</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">product</span><span class="p">,</span> <span class="n">tee</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">randint</span>
<span class="kn">from</span> <span class="nn">tempfile</span> <span class="kn">import</span> <span class="n">NamedTemporaryFile</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">lammps</span> <span class="kn">import</span> <span class="n">PyLammps</span>
<span class="k">except</span> <span class="ne">ModuleNotFoundError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ModuleNotFoundError</span><span class="p">(</span><span class="s1">&#39;The Python interface for LAMMPS (lammps.py) is&#39;</span>
                              <span class="s1">&#39; not in the PYTHONPATH. See LAMMPS documentation&#39;</span>
                              <span class="s1">&#39; on Python to rectify this.&#39;</span>
                              <span class="p">)</span><span class="o">.</span><span class="n">with_traceback</span><span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="n">__traceback__</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">mpi4py</span> <span class="kn">import</span> <span class="n">MPI</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">MDMC.common</span> <span class="kn">import</span> <span class="n">units</span>
<span class="kn">from</span> <span class="nn">MDMC.common.decorators</span> <span class="kn">import</span> <span class="n">unit_decorator</span><span class="p">,</span> <span class="n">unit_decorator_getter</span><span class="p">,</span> \
    <span class="n">repr_decorator</span>
<span class="kn">from</span> <span class="nn">MDMC.MD.engine_facades.facade</span> <span class="kn">import</span> <span class="n">MDEngine</span>
<span class="kn">from</span> <span class="nn">MDMC.MD.structural_units</span> <span class="kn">import</span> <span class="n">Atom</span>
<span class="kn">from</span> <span class="nn">MDMC.MD.interactions</span> <span class="kn">import</span> <span class="n">BondedInteraction</span>
<span class="kn">from</span> <span class="nn">MDMC.trajectory_analysis.trajectory</span> <span class="kn">import</span> <span class="n">TemporalConfiguration</span><span class="p">,</span> \
    <span class="n">Trajectory</span>


<span class="n">LOGGER</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="PyLammpsAttribute"><a class="viewcode-back" href="../../../../pages/modules/md/engine_facades/lammps_engine.html#MDMC.MD.engine_facades.lammps_engine.PyLammpsAttribute">[docs]</a><span class="k">class</span> <span class="nc">PyLammpsAttribute</span><span class="p">:</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class which has a ``PyLammps`` object as an attribute</span>

<span class="sd">    It possesses attributes and methods relating to the ``PyLammps`` object</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    lmp : PyLammps, optional</span>
<span class="sd">        Set the ``lmp`` attribute to a ``PyLammps`` object. Default is `None`,</span>
<span class="sd">        which results in a new ``PyLammps`` object being initialised.</span>
<span class="sd">    atom_style : str, optional</span>
<span class="sd">        The LAMMPS ``atom_style``, which determines the properties that can be</span>
<span class="sd">        associated which the atoms (e.g. ``charge``, ``bonds``). Default is</span>
<span class="sd">        ``full``.</span>

<span class="sd">    Attributes</span>
<span class="sd">    -----------</span>
<span class="sd">    lmp : PyLammps</span>
<span class="sd">        The ``PyLammps`` object owned by this class</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lmp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">atom_style</span><span class="o">=</span><span class="s1">&#39;full&#39;</span><span class="p">):</span>

        <span class="c1"># Set communicator to MPI predefined intracommunicator instance which</span>
        <span class="c1"># contains all processes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">comm</span> <span class="o">=</span> <span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span>

        <span class="k">if</span> <span class="n">lmp</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lmp</span> <span class="o">=</span> <span class="n">lmp</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Pass communicator to PyLammps to ensure consistency with process</span>
            <span class="c1"># ranks</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lmp</span> <span class="o">=</span> <span class="n">PyLammps</span><span class="p">(</span><span class="n">comm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lmp</span><span class="o">.</span><span class="n">units</span><span class="p">(</span><span class="s1">&#39;real&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lmp</span><span class="o">.</span><span class="n">atom_style</span><span class="p">(</span><span class="n">atom_style</span><span class="p">)</span>

        <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">: {lmp: </span><span class="si">%s</span><span class="s1">, communicator: </span><span class="si">%s</span><span class="s1">, atom_style: </span><span class="si">%s</span><span class="s1">}. PyLammps&#39;</span>
                     <span class="s1">&#39; instance </span><span class="si">%s</span><span class="s1">.&#39;</span><span class="p">,</span>
                     <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">lmp</span><span class="p">,</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="p">,</span>
                     <span class="n">atom_style</span><span class="p">,</span>
                     <span class="s1">&#39;added to class&#39;</span> <span class="k">if</span> <span class="n">lmp</span> <span class="k">else</span> <span class="s1">&#39;created by class&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">system_state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the ``PyLammps`` wrapper system ``state`` `dict`</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ``System``</span>
<span class="sd">                Contains the properties of the simulation box.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># PyLammps.system only exists on rank 0 process, so bcast. Conversion</span>
        <span class="c1"># from System class (which is a namedtuple) to ordered dict required as</span>
        <span class="c1"># System cannot be pickled</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">system_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmp</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">_asdict</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">system_state</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">system_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">bcast</span><span class="p">(</span><span class="n">system_state</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1"># Cast back to namedtuple to remain consist with LAMMPS system attribute</span>
        <span class="k">return</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;System&#39;</span><span class="p">,</span> <span class="n">system_state</span><span class="o">.</span><span class="n">keys</span><span class="p">())(</span><span class="o">*</span><span class="n">system_state</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">fixes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the ``PyLammps`` wrapper `list` of ``fixes``</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        `list` of `dict`</span>
<span class="sd">            Each `dict` states the ``group``, ``name`` and ``style`` of a LAMMPS</span>
<span class="sd">            ``fix` which is applied</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># PyLammps.fixes only exists on rank 0 process, so bcast</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">fixes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmp</span><span class="o">.</span><span class="n">fixes</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fixes</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">bcast</span><span class="p">(</span><span class="n">fixes</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">fix_styles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the styles of the ``fixes`` applied in LAMMPS</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        `list` of `str`</span>
<span class="sd">            The styles of the ``fixes``</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">fix</span><span class="p">[</span><span class="s1">&#39;style&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">fix</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fixes</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">fix_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the names of the ``fixes`` applied in LAMMPS</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        `list` of `str`</span>
<span class="sd">            The names of the ``fixes``</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">fix</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">fix</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fixes</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dumps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the PyLammps wrapper list of dumps</span>

<span class="sd">        Dumps are LAMMPS commands which write atom quantities to file for</span>
<span class="sd">        specified timesteps</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># PyLammps.dumps only exists on rank 0 process, so bcast.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">dumps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmp</span><span class="o">.</span><span class="n">dumps</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dumps</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">bcast</span><span class="p">(</span><span class="n">dumps</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></div>


<div class="viewcode-block" id="LAMMPSEngine"><a class="viewcode-back" href="../../../../pages/modules/md/engine_facades/lammps_engine.html#MDMC.MD.engine_facades.lammps_engine.LAMMPSEngine">[docs]</a><span class="nd">@repr_decorator</span><span class="p">(</span><span class="s1">&#39;lmp&#39;</span><span class="p">,</span> <span class="s1">&#39;lmp_universe&#39;</span><span class="p">,</span> <span class="s1">&#39;lmp_simulation&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">LAMMPSEngine</span><span class="p">(</span><span class="n">PyLammpsAttribute</span><span class="p">,</span> <span class="n">MDEngine</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Facade for LAMMPS</span>

<span class="sd">    One notable issue with creating the LAMMPS facade is that some</span>
<span class="sd">    ``pair_styles`` are combinations of both dispersion and coulombic</span>
<span class="sd">    interactions. For example, although LAMMPS has ``lj/cut``, ``coul/cut``, and</span>
<span class="sd">    ``coul/long``, there is no ``lj/long`` pair_style; it only exists in</span>
<span class="sd">    combination with ``coul/long`` (i.e. ``lj/long/coul/long``). This means that</span>
<span class="sd">    the facade has to not just parse each nonbonded interaction, but also has to</span>
<span class="sd">    determine if that ``pair_style`` should be combined with another</span>
<span class="sd">    ``pair_style`` (e.g. ``lj/long`` and ``coul/long`` have to be combined</span>
<span class="sd">    before passing to ``pair_style`` and ``pair_coeff``). An additional</span>
<span class="sd">    complication of this is that when setting the coefficients (``Parameters``)</span>
<span class="sd">    of these interactions, they again have to be set together. So in theory a</span>
<span class="sd">    coulombic interaction needs to know the dispersion interaction it has been</span>
<span class="sd">    paired with an also pass those coefficients when calling ``pair_coeff``. In</span>
<span class="sd">    practice a simplification can be made, at least in the case of currently</span>
<span class="sd">    implemented pair styles: As coulombic ``pair_styles`` do no take any</span>
<span class="sd">    coefficients, any coulombic ``pair_styles`` that comprise a combined</span>
<span class="sd">    ``pair_style`` can be ignored for the purposes of setting the coulombic</span>
<span class="sd">    ``pair_style``; this can be taken care of when ``pair_coeff`` is called from</span>
<span class="sd">    the correspoding dispersion interaction, as this possesses the dispersion</span>
<span class="sd">    coefficients that also need to be passed when the coefficients of this pair</span>
<span class="sd">    style are set.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">saved_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the saved configuration of the atomic positions</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        numpy.ndarray</span>
<span class="sd">            The configuration from the start of the run. Each row of the</span>
<span class="sd">            ``array`` corresponds to the LAMMPS atom ``ID - 1`` (offset is due</span>
<span class="sd">            to array zero indexing) and the columns of the ``array`` are the</span>
<span class="sd">            ``x``, ``y``, ``z`` components of the ``position``, the ``mass`` and</span>
<span class="sd">            the ``charge`` of each ``Atom``.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_saved_config</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">time_step</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get or set the simulation time step in ``fs``</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        `float`</span>
<span class="sd">            Simulation time step in ``fs``</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmp_simulation</span><span class="o">.</span><span class="n">time_step</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@time_step</span><span class="o">.</span><span class="n">setter</span>
    <span class="nd">@unit_decorator</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">units</span><span class="o">.</span><span class="n">TIME</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">time_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lmp_simulation</span><span class="o">.</span><span class="n">time_step</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">traj_step</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get or set the number of simulation steps between saving the</span>
<span class="sd">        ``Trajectory``</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        `int`</span>
<span class="sd">            Number of simulation steps that elapse between the ``Trajectory``</span>
<span class="sd">            being stored</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmp_simulation</span><span class="o">.</span><span class="n">traj_step</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@traj_step</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">traj_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lmp_simulation</span><span class="o">.</span><span class="n">traj_step</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">temperature</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get or set the temperature of the simulation in ``K``</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        `float`</span>
<span class="sd">            Temperature in ``K``</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmp_simulation</span><span class="o">.</span><span class="n">temperature</span>

    <span class="nd">@temperature</span><span class="o">.</span><span class="n">setter</span>
    <span class="nd">@unit_decorator</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">units</span><span class="o">.</span><span class="n">TEMPERATURE</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">temperature</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lmp_simulation</span><span class="o">.</span><span class="n">temperature</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pressure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get or set the pressure of the simulation in ``atm``</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        `float`</span>
<span class="sd">            Pressure in ``atm``</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmp_simulation</span><span class="o">.</span><span class="n">pressure</span>

    <span class="nd">@pressure</span><span class="o">.</span><span class="n">setter</span>
    <span class="nd">@unit_decorator</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">units</span><span class="o">.</span><span class="n">PRESSURE</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">pressure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lmp_simulation</span><span class="o">.</span><span class="n">pressure</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ensemble</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get or set the ensemble object which applies a ``thermostat`` and/or</span>
<span class="sd">        ``barostat`` to LAMMPS</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Ensemble</span>
<span class="sd">            The simulation thermodynamic ensemble</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmp_simulation</span><span class="o">.</span><span class="n">ensemble</span>

    <span class="nd">@ensemble</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">ensemble</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lmp_simulation</span><span class="o">.</span><span class="n">ensemble</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">thermostat</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get or set the `str` which specifies the thermostat</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        `str`</span>
<span class="sd">            The ``thermostat`` name</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensemble</span><span class="o">.</span><span class="n">thermostat</span>

    <span class="nd">@thermostat</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">thermostat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ensemble</span><span class="o">.</span><span class="n">thermostat</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">barostat</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get or set the `str` which specifies the barostat</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        `str`</span>
<span class="sd">            The ``barostat`` name</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensemble</span><span class="o">.</span><span class="n">barostat</span>

    <span class="nd">@barostat</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">barostat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ensemble</span><span class="o">.</span><span class="n">barostat</span> <span class="o">=</span> <span class="n">value</span>

<div class="viewcode-block" id="LAMMPSEngine.setup_universe"><a class="viewcode-back" href="../../../../pages/modules/md/engine_facades/lammps_engine.html#MDMC.MD.engine_facades.lammps_engine.LAMMPSEngine.setup_universe">[docs]</a>    <span class="k">def</span> <span class="nf">setup_universe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">universe</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates the simulation box, the atomic configuration, and the topology</span>
<span class="sd">        in LAMMPS</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        universe : Universe</span>
<span class="sd">            The MDMC ``Universe`` which will be setup in LAMMPS.</span>
<span class="sd">        **settings</span>
<span class="sd">            ``atom_style`` (`str`)</span>
<span class="sd">                A LAMMPS ``atom_style`` `str`. The default setting of ``real``</span>
<span class="sd">                will generally be appropriate.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">atom_style</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;atom_style&#39;</span><span class="p">,</span> <span class="s1">&#39;full&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">universe</span> <span class="o">=</span> <span class="n">universe</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lmp_universe</span> <span class="o">=</span> <span class="n">LAMMPSUniverse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">universe</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmp</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_saved_config</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="LAMMPSEngine.setup_simulation"><a class="viewcode-back" href="../../../../pages/modules/md/engine_facades/lammps_engine.html#MDMC.MD.engine_facades.lammps_engine.LAMMPSEngine.setup_simulation">[docs]</a>    <span class="k">def</span> <span class="nf">setup_simulation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">traj_step</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">time_step</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets simulation parameters in LAMMPS, such as the thermodynamic</span>
<span class="sd">        variables, thermostat/barostat parameters and trajectory settings</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        traj_step : int</span>
<span class="sd">            How many steps the simulation should take between dumping each</span>
<span class="sd">            ``Trajectory`` frame</span>
<span class="sd">        time_step : float</span>
<span class="sd">            Simulation timestep in ``fs``</span>
<span class="sd">        **settings</span>
<span class="sd">            Passed to ``LAMMPSSimulation``</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lmp_simulation</span> <span class="o">=</span> <span class="n">LAMMPSSimulation</span><span class="p">(</span><span class="n">universe</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">universe</span><span class="p">,</span>
                                               <span class="n">time_step</span><span class="o">=</span><span class="n">time_step</span><span class="p">,</span>
                                               <span class="n">traj_step</span><span class="o">=</span><span class="n">traj_step</span><span class="p">,</span>
                                               <span class="n">lmp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lmp</span><span class="p">,</span>
                                               <span class="o">**</span><span class="n">settings</span><span class="p">)</span></div>

<div class="viewcode-block" id="LAMMPSEngine.minimize"><a class="viewcode-back" href="../../../../pages/modules/md/engine_facades/lammps_engine.html#MDMC.MD.engine_facades.lammps_engine.LAMMPSEngine.minimize">[docs]</a>    <span class="k">def</span> <span class="nf">minimize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_steps</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">):</span>

        <span class="c1"># Check fix styles for shake or rattle styles and remove them</span>
        <span class="k">if</span> <span class="s1">&#39;constrain&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fix_names</span><span class="p">:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> Remove </span><span class="si">%s</span><span class="s1"> constraint from fixes: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
                         <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">universe</span><span class="o">.</span><span class="n">constraint_algorithm</span><span class="p">,</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">fixes</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lmp</span><span class="o">.</span><span class="n">unfix</span><span class="p">(</span><span class="s1">&#39;constrain&#39;</span><span class="p">)</span>

        <span class="n">etol</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;etol&#39;</span><span class="p">,</span> <span class="mf">1.e-4</span><span class="p">)</span>
        <span class="n">ftol</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ftol&#39;</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
        <span class="n">maxeval</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;maxeval&#39;</span><span class="p">,</span> <span class="mi">10000</span><span class="p">)</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> minimize: {n_steps: </span><span class="si">%s</span><span class="s1">, etol: </span><span class="si">%s</span><span class="s1">, ftol: </span><span class="si">%s</span><span class="s1">,&#39;</span>
                    <span class="s1">&#39; maxeval: </span><span class="si">%s</span><span class="s1">}&#39;</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span>
                    <span class="n">n_steps</span><span class="p">,</span>
                    <span class="n">etol</span><span class="p">,</span>
                    <span class="n">ftol</span><span class="p">,</span>
                    <span class="n">maxeval</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lmp</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">etol</span><span class="p">,</span>
                          <span class="n">ftol</span><span class="p">,</span>
                          <span class="n">n_steps</span><span class="p">,</span>
                          <span class="n">maxeval</span><span class="p">)</span>

        <span class="c1"># Reapply the constraints</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">universe</span><span class="o">.</span><span class="n">constraint_algorithm</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ensemble</span><span class="o">.</span><span class="n">remove_ensemble_fixes</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lmp_universe</span><span class="o">.</span><span class="n">apply_constraints</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ensemble</span><span class="o">.</span><span class="n">apply_ensemble_fixes</span><span class="p">()</span></div>


<div class="viewcode-block" id="LAMMPSEngine.run"><a class="viewcode-back" href="../../../../pages/modules/md/engine_facades/lammps_engine.html#MDMC.MD.engine_facades.lammps_engine.LAMMPSEngine.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_steps</span><span class="p">,</span> <span class="n">equilibration</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">equilibration</span><span class="p">:</span>
            <span class="c1"># Remove previous dumps if they exist</span>
            <span class="k">if</span> <span class="s1">&#39;traj1&#39;</span> <span class="ow">in</span> <span class="p">[</span><span class="n">dump</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">dump</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dumps</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lmp</span><span class="o">.</span><span class="n">undump</span><span class="p">(</span><span class="s1">&#39;traj1&#39;</span><span class="p">)</span>
            <span class="c1"># Store the trajectory in a NamedTemporaryFile</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">trajectory_file</span> <span class="o">=</span> <span class="n">NamedTemporaryFile</span><span class="p">()</span>
                <span class="n">f_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trajectory_file</span><span class="o">.</span><span class="n">name</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">f_name</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">f_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">bcast</span><span class="p">(</span><span class="n">f_name</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">rank</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">trajectory_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">f_name</span><span class="p">)</span>
            <span class="c1"># Custom trajectory output just saves the atom ID, type and</span>
            <span class="c1"># positions</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> set trajectory dump output to </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
                         <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">trajectory_file</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lmp</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="s1">&#39;traj1&#39;</span><span class="p">,</span> <span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="s1">&#39;custom&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">traj_step</span><span class="p">,</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">trajectory_file</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span>
                          <span class="s1">&#39;z&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">reset_to_nve</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">thermostat</span> <span class="ow">is</span> <span class="bp">self</span><span class="o">.</span><span class="n">barostat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># If NVE ensemble, add a berendsen thermostat for equilibration</span>
                <span class="n">reset_to_nve</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">thermostat</span> <span class="o">=</span> <span class="s1">&#39;berendsen&#39;</span>

        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> run: {n_steps: </span><span class="si">%s</span><span class="s1">, equilibration: </span><span class="si">%s</span><span class="s1">}&#39;</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span>
                    <span class="n">n_steps</span><span class="p">,</span>
                    <span class="n">equilibration</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lmp</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">n_steps</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">equilibration</span> <span class="ow">and</span> <span class="n">reset_to_nve</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">thermostat</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="LAMMPSEngine.convert_trajectory"><a class="viewcode-back" href="../../../../pages/modules/md/engine_facades/lammps_engine.html#MDMC.MD.engine_facades.lammps_engine.LAMMPSEngine.convert_trajectory">[docs]</a>    <span class="k">def</span> <span class="nf">convert_trajectory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Converts between a LAMMPS trajectory dump and an MDMC ``Trajectory``</span>

<span class="sd">        The LAMMPS dump must include at least ``id``, ``atom_type``, and ``xyz``</span>
<span class="sd">        ``positions``. The ``xyz`` ``positions`` must be consecutive and in that</span>
<span class="sd">        order. The same is true of the ``xyz`` components of the ``velocity``, if</span>
<span class="sd">        they are provided.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        start : int</span>
<span class="sd">            The index of the first trajectory, inclusive.</span>
<span class="sd">        stop : int</span>
<span class="sd">            The index of the last trajectory, exclusive.</span>
<span class="sd">        step : int</span>
<span class="sd">            The step size between trajectories.</span>
<span class="sd">        **settings</span>
<span class="sd">            ``scaled_positions`` (`bool`)</span>
<span class="sd">                If the ``trajectory_file`` has scaled ``positions``</span>
<span class="sd">            ``atom_IDs`` (`list`)</span>
<span class="sd">                LAMMPS ``ID`` of the atoms which should be included. If not passed</span>
<span class="sd">                then all atoms are included in the converted trajectory.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ``Trajectory``</span>
<span class="sd">            The MDMC ``Trajectory`` corresponding to the LAMMPS ``trajectory_file``</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        AssertionError</span>
<span class="sd">            If ``universe`` is passed, and the number of atoms in the</span>
<span class="sd">            ``trajectory_file`` is not the same as in the ``universe``.</span>
<span class="sd">        TypeError</span>
<span class="sd">            If ``trajectory_file`` describes a triclinic universe.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">create_atom</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>

            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Create an MDMC ``Atom`` from a line in a LAMMPS dump (trajectory) file</span>

<span class="sd">            At a minimum it will set the ``ID``, ``atom_type` and ``position`` of</span>
<span class="sd">            the ``Atom``. It will also set the ``velocity`` if included in the line,</span>
<span class="sd">            and the ``Universe``, if this was passed to ``convert_trajectory()``.</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            line : numpy.ndarray</span>
<span class="sd">                ``array`` containing a line from the ATOMS sections of a LAMMPS dump</span>
<span class="sd">                file. The ``array`` must contain the atom ``ID``, the ``atom_type``,</span>
<span class="sd">                and the ``x``, ``y``, and ``z`` (or scaled equivalents) components</span>
<span class="sd">                of the ``position``, which are assumed to be adjacent. It will also</span>
<span class="sd">                set the ``velocity`` of the atom if this is included in the line.</span>

<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            ``Atom``</span>
<span class="sd">                MDMC ``Atom`` object corresponding to the ``line``</span>
<span class="sd">            &quot;&quot;&quot;</span>

            <span class="n">atom_type</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="n">i_type</span><span class="p">])</span>
            <span class="c1"># If distance units are same for MDMC and LAMMPS then</span>
            <span class="c1"># don&#39;t call convert_units - currently hardcoded</span>
            <span class="c1"># Same goes for velocity and time units</span>
            <span class="n">position</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">splt</span><span class="p">)</span> <span class="k">for</span> <span class="n">splt</span> <span class="ow">in</span> <span class="n">line</span><span class="p">[</span><span class="n">i_pos</span><span class="p">:</span><span class="n">i_pos</span><span class="o">+</span><span class="mi">3</span><span class="p">]]</span>
            <span class="c1"># Get symbol and mass from atom_type_properties</span>
            <span class="c1"># Adjusted for 0 index</span>
            <span class="n">symbol</span><span class="p">,</span> <span class="n">mass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmp_universe</span><span class="o">.</span><span class="n">atom_type_properties</span><span class="p">[</span><span class="n">atom_type</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">atom</span> <span class="o">=</span> <span class="n">Atom</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">position</span><span class="o">=</span><span class="n">position</span><span class="p">,</span> <span class="n">mass</span><span class="o">=</span><span class="n">mass</span><span class="p">)</span>
            <span class="n">atom</span><span class="o">.</span><span class="n">atom_type</span> <span class="o">=</span> <span class="n">atom_type</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">universe</span><span class="p">:</span>
                <span class="n">atom</span><span class="o">.</span><span class="n">universe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">universe</span>
            <span class="k">if</span> <span class="n">i_vel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">atom</span><span class="o">.</span><span class="n">velocity</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">splt</span><span class="p">)</span> <span class="k">for</span> <span class="n">splt</span>
                                <span class="ow">in</span> <span class="n">line</span><span class="p">[</span><span class="n">i_vel</span><span class="p">:</span><span class="n">i_vel</span><span class="o">+</span><span class="mi">3</span><span class="p">]]</span>
            <span class="k">return</span> <span class="n">atom</span>


        <span class="c1"># Change expected position string if scaled positions are used</span>
        <span class="n">pos_string</span> <span class="o">=</span> <span class="s1">&#39;xs&#39;</span> <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;scaled_positions&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;x&#39;</span>

        <span class="c1"># ID is an acronym</span>
        <span class="c1">#pylint: disable=invalid-name</span>
        <span class="n">atom_IDs</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;atom_IDs&#39;</span><span class="p">)</span>

        <span class="n">configs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">frame_n</span> <span class="o">=</span> <span class="n">start</span>
        <span class="c1"># Use count to create range so that stop can be undefined</span>
        <span class="n">frame_indexes</span> <span class="o">=</span> <span class="n">count</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>
        <span class="c1"># next_frame_n next attribute is assigned dynamically</span>
        <span class="n">next_frame_n</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">frame_indexes</span><span class="p">)</span> <span class="c1">#pylint: disable=no-member</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trajectory_file</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file_handler</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">file_handler</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
            <span class="k">while</span> <span class="n">line</span><span class="p">:</span>

                <span class="c1"># LAMMPS TIMESTEP is the number of time steps that have elapsed. To</span>
                <span class="c1"># avoid confusion with time_step (the amount of time that elapses in</span>
                <span class="c1"># a single simulation step, i.e. dt), these are referred to as</span>
                <span class="c1"># frames.</span>
                <span class="k">if</span> <span class="s1">&#39;ITEM: TIMESTEP&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="n">file_handler</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
                    <span class="n">frame</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>

                <span class="k">if</span> <span class="s1">&#39;ITEM: NUMBER OF ATOMS&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="n">file_handler</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
                    <span class="n">n_atoms</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="c1"># Check that n_atoms is as expected, if a universe was passed</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">universe</span><span class="p">:</span>
                        <span class="k">assert</span> <span class="n">n_atoms</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">universe</span><span class="o">.</span><span class="n">atoms</span><span class="p">)</span>

                <span class="k">if</span> <span class="s1">&#39;ITEM: BOX BOUNDS&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="c1"># CURRENTLY ASSUMES ORTHOGONAL SIMULATION BOX</span>
                    <span class="k">if</span> <span class="s1">&#39;xy&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;triclinic simulation boxes have not&#39;</span>
                                        <span class="s1">&#39; been implemented&#39;</span><span class="p">)</span>
                    <span class="c1"># Test dimensions are as expected, if a universe was passed</span>
                    <span class="c1"># and we are not using an NPT or NPH ensemble</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">universe</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="s1">&#39;npt&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fix_names</span> <span class="ow">or</span> <span class="s1">&#39;nph&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fix_names</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                            <span class="n">line</span> <span class="o">=</span> <span class="n">file_handler</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
                            <span class="n">dmin</span><span class="p">,</span> <span class="n">dmax</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">splt</span><span class="p">)</span> <span class="k">for</span> <span class="n">splt</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span>
                            <span class="k">assert</span> <span class="n">dmin</span> <span class="o">==</span> <span class="mf">0.0</span>
                            <span class="c1"># unit is taken from universe dimensions (which is a</span>
                            <span class="c1"># UnitArray)</span>
                            <span class="k">assert</span> <span class="n">dmax</span> <span class="o">==</span> <span class="n">convert_unit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">universe</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                                        <span class="bp">self</span><span class="o">.</span><span class="n">universe</span><span class="o">.</span><span class="n">dimensions</span><span class="o">.</span><span class="n">unit</span><span class="p">)</span>

                <span class="k">if</span> <span class="s1">&#39;ITEM: ATOMS&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">frame_n</span> <span class="o">==</span> <span class="n">start</span><span class="p">:</span>
                        <span class="c1"># LAMMPS dump files contain order of LAMMPS atom properties,</span>
                        <span class="c1"># at each time step. As these should not change with time</span>
                        <span class="c1"># step only determine this order for first required time</span>
                        <span class="c1"># step. Assumes that position components (x y z) and</span>
                        <span class="c1"># velocity components (vx vy vz) are always adjacent and</span>
                        <span class="c1"># ordered as shown.</span>
                        <span class="n">splt</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                        <span class="c1"># Requires id, type and position to be defined, velocity is</span>
                        <span class="c1"># optional</span>
                        <span class="n">i_id</span><span class="p">,</span> <span class="n">i_type</span><span class="p">,</span> <span class="n">i_pos</span> <span class="o">=</span> <span class="p">[</span><span class="n">splt</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">prop</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span> <span class="k">for</span> <span class="n">prop</span>
                                            <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="n">pos_string</span><span class="p">]]</span>
                        <span class="k">if</span> <span class="s1">&#39;vx&#39;</span> <span class="ow">in</span> <span class="n">splt</span><span class="p">:</span>
                            <span class="n">i_vel</span> <span class="o">=</span> <span class="n">splt</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;vx&#39;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">i_vel</span> <span class="o">=</span> <span class="kc">None</span>

                    <span class="k">if</span> <span class="n">frame_n</span> <span class="o">==</span> <span class="n">next_frame_n</span><span class="p">:</span>
                        <span class="c1"># Reads all atom lines before creating any atoms. By</span>
                        <span class="c1"># creating a list of tuples of (LAMMPS_ID, atom), this</span>
                        <span class="c1"># allows the lines to be reordered based on LAMMPS_ID. This</span>
                        <span class="c1"># is required as by default LAMMPS does not sort by ID, so</span>
                        <span class="c1"># the same atom will not appear in the same place for each</span>
                        <span class="c1"># time step.</span>
                        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_atoms</span><span class="p">):</span>
                            <span class="n">line</span> <span class="o">=</span> <span class="n">file_handler</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                            <span class="c1"># convert id to int</span>
                            <span class="n">line</span><span class="p">[</span><span class="n">i_id</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="n">i_id</span><span class="p">])</span>
                            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                        <span class="c1"># sort list of lists based on id</span>
                        <span class="n">lines</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="n">i_id</span><span class="p">])</span>

                        <span class="n">atoms</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
                            <span class="c1"># Checks if only specific atom_IDs are required, and if</span>
                            <span class="c1"># so, only creates atoms which have those IDs</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">atom_IDs</span> <span class="ow">or</span> <span class="n">line</span><span class="p">[</span><span class="n">i_id</span><span class="p">]</span> <span class="ow">in</span> <span class="n">atom_IDs</span><span class="p">:</span>
                                <span class="n">atoms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">create_atom</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>

                        <span class="c1"># Multiply the number of timesteps by dt to calculate the</span>
                        <span class="c1"># elapsed time</span>
                        <span class="n">configs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TemporalConfiguration</span><span class="p">(</span><span class="n">frame</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">,</span>
                                                            <span class="o">*</span><span class="n">atoms</span><span class="p">))</span>

                        <span class="c1"># next_frame_n next attribute is assigned dynamically</span>
                        <span class="c1">#pylint: disable=no-member</span>
                        <span class="n">next_frame_n</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">frame_indexes</span><span class="p">)</span>
                    <span class="n">frame_n</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">stop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">frame_n</span> <span class="o">&gt;=</span> <span class="n">stop</span><span class="p">:</span>
                        <span class="k">break</span>

                <span class="n">line</span> <span class="o">=</span> <span class="n">file_handler</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">Trajectory</span><span class="p">(</span><span class="o">*</span><span class="n">configs</span><span class="p">)</span></div>

<div class="viewcode-block" id="LAMMPSEngine.update_parameters"><a class="viewcode-back" href="../../../../pages/modules/md/engine_facades/lammps_engine.html#MDMC.MD.engine_facades.lammps_engine.LAMMPSEngine.update_parameters">[docs]</a>    <span class="k">def</span> <span class="nf">update_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lmp_universe</span><span class="o">.</span><span class="n">update_parameters</span><span class="p">()</span></div>

<div class="viewcode-block" id="LAMMPSEngine.save_config"><a class="viewcode-back" href="../../../../pages/modules/md/engine_facades/lammps_engine.html#MDMC.MD.engine_facades.lammps_engine.LAMMPSEngine.save_config">[docs]</a>    <span class="k">def</span> <span class="nf">save_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c1"># So that the identical calculation is not performed for all processes,</span>
        <span class="c1"># only calculate for rank 0 process</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># It is not possible to deepcopy the LAMMPS wrapper atoms attribute,</span>
            <span class="c1"># or the individual atoms, so instead this saves the x, y, z, mass</span>
            <span class="c1"># and charge in a NumPy array with the indexes given by the atom ID</span>
            <span class="c1"># (with a -1 offset due to zero index)</span>
            <span class="c1"># The atoms attribute also is not iterable</span>
            <span class="n">n_atoms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">system_state</span><span class="o">.</span><span class="n">natoms</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> save_config: {n_atoms: </span><span class="si">%s</span><span class="s1">}. Config saved.&#39;</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span>
                        <span class="n">n_atoms</span><span class="p">)</span>
            <span class="n">atoms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">n_atoms</span><span class="p">,</span> <span class="mi">5</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_atoms</span><span class="p">):</span>
                <span class="n">atom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmp</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">atoms</span><span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">id</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">([</span><span class="n">component</span> <span class="k">for</span> <span class="n">component</span>
                                        <span class="ow">in</span> <span class="n">atom</span><span class="o">.</span><span class="n">position</span><span class="p">]</span>
                                       <span class="o">+</span> <span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">mass</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">charge</span><span class="p">])</span>
            <span class="n">saved_config</span> <span class="o">=</span> <span class="n">atoms</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">saved_config</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Broadcast rank 0 saved config to all processes - this is not required</span>
        <span class="c1"># as anything that accesses the _saved_config attribute could be set so</span>
        <span class="c1"># that it only accesses the rank 0 saved config, however currently it is</span>
        <span class="c1"># simpler to duplicate saved config for all processes.</span>
        <span class="n">saved_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">bcast</span><span class="p">(</span><span class="n">saved_config</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_saved_config</span> <span class="o">=</span> <span class="n">saved_config</span></div>

<div class="viewcode-block" id="LAMMPSEngine.reset_config"><a class="viewcode-back" href="../../../../pages/modules/md/engine_facades/lammps_engine.html#MDMC.MD.engine_facades.lammps_engine.LAMMPSEngine.reset_config">[docs]</a>    <span class="k">def</span> <span class="nf">reset_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lmp_universe</span><span class="o">.</span><span class="n">set_config</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_config</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="LAMMPSUniverse"><a class="viewcode-back" href="../../../../pages/modules/md/engine_facades/lammps_engine.html#MDMC.MD.engine_facades.lammps_engine.LAMMPSUniverse">[docs]</a><span class="nd">@repr_decorator</span><span class="p">(</span><span class="s1">&#39;universe&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">LAMMPSUniverse</span><span class="p">(</span><span class="n">PyLammpsAttribute</span><span class="p">):</span>
    <span class="c1"># Class has to maintain a lot of state (attributes) as PyLammps class does</span>
    <span class="c1"># not</span>
    <span class="c1">#pylint: disable=too-many-instance-attributes</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class with what would be the equivalent in LAMMPS to the universe (i.e.</span>
<span class="sd">    the configuration and topology)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    universe : Universe</span>
<span class="sd">        The MDMC ``Universe`` used to create the ``LAMMPSUniverse``</span>
<span class="sd">    lmp : PyLammps, optional</span>
<span class="sd">        Set the ``lmp`` attribute to a ``PyLammps`` object. Default is `None`,</span>
<span class="sd">        which results in a new ``PyLammps`` object being initialised.</span>
<span class="sd">    **settings</span>
<span class="sd">        ``atom_style`` (`str`)</span>
<span class="sd">            A LAMMPS ``atom_style`` string. The default setting of ``real`` will</span>
<span class="sd">            generally be appropriate.</span>
<span class="sd">        ``nonbonded_mix`` (`str`)</span>
<span class="sd">            The name of the formula which determines non-bonded mixing</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    universe : Universe</span>
<span class="sd">        The MDMC ``Universe`` which has been converted to this</span>
<span class="sd">        ``LAMMPSUniverse``.</span>
<span class="sd">    atom_dict : dict</span>
<span class="sd">        A `dict` with {``MDMC_atom``: ``LAMMPS_atom_id``}, where ``MDMC_atom``</span>
<span class="sd">        is an MDMC ``Atom`` and ``LAMMPS_atom`` is the corresponding LAMMPS</span>
<span class="sd">        ``Atom``.</span>
<span class="sd">    atom_types : dict</span>
<span class="sd">        A `dict` with {``type_ID``: ``MDMC_atom_group``}, where the ``type_ID``</span>
<span class="sd">        is a unique `int` and ``MDMC_atom_group`` is a `list` of ``Atom`` which</span>
<span class="sd">        are identical in terms of element and interactions.</span>
<span class="sd">    atom_type_properties : list of tuples</span>
<span class="sd">        Each `tuple` is (``symbol``, ``mass``) for all ``atom_types`` (ordered)</span>
<span class="sd">        by ``atom_type``, where ``symbol`` is a `str` specifying the element of</span>
<span class="sd">        the ``atom_type`` and ``mass`` is a `float` specifying the ``mass`` of</span>
<span class="sd">        the ``atom_type``.</span>
<span class="sd">    bonds : list of Bonds</span>
<span class="sd">        All ``Bond`` interactions in the MDMC ``Universe``.</span>
<span class="sd">    angles : list of BondAngles</span>
<span class="sd">        All ``BondAngle`` interactions in the MDMC ``Universe``.</span>
<span class="sd">    couls : list of Coulombics</span>
<span class="sd">        All ``Coulombic`` interactions in the MDMC ``Universe``.</span>
<span class="sd">    disps : list of Dispersions</span>
<span class="sd">        All ``Dispersion`` interactions in the MDMC ``Universe``.</span>
<span class="sd">    bond_ID : dict</span>
<span class="sd">        A `dict` of {``bond``: ``ID pairs``} relating each ``Bond`` to a LAMMPS</span>
<span class="sd">        ``ID``.</span>
<span class="sd">    angle_ID : dict</span>
<span class="sd">        A `dict` of {``angle``: ``ID pairs``} relating each ``BondAngle`` to a</span>
<span class="sd">        LAMMPS ``ID``.</span>
<span class="sd">    proper_ID : dict</span>
<span class="sd">        A `dict` of {``proper``: ``ID pairs``} relating each ``DihedralAngle``</span>
<span class="sd">        (with ``improper == False``) to a LAMMPS ``ID``.</span>
<span class="sd">    improper_ID : dict</span>
<span class="sd">        A `dict` of {``improper``: ``ID pairs``} relating each ``DihedralAngle``</span>
<span class="sd">        (with ``improper == True``) to a LAMMPS ``ID``.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">universe</span><span class="p">,</span> <span class="n">lmp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">):</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">lmp</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;atom_style&#39;</span><span class="p">,</span> <span class="s1">&#39;full&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">universe</span> <span class="o">=</span> <span class="n">universe</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atom_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atom_types</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atom_type_properties</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">angles</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">propers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">impropers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># ID is an acronym</span>
        <span class="c1">#pylint: disable=invalid-name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bond_ID</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">angle_ID</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">proper_ID</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">improper_ID</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nonbonded_mix</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_define_simulation_box</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">universe</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_build_config</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">universe</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_topology</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">universe</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_parameters</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nonbonded_mix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get or set the formula used to calculate nonbonded interactions between</span>
<span class="sd">        different ``atom_types``</span>

<span class="sd">        Options are ``geometric``, ``arithmetic`` and ``sixthpower``, which are</span>
<span class="sd">        defined in the LAMMPS documentation.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        `str`</span>
<span class="sd">            The name of the formula which determines non-bonded mixing</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            `str` specifies an unsupported mix name</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nonbonded_mix</span>

    <span class="nd">@nonbonded_mix</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">nonbonded_mix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_nonbonded_mix</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">supported</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;geometric&#39;</span><span class="p">,</span> <span class="s1">&#39;arithmetic&#39;</span><span class="p">,</span> <span class="s1">&#39;sixthpower&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">supported</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;The supported mixes are: </span><span class="si">{0}</span><span class="s1">, </span><span class="si">{1}</span><span class="s1">, </span><span class="si">{2}</span><span class="s1">&#39;</span>
                                 <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">supported</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_nonbonded_mix</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

<div class="viewcode-block" id="LAMMPSUniverse.update_parameters"><a class="viewcode-back" href="../../../../pages/modules/md/engine_facades/lammps_engine.html#MDMC.MD.engine_facades.lammps_engine.LAMMPSUniverse.update_parameters">[docs]</a>    <span class="k">def</span> <span class="nf">update_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Updates the LAMMPS force field parameters from the MDMC universe</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_update_charges</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_bonded_interactions</span><span class="p">(</span><span class="s1">&#39;bond&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_bonded_interactions</span><span class="p">(</span><span class="s1">&#39;angle&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">angles</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_bonded_interactions</span><span class="p">(</span><span class="s1">&#39;dihedral&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">propers</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_bonded_interactions</span><span class="p">(</span><span class="s1">&#39;improper&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">impropers</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_dispersions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">universe</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_define_simulation_box</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">universe</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Defines a region and creates a simulation box that fills this region</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        universe : Universe</span>
<span class="sd">            The MDMC ``Universe`` used to create the region and simulation box.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># ID is an acronym</span>
        <span class="c1">#pylint: disable=invalid-name</span>
        <span class="n">region_ID</span> <span class="o">=</span> <span class="s1">&#39;universe&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_create_lammps_region</span><span class="p">(</span><span class="n">universe</span><span class="p">,</span> <span class="n">region_ID</span><span class="p">)</span>
        <span class="n">n_atom_types</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">universe</span><span class="o">.</span><span class="n">atom_types</span><span class="p">)</span>

        <span class="c1"># Determine number of bond and angle types</span>
        <span class="n">bonded_interaction_types</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">universe</span><span class="o">.</span><span class="n">interactions</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">BondedInteraction</span><span class="p">)]</span>
        <span class="c1"># Dihedrals are only separated into proper and improper at the attribute</span>
        <span class="c1"># level</span>
        <span class="n">dihedrals</span> <span class="o">=</span> <span class="n">partition_interactions</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">universe</span><span class="o">.</span><span class="n">interactions</span><span class="p">),</span>
                                           <span class="p">[</span><span class="s1">&#39;DihedralAngle&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">dihedral_types</span> <span class="o">=</span> <span class="p">[</span><span class="n">dihedral</span><span class="o">.</span><span class="n">improper</span> <span class="k">for</span> <span class="n">dihedral</span> <span class="ow">in</span> <span class="n">dihedrals</span><span class="p">]</span>
        <span class="n">n_bond_types</span> <span class="o">=</span> <span class="n">bonded_interaction_types</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;Bond&#39;</span><span class="p">)</span>
        <span class="n">n_angle_types</span> <span class="o">=</span> <span class="n">bonded_interaction_types</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;BondAngle&#39;</span><span class="p">)</span>
        <span class="n">n_dihedral_types</span> <span class="o">=</span> <span class="n">dihedral_types</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">n_improper_types</span> <span class="o">=</span> <span class="n">dihedral_types</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Determine max number of bonds and angles per atom</span>
        <span class="n">atoms</span> <span class="o">=</span> <span class="n">universe</span><span class="o">.</span><span class="n">atoms</span>
        <span class="n">max_bonds_per_atom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_n_interaction</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="s1">&#39;Bond&#39;</span><span class="p">)</span>
        <span class="n">max_angles_per_atom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_n_interaction</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="s1">&#39;BondAngle&#39;</span><span class="p">)</span>
        <span class="n">max_dihedrals_per_atom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_n_interaction</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="s1">&#39;proper&#39;</span><span class="p">)</span>
        <span class="n">max_impropers_per_atom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_n_interaction</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="s1">&#39;improper&#39;</span><span class="p">)</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> create LAMMPS box: {n_atom_types: </span><span class="si">%s</span><span class="s1">&#39;</span>
                     <span class="s1">&#39; n_bond_types: </span><span class="si">%s</span><span class="s1">, n_angle_types: </span><span class="si">%s</span><span class="s1">,&#39;</span>
                     <span class="s1">&#39; n_dihedral_types: </span><span class="si">%s</span><span class="s1">, n_improper_types: </span><span class="si">%s</span><span class="s1">,&#39;</span>
                     <span class="s1">&#39; max_bonds_per_atom: </span><span class="si">%s</span><span class="s1">, max_angles_per_atom: </span><span class="si">%s</span><span class="s1">,&#39;</span>
                     <span class="s1">&#39; max_dihedrals_per_atom: </span><span class="si">%s</span><span class="s1">, max_impropers_per_atom: </span><span class="si">%s</span><span class="s1">}&#39;</span><span class="p">,</span>
                     <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span>
                     <span class="n">n_atom_types</span><span class="p">,</span>
                     <span class="n">n_bond_types</span><span class="p">,</span>
                     <span class="n">n_angle_types</span><span class="p">,</span>
                     <span class="n">n_dihedral_types</span><span class="p">,</span>
                     <span class="n">n_improper_types</span><span class="p">,</span>
                     <span class="n">max_bonds_per_atom</span><span class="p">,</span>
                     <span class="n">max_angles_per_atom</span><span class="p">,</span>
                     <span class="n">max_dihedrals_per_atom</span><span class="p">,</span>
                     <span class="n">max_impropers_per_atom</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lmp</span><span class="o">.</span><span class="n">create_box</span><span class="p">(</span><span class="n">n_atom_types</span><span class="p">,</span>
                            <span class="n">region_ID</span><span class="p">,</span>
                            <span class="s1">&#39;bond/types&#39;</span><span class="p">,</span> <span class="n">n_bond_types</span><span class="p">,</span>
                            <span class="s1">&#39;angle/types&#39;</span><span class="p">,</span> <span class="n">n_angle_types</span><span class="p">,</span>
                            <span class="s1">&#39;dihedral/types&#39;</span><span class="p">,</span> <span class="n">n_dihedral_types</span><span class="p">,</span>
                            <span class="s1">&#39;improper/types&#39;</span><span class="p">,</span> <span class="n">n_improper_types</span><span class="p">,</span>
                            <span class="s1">&#39;extra/bond/per/atom&#39;</span><span class="p">,</span> <span class="n">max_bonds_per_atom</span><span class="p">,</span>
                            <span class="s1">&#39;extra/angle/per/atom&#39;</span><span class="p">,</span> <span class="n">max_angles_per_atom</span><span class="p">,</span>
                            <span class="s1">&#39;extra/dihedral/per/atom&#39;</span><span class="p">,</span> <span class="n">max_dihedrals_per_atom</span><span class="p">,</span>
                            <span class="s1">&#39;extra/improper/per/atom&#39;</span><span class="p">,</span> <span class="n">max_impropers_per_atom</span>
                           <span class="p">)</span>

    <span class="c1"># ID is an acronym</span>
    <span class="c1">#pylint: disable=invalid-name</span>
    <span class="k">def</span> <span class="nf">_create_lammps_region</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">universe</span><span class="p">,</span> <span class="n">region_ID</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a geometry of the simulation box in LAMMPS</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        universe : Universe</span>
<span class="sd">            The MDMC ``Universe`` used to create the region.</span>
<span class="sd">        region_ID : str</span>
<span class="sd">            The LAMMPS region ``ID``</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">xlo</span> <span class="o">=</span> <span class="n">ylo</span> <span class="o">=</span> <span class="n">zlo</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">xhi</span><span class="p">,</span> <span class="n">yhi</span><span class="p">,</span> <span class="n">zhi</span> <span class="o">=</span> <span class="n">universe</span><span class="o">.</span><span class="n">dimensions</span>
        <span class="n">region_ID</span> <span class="o">=</span> <span class="s1">&#39;universe&#39;</span>
        <span class="c1"># &#39;block&#39; gives a cuboidal universe</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lmp</span><span class="o">.</span><span class="n">region</span><span class="p">(</span><span class="n">region_ID</span><span class="p">,</span> <span class="s1">&#39;block&#39;</span><span class="p">,</span> <span class="n">xlo</span><span class="p">,</span> <span class="n">xhi</span><span class="p">,</span> <span class="n">ylo</span><span class="p">,</span> <span class="n">yhi</span><span class="p">,</span> <span class="n">zlo</span><span class="p">,</span> <span class="n">zhi</span><span class="p">,</span>
                        <span class="n">units</span><span class="o">=</span><span class="s1">&#39;box&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_build_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">universe</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds atoms to LAMMPS</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        universe : Universe</span>
<span class="sd">            The MDMC ``Universe`` used to fill the LAMMPS box with atoms.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">atom_types</span> <span class="o">=</span> <span class="n">universe</span><span class="o">.</span><span class="n">atom_types</span>
        <span class="c1"># Assume all atoms of the same type have the same element and mass</span>
        <span class="c1"># Sort atoms based on atom_type (i.e. numerically starting at 1) so</span>
        <span class="c1"># that it is possible to index into atom_type_properties with</span>
        <span class="c1"># atom_type - 1 (where the -1 is to account for 0 indexing on lists)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atom_type_properties</span> <span class="o">=</span> <span class="p">[(</span><span class="n">atom</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">element</span><span class="p">,</span> <span class="n">atom</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mass</span><span class="p">)</span>
                                     <span class="k">for</span> <span class="nb">type</span><span class="p">,</span> <span class="n">atom</span>
                                     <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atom_types</span><span class="o">.</span><span class="n">items</span><span class="p">())]</span>

        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> Add atoms to LAMMPS&#39;</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">type_ID</span><span class="p">,</span> <span class="n">atom_type_group</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atom_types</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># The mass below has associated units, which causes a segfault when</span>
            <span class="c1"># it is passed to LAMMPS - cast to float to remove units</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lmp</span><span class="o">.</span><span class="n">mass</span><span class="p">(</span><span class="n">type_ID</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">atom_type_group</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mass</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">atom_type_group</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lmp</span><span class="o">.</span><span class="n">create_atoms</span><span class="p">(</span><span class="n">type_ID</span><span class="p">,</span> <span class="s1">&#39;single&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">atom</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># As PyLammps has a bug preventing getting atom id from</span>
                    <span class="c1"># self.lmp.atoms[index].id, use number of atoms as proxy for</span>
                    <span class="c1"># new atom id (as it is sequential)</span>
                    <span class="n">lmp_atom_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmp</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">natoms</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">lmp</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;atom&#39;</span><span class="p">,</span> <span class="n">lmp_atom_id</span><span class="p">,</span>
                                 <span class="s1">&#39;vx&#39;</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">velocity</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                 <span class="s1">&#39;vy&#39;</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">velocity</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                 <span class="s1">&#39;vz&#39;</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">velocity</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">lmp_atom_id</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">atom_dict</span><span class="p">[</span><span class="n">atom</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">bcast</span><span class="p">(</span><span class="n">lmp_atom_id</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<div class="viewcode-block" id="LAMMPSUniverse.set_config"><a class="viewcode-back" href="../../../../pages/modules/md/engine_facades/lammps_engine.html#MDMC.MD.engine_facades.lammps_engine.LAMMPSUniverse.set_config">[docs]</a>    <span class="k">def</span> <span class="nf">set_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Changes the positions of all of the atoms in the LAMMPS wrapper</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        config : numpy.ndarray</span>
<span class="sd">            The ``positions``, ``mass`` and ``charge`` of the ``Atom`` objects,</span>
<span class="sd">            used to set the LAMMPS configuration. Each row of the array must</span>
<span class="sd">            correspond to the LAMMPS ``atom ID - 1`` (offset is due to ``array``</span>
<span class="sd">            zero indexing) and the columns of the ``array`` must be the ``x``,</span>
<span class="sd">            ``y``, ``z`` components of the ``position``, the ``mass`` and the</span>
<span class="sd">            ``charge`` of each ``Atom``.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        IndexError</span>
<span class="sd">            If ``config`` does not contain the same number of atoms as LAMMPS</span>
<span class="sd">            possesses.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Raise an IndexError if the config is not the correct size</span>
        <span class="n">n_atoms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">system_state</span><span class="o">.</span><span class="n">natoms</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">config</span><span class="p">)</span> <span class="o">!=</span> <span class="n">n_atoms</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s1">&#39;the new configuration does not specify the&#39;</span>
                             <span class="s1">&#39; correct number of atoms&#39;</span><span class="p">)</span>

        <span class="c1"># The LAMMPS wrapper does not allow the configuration to be updated</span>
        <span class="c1"># simply by setting all atoms. Instead the position of the atoms must be</span>
        <span class="c1"># reset.</span>
        <span class="n">index_components</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">([</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">]))</span>
        <span class="c1"># LAMMPS IDs start at 1, so are offset from config indexes</span>
        <span class="k">for</span> <span class="n">id_offset</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_atoms</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">component</span> <span class="ow">in</span> <span class="n">index_components</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lmp</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;atom&#39;</span><span class="p">,</span> <span class="n">id_offset</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">component</span><span class="p">,</span>
                             <span class="n">config</span><span class="p">[</span><span class="n">id_offset</span><span class="p">][</span><span class="n">index</span><span class="p">])</span></div>

    <span class="k">def</span> <span class="nf">_max_n_interaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atoms</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        atoms : list of Atoms</span>
<span class="sd">        name : str</span>
<span class="sd">            An ``Interaction`` type, for example ``Bond``.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        `int`</span>
<span class="sd">            The maximum number of interactions with a given name that any</span>
<span class="sd">            ``Atom`` in ``atoms`` possesses</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">max_inters</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">atoms</span><span class="p">:</span>
            <span class="c1"># Filter interactions by name</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;proper&#39;</span><span class="p">,</span> <span class="s1">&#39;improper&#39;</span><span class="p">]:</span>
                <span class="n">improper</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;improper&#39;</span><span class="p">)</span>
                <span class="n">inters</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="n">i</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;DihedralAngle&#39;</span> <span class="ow">and</span>
                                <span class="n">i</span><span class="o">.</span><span class="n">improper</span> <span class="o">==</span> <span class="n">improper</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">interactions</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">inters</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="n">i</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">name</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">interactions</span><span class="p">)</span>
            <span class="n">n_inters</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">inters</span><span class="p">))</span>
            <span class="n">max_inters</span> <span class="o">=</span> <span class="n">n_inters</span> <span class="k">if</span> <span class="n">n_inters</span> <span class="o">&gt;</span> <span class="n">max_inters</span> <span class="k">else</span> <span class="n">max_inters</span>
        <span class="k">return</span> <span class="n">max_inters</span>

    <span class="k">def</span> <span class="nf">_add_topology</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">universe</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add the bonded and nonbonded interactions to LAMMPS</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        universe : Universe</span>
<span class="sd">            The MDMC ``Universe`` used to define the topology.</span>
<span class="sd">        **settings</span>
<span class="sd">            ``nonbonded_mix`` (`str`)</span>
<span class="sd">                The name of the formula which determines non-bonded mixing</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        NotImplementedError</span>
<span class="sd">            If ``universe`` contains an interaction type that has not been</span>
<span class="sd">            implemented in the LAMMPS facade</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> Add topology to LAMMPS&#39;</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)</span>
        <span class="n">bonds</span><span class="p">,</span> <span class="n">angles</span><span class="p">,</span> <span class="n">dihedrals</span><span class="p">,</span> <span class="n">disps</span><span class="p">,</span> <span class="n">couls</span><span class="p">,</span> <span class="n">others</span> <span class="o">=</span> <span class="n">partition_interactions</span><span class="p">(</span>
            <span class="nb">set</span><span class="p">(</span><span class="n">universe</span><span class="o">.</span><span class="n">interactions</span><span class="p">),</span>
            <span class="p">[</span><span class="s1">&#39;Bond&#39;</span><span class="p">,</span> <span class="s1">&#39;BondAngle&#39;</span><span class="p">,</span> <span class="s1">&#39;DihedralAngle&#39;</span><span class="p">,</span> <span class="s1">&#39;Dispersion&#39;</span><span class="p">,</span> <span class="s1">&#39;Coulombic&#39;</span><span class="p">],</span>
            <span class="n">unpartitioned</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">lst</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">others</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;This interaction type has not been&#39;</span>
                                      <span class="s1">&#39; implemented in the LAMMPS facade&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span> <span class="o">=</span> <span class="n">bonds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">angles</span> <span class="o">=</span> <span class="n">angles</span>

        <span class="n">pair_styles</span><span class="p">,</span> <span class="n">pair_mods</span><span class="p">,</span> <span class="n">pair_coeff_cmds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pair_commands</span><span class="p">(</span><span class="n">universe</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pair_styles</span><span class="p">:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> Add nonbonded pair styles to LAMMPS: {pair_styles:&#39;</span>
                         <span class="s1">&#39; </span><span class="si">%s</span><span class="s1">, pair_mods: </span><span class="si">%s</span><span class="s1">, pair_coeff_cmds: </span><span class="si">%s</span><span class="s1">}&#39;</span><span class="p">,</span>
                         <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span>
                         <span class="n">pair_styles</span><span class="p">,</span>
                         <span class="n">pair_mods</span><span class="p">,</span>
                         <span class="n">pair_coeff_cmds</span><span class="p">)</span>
            <span class="c1"># hybrid/overlay allows multiple pair_styles for same atom_type pair</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lmp</span><span class="o">.</span><span class="n">pair_style</span><span class="p">(</span><span class="s1">&#39;hybrid/overlay&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">pair_styles</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_charges</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nonbonded_mix</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;nonbonded_mix&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_dispersions</span><span class="p">(</span><span class="n">universe</span><span class="p">,</span> <span class="n">pair_coeff_cmds</span><span class="p">)</span>
            <span class="c1"># Apply LAMMPS modifications to nonbonded interactions</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_modify_nonbonded_styles</span><span class="p">(</span><span class="n">pair_mods</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">bonds</span><span class="p">:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> Add bonds to LAMMPS&#39;</span><span class="p">,</span>
                         <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)</span>
            <span class="c1"># Set used to remove duplicate bond styles, which are not required</span>
            <span class="c1"># to be (and in fact cannot) be passed to LAMMPS hybrid bond_style</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lmp</span><span class="o">.</span><span class="n">bond_style</span><span class="p">(</span><span class="s1">&#39;hybrid&#39;</span><span class="p">,</span>
                                <span class="o">*</span><span class="nb">set</span><span class="p">(</span><span class="nb">tuple</span><span class="p">([</span><span class="n">parse_bonded_styles</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
                                            <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">bonds</span><span class="p">])))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_create_bonded_interactions</span><span class="p">(</span><span class="s1">&#39;bond&#39;</span><span class="p">,</span> <span class="n">bonds</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">angles</span><span class="p">:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> Add angles to LAMMPS&#39;</span><span class="p">,</span>
                         <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)</span>
            <span class="c1"># Set used to remove duplicate angle styles, which are not required</span>
            <span class="c1"># to be (and in fact cannot) be passed to LAMMPS hybrid angle_style</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lmp</span><span class="o">.</span><span class="n">angle_style</span><span class="p">(</span><span class="s1">&#39;hybrid&#39;</span><span class="p">,</span>
                                 <span class="o">*</span><span class="nb">set</span><span class="p">(</span><span class="nb">tuple</span><span class="p">([</span><span class="n">parse_bonded_styles</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
                                             <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">angles</span><span class="p">])))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_create_bonded_interactions</span><span class="p">(</span><span class="s1">&#39;angle&#39;</span><span class="p">,</span> <span class="n">angles</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">dihedrals</span><span class="p">:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> Add dihedrals to LAMMPS&#39;</span><span class="p">,</span>
                         <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)</span>
            <span class="c1"># Split dihedrals into proper and impropers</span>
            <span class="n">impropers</span><span class="p">,</span> <span class="n">propers</span> <span class="o">=</span> <span class="n">partition</span><span class="p">(</span><span class="n">dihedrals</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">d</span><span class="p">:</span> <span class="n">d</span><span class="o">.</span><span class="n">improper</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">impropers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">propers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">impropers</span><span class="p">),</span> <span class="nb">list</span><span class="p">(</span><span class="n">propers</span><span class="p">)</span>
            <span class="c1"># Set used to remove duplicate dihedral styles, which are not</span>
            <span class="c1"># required to be (and in fact cannot) be passed to LAMMPS hybrid</span>
            <span class="c1"># dihedral_style or improper_style</span>
            <span class="n">proper_styles</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">tuple</span><span class="p">([</span><span class="n">parse_bonded_styles</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span>
                                       <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">propers</span><span class="p">]))</span>
            <span class="n">improper_styles</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">tuple</span><span class="p">([</span><span class="n">parse_bonded_styles</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span>
                                         <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">impropers</span><span class="p">]))</span>
            <span class="k">if</span> <span class="n">proper_styles</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lmp</span><span class="o">.</span><span class="n">dihedral_style</span><span class="p">(</span><span class="s1">&#39;hybrid&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">proper_styles</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_create_bonded_interactions</span><span class="p">(</span><span class="s1">&#39;dihedral&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">propers</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">improper_styles</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lmp</span><span class="o">.</span><span class="n">improper_style</span><span class="p">(</span><span class="s1">&#39;hybrid&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">improper_styles</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_create_bonded_interactions</span><span class="p">(</span><span class="s1">&#39;improper&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">impropers</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">universe</span><span class="o">.</span><span class="n">constraint_algorithm</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">apply_constraints</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_pair_commands</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">universe</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parses all the ``NonBondedInteractions`` for every appropriate</span>
<span class="sd">        combination of ``atom_type`` pairs in an MDMC ``Universe``, returning</span>
<span class="sd">        the correctly formatted input for ``pair_style`` and ``pair_coeff``</span>
<span class="sd">        LAMMPS commands.</span>

<span class="sd">        THE PARSING OF PAIR MODIFIERS IS LIMITED - if there is more than one</span>
<span class="sd">        interaction with the same ``pair_style``, and if these pair styles have</span>
<span class="sd">        different modifiers, all of the modifiers will be applied to this</span>
<span class="sd">        ``pair_style``. The correct implementation would apply each modifier to</span>
<span class="sd">        a copy of the ``pair_style``.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        universe : Universe</span>
<span class="sd">            The MDMC ``Universe`` containing the ``NonBondedInteraction``</span>
<span class="sd">            objects to be parsed.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        `tuple`</span>
<span class="sd">            (``pair_styles``, ``pair_modifiers``, ``pair_coeff_cmds``), where</span>
<span class="sd">            ``pair_styles`` is a flattened `list` of `str` for the</span>
<span class="sd">            ``pair_style`` commands to be set in the LAMMPS interface,</span>
<span class="sd">            ``pair_modifiers`` is a `list` of `list` of `str` for the</span>
<span class="sd">            ``pair_modify`` commands to be set in the LAMMPS interface, and</span>
<span class="sd">            ``pair_coeff_cmds`` is a `list` of `str` for the ``pair_coeff``</span>
<span class="sd">            commands for each ``atom_type`` pair to be set individually in the</span>
<span class="sd">            LAMMPS interface.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">pair_styles</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">pair_modifiers</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">set</span><span class="p">)</span>
        <span class="n">pair_coeff_cmds</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">pair</span><span class="p">,</span> <span class="n">inters</span> <span class="ow">in</span> <span class="n">universe</span><span class="o">.</span><span class="n">nbis_by_atom_type_pairs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># Generates list of tuples containing styles and cutoffs</span>
            <span class="n">styles_mods</span> <span class="o">=</span> <span class="n">parse_all_nonbonded_styles</span><span class="p">(</span><span class="n">inters</span><span class="p">)</span>
            <span class="c1"># One list of pair modifier for</span>
            <span class="k">for</span> <span class="n">style</span><span class="p">,</span> <span class="n">mod</span> <span class="ow">in</span> <span class="n">styles_mods</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="c1"># Only append if there is a modifier on the pair style</span>
                <span class="k">if</span> <span class="n">mod</span><span class="p">:</span>
                    <span class="c1"># Only the first style index is required as the rest contain</span>
                    <span class="c1"># cutoffs etc</span>
                    <span class="n">pair_modifiers</span><span class="p">[</span><span class="n">style</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">mod</span><span class="p">))</span>
            <span class="c1"># Generates list of tuples that contain each pair_coeff command</span>
            <span class="n">parsed_coeffs</span> <span class="o">=</span> <span class="n">parse_dispersion_coefficients</span><span class="p">(</span><span class="n">inters</span><span class="p">,</span>
                                                          <span class="n">styles_mods</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="n">coeff_cmds</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">a_type</span><span class="p">)</span> <span class="k">for</span> <span class="n">a_type</span> <span class="ow">in</span> <span class="n">pair</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span>
                          <span class="o">+</span> <span class="n">coeff</span> <span class="k">for</span> <span class="n">coeff</span> <span class="ow">in</span> <span class="n">parsed_coeffs</span><span class="p">]</span>
            <span class="n">pair_styles</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">styles_mods</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="n">pair_coeff_cmds</span> <span class="o">+=</span> <span class="n">coeff_cmds</span>

        <span class="c1"># Remove duplicates in pair_styles, create flattened list</span>
        <span class="n">pair_styles</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">(</span><span class="n">pair_styles</span><span class="p">))</span>
        <span class="n">pair_modifiers</span> <span class="o">=</span> <span class="p">[[</span><span class="n">style</span><span class="p">,</span> <span class="o">*</span><span class="n">mod</span><span class="p">]</span> <span class="k">for</span> <span class="n">style</span><span class="p">,</span> <span class="n">mod</span>
                          <span class="ow">in</span> <span class="n">pair_modifiers</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>

        <span class="k">return</span> <span class="n">pair_styles</span><span class="p">,</span> <span class="n">pair_modifiers</span><span class="p">,</span> <span class="n">pair_coeff_cmds</span>

    <span class="k">def</span> <span class="nf">_update_charges</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Updates the ``charges`` in LAMMPS</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        AttributeError</span>
<span class="sd">            If one or more ``Atom`` do not have a ``charge`` (or</span>
<span class="sd">            ``charge is None``)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">atom</span><span class="p">,</span> <span class="n">lmp_atom_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atom_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lmp</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;atom&#39;</span><span class="p">,</span>
                             <span class="n">lmp_atom_id</span><span class="p">,</span>
                             <span class="s1">&#39;charge&#39;</span><span class="p">,</span>
                             <span class="n">convert_unit</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">charge</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s1">&#39;LAMMPS requires all atoms in the universe&#39;</span>
                                     <span class="s1">&#39; to have a charge.&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_update_dispersions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">universe</span><span class="p">,</span> <span class="n">pair_coeff_cmds</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Updates ``Dispersion`` interactions in LAMMPS</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        universe : Universe</span>
<span class="sd">            The MDMC ``Universe`` containing ``NonBondedInteractions`` used to</span>
<span class="sd">            generate the ``pair_coeff`` commands if ``pair_coeff_cmds`` is not</span>
<span class="sd">            passed.</span>
<span class="sd">        pair_coeff_cmds : list of str</span>
<span class="sd">            A `list` of ``pair_coeff`` commands for each ``atom_type`` pair to</span>
<span class="sd">            be set individually in the LAMMPS interface.</span>
<span class="sd">            NOTE: the ``Coulombic`` for the appropriate ``atom_type`` pairs are</span>
<span class="sd">            also set in this method.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">pair_coeff_cmds</span><span class="p">:</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">pair_coeff_cmds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pair_commands</span><span class="p">(</span><span class="n">universe</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="n">pair_coeff_cmds</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lmp</span><span class="o">.</span><span class="n">pair_coeff</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_modify_nonbonded_styles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pair_mods</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Applies modifications to nonbonded ``pair_styles``, such as the VdW tail</span>
<span class="sd">        correction or setting a mixing style for interactions acting on unlike</span>
<span class="sd">        ``atom_type`` pairs</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        pair_mods : list</span>
<span class="sd">            A `list` of `list` which are valid ``pair_modify`` commands</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># MDMC only allows nonbonding mixing on all NonbondedInteractions or</span>
        <span class="c1"># none</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nonbonded_mix</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lmp</span><span class="o">.</span><span class="n">pair_modify</span><span class="p">(</span><span class="s1">&#39;mix&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nonbonded_mix</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">mod</span> <span class="ow">in</span> <span class="n">pair_mods</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lmp</span><span class="o">.</span><span class="n">pair_modify</span><span class="p">(</span><span class="s1">&#39;pair&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">mod</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_create_bonded_interactions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lmp_name</span><span class="p">,</span> <span class="n">bonded_interactions</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates coefficients and new bonded interactions in LAMMPS, and fills</span>
<span class="sd">        the relevant ``BondedInteraction`` ID (e.g. ``self.bond_ID`` for bonds,</span>
<span class="sd">        ``self.angle_ID`` for angles) `dict` with</span>
<span class="sd">        ``bonded_interaction``: ``ID pairs``</span>

<span class="sd">        This generic method can be used for bonds, angles, dihedrals (proper),</span>
<span class="sd">        and impropers. It can only be used for a single type of</span>
<span class="sd">        ``bonded_interactions`` (e.g. only bonds)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        lmp_name : str</span>
<span class="sd">            The name of the bonded interaction type used for setting coeffs in</span>
<span class="sd">            LAMMPS. This must be one of: ``bond``, ``angle``, ``dihedral``,</span>
<span class="sd">            ``improper``. In the case of ``dihedral``, LAMMPS is just referring</span>
<span class="sd">            to proper dihedral interactions.</span>
<span class="sd">        bonded_interactions : list of bonded_interactions (or single type)</span>
<span class="sd">            ``BondedInteractions`` which will be created in LAMMPS. This list</span>
<span class="sd">            must only contain a single type of ``bonded_interactions`` (e.g.</span>
<span class="sd">            only bonds), which must correspond to ``lmp_name``.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">special</span> <span class="o">=</span> <span class="s1">&#39;no&#39;</span>
        <span class="n">ID_attr</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">_ID&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lmp_name</span><span class="p">)</span>
                          <span class="k">if</span> <span class="n">lmp_name</span> <span class="o">!=</span> <span class="s1">&#39;dihedral&#39;</span> <span class="k">else</span> <span class="s1">&#39;proper_ID&#39;</span><span class="p">)</span>
        <span class="n">coeff_function</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lmp</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">_coeff&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lmp_name</span><span class="p">))</span>
        <span class="c1"># If bonds already exist, new bond IDs are generated from lowest unused</span>
        <span class="c1"># integer</span>
        <span class="k">if</span> <span class="n">ID_attr</span><span class="p">:</span>
            <span class="n">start</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">ID_attr</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">start</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">ID</span><span class="p">,</span> <span class="n">b_i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">bonded_interactions</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">):</span>
            <span class="c1"># Create the bonded interaction coefficients</span>
            <span class="n">coeff_function</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span> <span class="o">*</span><span class="n">parse_bonded_coefficients</span><span class="p">(</span><span class="n">b_i</span><span class="p">))</span>

            <span class="c1"># Relate each bonded interaction with its ID</span>
            <span class="n">ID_attr</span><span class="p">[</span><span class="n">b_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ID</span>

            <span class="c1"># Create the bonded_interactions</span>
            <span class="c1"># Special triggers the internal interaction list in LAMMPS</span>
            <span class="c1"># This must at least occur at the end, and is an expensive</span>
            <span class="c1"># operation</span>
            <span class="k">if</span> <span class="n">b_i</span> <span class="ow">is</span> <span class="n">bonded_interactions</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">special</span> <span class="o">=</span> <span class="s1">&#39;yes&#39;</span>

            <span class="c1"># LAMMPS create_bonds is used for creating all types of bonded</span>
            <span class="c1"># interactions, by appending the lmp_name to &#39;single/&#39;</span>
            <span class="n">c_b_type</span> <span class="o">=</span> <span class="s1">&#39;single/</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lmp_name</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">atom_tpl</span> <span class="ow">in</span> <span class="n">b_i</span><span class="o">.</span><span class="n">atoms</span><span class="p">:</span>
                <span class="n">atom_IDs</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">atom_dict</span><span class="p">[</span><span class="n">atom</span><span class="p">]</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">atom_tpl</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lmp</span><span class="o">.</span><span class="n">create_bonds</span><span class="p">(</span><span class="n">c_b_type</span><span class="p">,</span>
                                      <span class="n">ID</span><span class="p">,</span>
                                      <span class="o">*</span><span class="n">atom_IDs</span><span class="p">,</span>
                                      <span class="s1">&#39;special&#39;</span><span class="p">,</span>
                                      <span class="n">special</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_update_bonded_interactions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lmp_name</span><span class="p">,</span> <span class="n">bonded_interactions</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Updates the bonded interaction coefficients, which are then applied to</span>
<span class="sd">        any bonded interactions which have previously been set</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        lmp_name : str</span>
<span class="sd">            The name of the bonded interaction type used for setting coeffs in</span>
<span class="sd">            LAMMPS. This must be one of: ``bond``, ``angle``, ``dihedral``,</span>
<span class="sd">            ``improper``. In the case of ``dihedral``, LAMMPS is just referring</span>
<span class="sd">            to proper dihedral interactions.</span>
<span class="sd">        bonded_interactions : list of BondedInteractions</span>
<span class="sd">            ``BondedInteractions`` which will be updated in LAMMPS. This list</span>
<span class="sd">            must only contain a single type of ``bonded_interactions`` (e.g.</span>
<span class="sd">            only bonds), which must correspond to ``lmp_name``.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Get LAMMPS function for setting bonded interaction attributes (e.g.</span>
        <span class="c1"># bond_coeff)</span>
        <span class="n">coeff_function</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lmp</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">_coeff&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lmp_name</span><span class="p">))</span>
        <span class="c1"># Get ID dict attribute from self (e.g. bond_ID)</span>
        <span class="n">b_i_IDs</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">_ID&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lmp_name</span><span class="p">)</span>
                          <span class="k">if</span> <span class="n">lmp_name</span> <span class="o">!=</span> <span class="s1">&#39;dihedral&#39;</span> <span class="k">else</span> <span class="s1">&#39;proper_ID&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">b_i</span> <span class="ow">in</span> <span class="n">bonded_interactions</span><span class="p">:</span>
            <span class="n">coeff_function</span><span class="p">(</span><span class="n">b_i_IDs</span><span class="p">[</span><span class="n">b_i</span><span class="p">],</span> <span class="o">*</span><span class="n">parse_bonded_coefficients</span><span class="p">(</span><span class="n">b_i</span><span class="p">))</span>

<div class="viewcode-block" id="LAMMPSUniverse.apply_constraints"><a class="viewcode-back" href="../../../../pages/modules/md/engine_facades/lammps_engine.html#MDMC.MD.engine_facades.lammps_engine.LAMMPSUniverse.apply_constraints">[docs]</a>    <span class="k">def</span> <span class="nf">apply_constraints</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds a constraint ``fix`` to LAMMPS for all bonds and bond angles which</span>
<span class="sd">        are constrained</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Sort bonded interactions in the Universe which are constrained into</span>
        <span class="c1"># bonds and angles</span>
        <span class="n">b_inters</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">universe</span><span class="o">.</span><span class="n">bonded_interactions</span><span class="p">)</span>
        <span class="n">bonds</span><span class="p">,</span> <span class="n">angles</span> <span class="o">=</span> <span class="n">partition_interactions</span><span class="p">([</span><span class="n">inter</span> <span class="k">for</span> <span class="n">inter</span>
                                                <span class="ow">in</span> <span class="n">b_inters</span>
                                                <span class="k">if</span> <span class="n">inter</span><span class="o">.</span><span class="n">constrained</span><span class="p">],</span>
                                               <span class="p">[</span><span class="s1">&#39;Bond&#39;</span><span class="p">,</span> <span class="s1">&#39;BondAngle&#39;</span><span class="p">],</span> <span class="n">lst</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">algorithm</span> <span class="o">=</span> <span class="n">parse_constraint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">universe</span><span class="o">.</span><span class="n">constraint_algorithm</span><span class="p">,</span>
                                     <span class="n">bonds</span><span class="o">=</span><span class="n">bonds</span><span class="p">,</span> <span class="n">bond_ID_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bond_ID</span><span class="p">,</span>
                                     <span class="n">angles</span><span class="o">=</span><span class="n">angles</span><span class="p">,</span> <span class="n">angle_ID_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">angle_ID</span><span class="p">)</span>

        <span class="c1"># Create a group from all of the atom types in the constrained bonds and</span>
        <span class="c1"># angles - the fix will be applied to this group. Applying constraint</span>
        <span class="c1"># fix only to this group improves performance.</span>
        <span class="c1"># chain is used to flatten inter.atoms, which is a list of tuples</span>
        <span class="n">atom_types</span> <span class="o">=</span> <span class="p">{</span><span class="n">atom</span><span class="o">.</span><span class="n">atom_type</span> <span class="k">for</span> <span class="n">inter</span> <span class="ow">in</span> <span class="n">bonds</span><span class="o">+</span><span class="n">angles</span>
                      <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">(</span><span class="n">inter</span><span class="o">.</span><span class="n">atoms</span><span class="p">)}</span>
        <span class="n">constrain_group</span> <span class="o">=</span> <span class="s1">&#39;constrain_group&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lmp</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="n">constrain_group</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">atom_types</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lmp</span><span class="o">.</span><span class="n">fix</span><span class="p">(</span><span class="s1">&#39;constrain&#39;</span><span class="p">,</span> <span class="n">constrain_group</span><span class="p">,</span> <span class="o">*</span><span class="n">algorithm</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="LAMMPSSimulation"><a class="viewcode-back" href="../../../../pages/modules/md/engine_facades/lammps_engine.html#MDMC.MD.engine_facades.lammps_engine.LAMMPSSimulation">[docs]</a><span class="nd">@repr_decorator</span><span class="p">(</span><span class="s1">&#39;universe&#39;</span><span class="p">,</span> <span class="s1">&#39;time_step&#39;</span><span class="p">,</span> <span class="s1">&#39;traj_step&#39;</span><span class="p">,</span> <span class="s1">&#39;skin&#39;</span><span class="p">,</span> <span class="s1">&#39;neighbor_steps&#39;</span><span class="p">,</span>
                <span class="s1">&#39;lin_momentum_steps&#39;</span><span class="p">,</span> <span class="s1">&#39;ang_momentum_steps&#39;</span><span class="p">,</span> <span class="s1">&#39;ensemble&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">LAMMPSSimulation</span><span class="p">(</span><span class="n">PyLammpsAttribute</span><span class="p">):</span>
    <span class="c1"># Class has to maintain a lot of state (attributes) as PyLammps class does</span>
    <span class="c1"># not</span>
    <span class="c1">#pylint: disable=too-many-instance-attributes</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The attributes and methods related running a simulation in LAMMPS using a</span>
<span class="sd">    ``LAMMPSUniverse`` object</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    universe : Universe</span>
<span class="sd">        The MDMC ``Universe`` used to create the ``LAMMPSUniverse``.</span>
<span class="sd">    traj_step : int</span>
<span class="sd">        How many steps the simulation should take between dumping each</span>
<span class="sd">        ``Trajectory`` frame</span>
<span class="sd">    time_step : float, optional</span>
<span class="sd">        Simulation timestep in ``fs``, default is ``1.``</span>
<span class="sd">    lmp : PyLammps, optional</span>
<span class="sd">        Set the ``lmp`` attribute to a ``PyLammps`` object. Default is `None`,</span>
<span class="sd">        which results in a new ``PyLammps`` object being initialised.</span>
<span class="sd">    **settings</span>
<span class="sd">        ``temperature`` (`float`)</span>
<span class="sd">        ``skin`` (`float`)</span>
<span class="sd">        ``neighbor_steps`` (`int`)</span>
<span class="sd">        ``remove_linear_momentum`` (`int`)</span>
<span class="sd">        ``remove_angular_momentum`` (`int`)</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    universe : Universe</span>
<span class="sd">        An MDMC ``Universe`` object.</span>
<span class="sd">    traj_step : int</span>
<span class="sd">        Number of simulation steps that elapse between the ``Trajectory`` being</span>
<span class="sd">        stored.</span>
<span class="sd">    ensemble : Ensemble</span>
<span class="sd">        Simulation ensemble, which applies a ``thermostat`` and ``barostat``.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">universe</span><span class="p">,</span> <span class="n">traj_step</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">time_step</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.</span><span class="p">,</span> <span class="n">lmp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">):</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">lmp</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;atom_style&#39;</span><span class="p">,</span> <span class="s1">&#39;full&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">universe</span> <span class="o">=</span> <span class="n">universe</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ensemble</span> <span class="o">=</span> <span class="n">Ensemble</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lmp</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">temperature</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;temperature&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">traj_step</span> <span class="o">=</span> <span class="n">traj_step</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_step</span> <span class="o">=</span> <span class="n">time_step</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">skin</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;skin&#39;</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">neighbor_steps</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;neighbor_steps&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Setting _lin_momentum_steps and _ang_momentum_steps allows</span>
        <span class="c1"># _set_momentum_removers to be called when setting</span>
        <span class="c1"># self.lin_momentum_steps and self.ang_momentum_steps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lin_momentum_steps</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ang_momentum_steps</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lin_momentum_steps</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;remove_linear_momentum&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ang_momentum_steps</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;remove_angular_momentum&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_set_kspace_solver</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">time_step</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get or set the simulation time step in ``fs``</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        `float`</span>
<span class="sd">            Simulation time step in ``fs``</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_time_step</span>

    <span class="nd">@time_step</span><span class="o">.</span><span class="n">setter</span>
    <span class="nd">@unit_decorator</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">units</span><span class="o">.</span><span class="n">TIME</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">time_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_time_step</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Set the timestep in LAMMPS wrapper</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lmp</span><span class="o">.</span><span class="n">timestep</span><span class="p">(</span><span class="n">convert_unit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_time_step</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">temperature</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get or set the temperature of the simulation in ``K``</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        `float`</span>
<span class="sd">            Temperature in ``K``</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_temperature</span>

    <span class="nd">@temperature</span><span class="o">.</span><span class="n">setter</span>
    <span class="nd">@unit_decorator</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">units</span><span class="o">.</span><span class="n">TEMPERATURE</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">temperature</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_temperature</span> <span class="o">=</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ensemble</span><span class="o">.</span><span class="n">temperature</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Set the initial temperature in the LAMMPS wrapper</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">system_state</span><span class="o">.</span><span class="n">natoms</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">zero_velocity</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">velocity</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                                <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">universe</span><span class="o">.</span><span class="n">atoms</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">zero_velocity</span><span class="p">):</span>
                    <span class="c1"># If we have not set any velocities (they are all the default value of zero)</span>
                    <span class="c1"># then &quot;create&quot; a velocity for each atom</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">lmp</span><span class="o">.</span><span class="n">velocity</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="s1">&#39;create&#39;</span><span class="p">,</span>
                                      <span class="n">convert_unit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_temperature</span><span class="p">),</span>
                                      <span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">9999</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">zero_velocity</span><span class="p">):</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Some but not all atom velocities set. Atoms with non-zero velocity&#39;</span>
                               <span class="s1">&#39; will be re-scaled to match target temperature, atoms with zero &#39;</span>
                               <span class="s1">&#39;velocity will remain stationary.&#39;</span><span class="p">)</span>
                        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="c1"># If we have set velocities then &quot;scale&quot; the velocities we have to the correct</span>
                    <span class="c1"># temperature</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">lmp</span><span class="o">.</span><span class="n">velocity</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="s1">&#39;scale&#39;</span><span class="p">,</span> <span class="n">convert_unit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_temperature</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pressure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get or set the pressure of the simulation in ``atm``</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        `float`</span>
<span class="sd">            Pressure in ``atm``</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensemble</span><span class="o">.</span><span class="n">pressure</span>

    <span class="nd">@pressure</span><span class="o">.</span><span class="n">setter</span>
    <span class="nd">@unit_decorator</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">units</span><span class="o">.</span><span class="n">PRESSURE</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">pressure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ensemble</span><span class="o">.</span><span class="n">pressure</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">thermostat</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get or set the string which specifies the thermostat</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        `str`</span>
<span class="sd">            The thermostat name</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensemble</span><span class="o">.</span><span class="n">thermostat</span>

    <span class="nd">@thermostat</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">thermostat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ensemble</span><span class="o">.</span><span class="n">thermostat</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">barostat</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get or set the string which specifies the barostat</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        `str`</span>
<span class="sd">            The barostat name</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensemble</span><span class="o">.</span><span class="n">barostat</span>

    <span class="nd">@barostat</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">barostat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ensemble</span><span class="o">.</span><span class="n">barostat</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">skin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get or set the skin distance in ``Ang``</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        `float`</span>
<span class="sd">            The skin distance in ``Ang``. This distance plus the force</span>
<span class="sd">            ``cutoff`` distance determines which atom pairs are stored in the</span>
<span class="sd">            neighbor list.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_skin</span>

    <span class="nd">@skin</span><span class="o">.</span><span class="n">setter</span>
    <span class="nd">@unit_decorator</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">units</span><span class="o">.</span><span class="n">LENGTH</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">skin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_skin</span> <span class="o">=</span> <span class="n">value</span>
        <span class="c1"># Set the neighor list parameters in the LAMMPS wrapper</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lmp</span><span class="o">.</span><span class="n">neighbor</span><span class="p">(</span><span class="n">convert_unit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_skin</span><span class="p">),</span> <span class="s1">&#39;bin&#39;</span><span class="p">)</span>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">neighbor_steps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get or set the number of steps between neighbor list updates</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        `int`</span>
<span class="sd">            Number of steps between neighbor list updates</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_neighbor_steps</span>

    <span class="nd">@neighbor_steps</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">neighbor_steps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_neighbor_steps</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Set the modifiers to the neighbor list in the LAMMPS wrapper</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lmp</span><span class="o">.</span><span class="n">neigh_modify</span><span class="p">(</span><span class="s1">&#39;every&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">neighbor_steps</span><span class="p">),</span> <span class="s1">&#39;delay&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                                  <span class="s1">&#39;check&#39;</span><span class="p">,</span> <span class="s1">&#39;yes&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">lin_momentum_steps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get or set the number of steps between resetting the linear momentum</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        `int`</span>
<span class="sd">            Number of steps between the linear momentum being removed</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lin_momentum_steps</span>

    <span class="nd">@lin_momentum_steps</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">lin_momentum_steps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_lin_momentum_steps</span> <span class="o">=</span> <span class="n">value</span>
        <span class="c1"># Set the momentum removers in the LAMMPS wrapper</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_momentum_removers</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ang_momentum_steps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get or set the number of steps between resetting the angular momentum</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        `int`</span>
<span class="sd">            Number of steps between the angular momentum being removed</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ang_momentum_steps</span>

    <span class="nd">@ang_momentum_steps</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">ang_momentum_steps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ang_momentum_steps</span> <span class="o">=</span> <span class="n">value</span>
        <span class="c1"># Set the momentum removers in the LAMMPS wrapper</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_momentum_removers</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_set_momentum_removers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates the ``fixes`` in LAMMPS which remove the linear and angular</span>
<span class="sd">        momentum of the simulation</span>

<span class="sd">        Removes all pre-existing momentum remover ``fixes``</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fix_names</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;RemoveMomentum&#39;</span><span class="p">,</span> <span class="s1">&#39;RemoveLinearMomentum&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;RemoveAngularMomentum&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lmp</span><span class="o">.</span><span class="n">unfix</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">system_state</span><span class="o">.</span><span class="n">natoms</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lin_momentum_steps</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">ang_momentum_steps</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lmp</span><span class="o">.</span><span class="n">fix</span><span class="p">(</span><span class="s1">&#39;RemoveMomentum&#39;</span><span class="p">,</span> <span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="s1">&#39;momentum&#39;</span><span class="p">,</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">lin_momentum_steps</span><span class="p">,</span> <span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;angular&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lin_momentum_steps</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">lmp</span><span class="o">.</span><span class="n">fix</span><span class="p">(</span><span class="s1">&#39;RemoveLinearMomentum&#39;</span><span class="p">,</span> <span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="s1">&#39;momentum&#39;</span><span class="p">,</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">lin_momentum_steps</span><span class="p">,</span> <span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ang_momentum_steps</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">lmp</span><span class="o">.</span><span class="n">fix</span><span class="p">(</span><span class="s1">&#39;RemoveAngularMomentum&#39;</span><span class="p">,</span> <span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="s1">&#39;momentum&#39;</span><span class="p">,</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">ang_momentum_steps</span><span class="p">,</span> <span class="s1">&#39;angular&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_kspace_solver</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a k-space solver in LAMMPS using ``kspace_style``, if one is</span>
<span class="sd">        required</span>

<span class="sd">        Uses either the ``kspace_solver``, the ``electrostatic_solver`` or both</span>
<span class="sd">        the ``electrostatic_solver`` and ``dispersive_solver`` attribute of the</span>
<span class="sd">        MDMC ``Universe`` to set the ``kspace_style``. Note that LAMMPS does not</span>
<span class="sd">        support different electrostatic and dispersive solvers. Setting with</span>
<span class="sd">        equivalent electrostatic and dispserive solvers is equivalent to setting</span>
<span class="sd">        with ``kspace_solver``. LAMMPS also does not support just applying a</span>
<span class="sd">        dispersive solver.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        TypeError</span>
<span class="sd">            If ``self.universe`` has both a ``kspace_solver`` and either an</span>
<span class="sd">            ``electrostatic_solver`` or a ``dispersive_solver``.</span>
<span class="sd">        TypeError</span>
<span class="sd">            If ``self.universe`` has a different ``electrostatic_solver`` and</span>
<span class="sd">            ``dispersive_solver``.</span>
<span class="sd">        TypeError</span>
<span class="sd">            If ``self.universe`` only has a ``dispersive_solver``.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">kspace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">universe</span><span class="o">.</span><span class="n">kspace_solver</span>
        <span class="n">electrostatic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">universe</span><span class="o">.</span><span class="n">electrostatic_solver</span>
        <span class="n">dispersive</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">universe</span><span class="o">.</span><span class="n">dispersive_solver</span>


        <span class="c1"># LAMMPS supports a single kspace solver, which can be taken from kspace</span>
        <span class="c1"># electrostatic or dispersive solvers of the universe. If any other</span>
        <span class="c1"># solver is defined as well as kspace (which effecitvely defines both</span>
        <span class="c1"># other solves), raise an error.</span>
        <span class="k">if</span> <span class="n">kspace</span> <span class="ow">and</span> <span class="p">(</span><span class="n">electrostatic</span> <span class="ow">or</span> <span class="n">dispersive</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;kspace solver cannot be applied in conjunction&#39;</span>
                            <span class="s1">&#39; with either electrostatic or dispersive solvers&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">kspace</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lmp</span><span class="o">.</span><span class="n">kspace_style</span><span class="p">(</span><span class="o">*</span><span class="n">parse_kspace_solver</span><span class="p">(</span><span class="n">kspace</span><span class="p">))</span>
        <span class="c1"># If either an electrostatic or a dispersive solver has been defined,</span>
        <span class="c1"># use this. If both have been defined, this is valid as long as they are</span>
        <span class="c1"># equivalent.  If not, raise an error.</span>
        <span class="k">if</span> <span class="n">electrostatic</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dispersive</span> <span class="ow">and</span> <span class="n">electrostatic</span> <span class="o">!=</span> <span class="n">dispersive</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;LAMMPS only supports a single solver, so if&#39;</span>
                                <span class="s1">&#39; both dispersive and electrostatic solvers&#39;</span>
                                <span class="s1">&#39; have been defined then they must be&#39;</span>
                                <span class="s1">&#39; equivalent&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lmp</span><span class="o">.</span><span class="n">kspace_style</span><span class="p">(</span><span class="o">*</span><span class="n">parse_kspace_solver</span><span class="p">(</span><span class="n">electrostatic</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">dispersive</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;LAMMPS does not support only applying a dispersive&#39;</span>
                            <span class="s1">&#39; solver - it must be applied in conjunction with&#39;</span>
                            <span class="s1">&#39; an electrostatic solver&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Ensemble"><a class="viewcode-back" href="../../../../pages/modules/md/engine_facades/lammps_engine.html#MDMC.MD.engine_facades.lammps_engine.Ensemble">[docs]</a><span class="nd">@repr_decorator</span><span class="p">(</span><span class="s1">&#39;temperature&#39;</span><span class="p">,</span> <span class="s1">&#39;pressure&#39;</span><span class="p">,</span> <span class="s1">&#39;thermostat&#39;</span><span class="p">,</span> <span class="s1">&#39;barostat&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">Ensemble</span><span class="p">(</span><span class="n">PyLammpsAttribute</span><span class="p">):</span>
    <span class="c1"># Class has to maintain a lot of state (attributes) as PyLammps class does</span>
    <span class="c1"># not</span>
    <span class="c1">#pylint: disable=too-many-instance-attributes</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A thermodynamic ensemble determined by applying a thermostat and/or barostat</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    lmp : PyLammps</span>
<span class="sd">        Set the ``lmp`` attribute to a ``PyLammps`` object.</span>
<span class="sd">    temperature : float, optional</span>
<span class="sd">        Thermostat temperature. Default is `None`, which is only valid if a</span>
<span class="sd">        ``thermostat`` is also `None`.</span>
<span class="sd">    pressure : float, optional</span>
<span class="sd">        Barostat pressure. Default is `None`, which is only valid if a</span>
<span class="sd">        ``barostat`` is also `None`.</span>
<span class="sd">    thermostat : str</span>
<span class="sd">        Name of a thermostat to be applied.</span>
<span class="sd">    barostat : str</span>
<span class="sd">        Name of a barostat to be applied.</span>
<span class="sd">    **settings</span>
<span class="sd">        ``time_step`` (`float`)</span>
<span class="sd">        ``t_damp`` (`int`)</span>
<span class="sd">        ``p_damp`` (`int`)</span>
<span class="sd">        ``t_window`` (`float`)</span>
<span class="sd">        ``t_fraction`` (`float`)</span>
<span class="sd">        ``rescale_step`` (`int`)</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    rescale_step : int</span>
<span class="sd">        Number of steps between applying temperature rescaling. This only</span>
<span class="sd">        applies to rescale thermostats.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lmp</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pressure</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">thermostat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">barostat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">):</span>

        <span class="c1"># Requires a lmp object as thermostats cannot be applied before</span>
        <span class="c1"># configuration is defined</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">lmp</span><span class="p">)</span>
        <span class="c1"># Setting _thermostat and _barostat allows apply_ensemble_fixes to be</span>
        <span class="c1"># called when setting self.temperature and self.pressure</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_thermostat</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_barostat</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">temperature</span> <span class="o">=</span> <span class="n">temperature</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pressure</span> <span class="o">=</span> <span class="n">pressure</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">time_step</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;time_step&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t_damp</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;t_damp&#39;</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p_damp</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;p_damp&#39;</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t_window</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;t_window&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t_fraction</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;t_fraction&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rescale_step</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;rescale_step&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">thermostat</span> <span class="o">=</span> <span class="n">thermostat</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">barostat</span> <span class="o">=</span> <span class="n">barostat</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">time_step</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get or set the simulation time step in ``fs``</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_time_step</span>

    <span class="nd">@time_step</span><span class="o">.</span><span class="n">setter</span>
    <span class="nd">@unit_decorator</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">units</span><span class="o">.</span><span class="n">TIME</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">time_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_time_step</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">temperature</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get or set the temperature of the simulation in ``K``</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_temperature</span>

    <span class="nd">@temperature</span><span class="o">.</span><span class="n">setter</span>
    <span class="nd">@unit_decorator</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">units</span><span class="o">.</span><span class="n">TEMPERATURE</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">temperature</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_temperature</span> <span class="o">=</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">apply_ensemble_fixes</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pressure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get or set the pressure of the simulation in ``atm``</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pressure</span>

    <span class="nd">@pressure</span><span class="o">.</span><span class="n">setter</span>
    <span class="nd">@unit_decorator</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">units</span><span class="o">.</span><span class="n">PRESSURE</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">pressure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_pressure</span> <span class="o">=</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">apply_ensemble_fixes</span><span class="p">()</span>

    <span class="c1"># Unit has to be applied to getter due to operation in setter</span>
    <span class="nd">@property</span>
    <span class="nd">@unit_decorator_getter</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">units</span><span class="o">.</span><span class="n">TIME</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">t_damp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get or set the number of time steps over which the ``temperature`` is</span>
<span class="sd">        relaxed</span>

<span class="sd">        Required for ``Nose-Hoover``, ``Berendsen`` and ``Langevin``</span>
<span class="sd">        thermostats. The ``time_step`` must have been set before ``t_damp``.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        `int`</span>
<span class="sd">            Number of time steps</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        AttributeError</span>
<span class="sd">            If ``self.time_step`` has not been set.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># t_damp is stored in units of time - convert back to number of steps</span>
        <span class="c1"># here</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_t_damp</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_step</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_t_damp</span>

    <span class="nd">@t_damp</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">t_damp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># LAMMPS requires t_damp to be given in units of time, but it is</span>
            <span class="c1"># more natural to give it in units of steps - convert between them</span>
            <span class="c1"># here</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_t_damp</span> <span class="o">=</span> <span class="n">value</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_step</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_t_damp</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s1">&#39;the time_step attribute must be set&#39;</span>
                                     <span class="s1">&#39; before t_damp&#39;</span><span class="p">)</span>

    <span class="c1"># Unit has to be applied to getter due to operation in setter</span>
    <span class="nd">@property</span>
    <span class="nd">@unit_decorator_getter</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">units</span><span class="o">.</span><span class="n">TIME</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">p_damp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get or set the number of time steps over which the ``pressure`` is</span>
<span class="sd">        relaxed</span>

<span class="sd">        Required for ``Nose-Hoover`` or ``Berendsen`` barostats. The</span>
<span class="sd">        ``time_step`` must have been set before ``p_damp``.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        `int`</span>
<span class="sd">            Number of time steps</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        AttributeError</span>
<span class="sd">            If ``self.time_step`` has not been set.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># p_damp is stored in units of time - convert back to number of steps</span>
        <span class="c1"># here</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_p_damp</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_step</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_p_damp</span>

    <span class="nd">@p_damp</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">p_damp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># LAMMPS requires p_damp to be given in units of time, but it is</span>
            <span class="c1"># more natural to give it in units of steps - convert between them</span>
            <span class="c1"># here</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_p_damp</span> <span class="o">=</span> <span class="n">value</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_step</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_p_damp</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s1">&#39;the time_step attribute must be set&#39;</span>
                                     <span class="s1">&#39; before p_damp&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">t_fraction</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get or set the fraction by which the ``temperature`` is rescaled to the</span>
<span class="sd">        target temperature</span>

<span class="sd">        This is required for the rescale ``thermostat``.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        `float`</span>
<span class="sd">            Fraction (i.e. between 0.0 and 1.0 inclusive) by which the</span>
<span class="sd">            ``temperature`` is rescaled</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If set to a value outside of 0.0 and 1.0 inclusive.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_t_fraction</span>

    <span class="nd">@t_fraction</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">t_fraction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>

        <span class="c1"># Must be a fraction</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="mf">0.</span> <span class="o">&lt;=</span> <span class="n">value</span> <span class="o">&lt;=</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_t_fraction</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;the t_fraction must be between 0.0 and 1.0&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">t_window</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get or set the ``temperature`` range in ``K`` in which the</span>
<span class="sd">        ``temperature`` is not rescaled</span>

<span class="sd">        This only applies to rescale ``thermostats``.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        `float`</span>
<span class="sd">            temperature range in ``K``</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_t_window</span>

    <span class="nd">@t_window</span><span class="o">.</span><span class="n">setter</span>
    <span class="nd">@unit_decorator</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">units</span><span class="o">.</span><span class="n">TEMPERATURE</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">t_window</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_t_window</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">thermostat</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get or set the `str` which specifies the thermostat</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        AttributeError</span>
<span class="sd">            If ``self.temperature`` has not been set.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_thermostat</span>

    <span class="nd">@thermostat</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">thermostat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">value</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">temperature</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s1">&#39;all ensembles with a thermostat must have a&#39;</span>
                                 <span class="s1">&#39; temperature&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_thermostat</span> <span class="o">=</span> <span class="n">value</span>
        <span class="c1"># Set the thermostat and barostat in LAMMPS wrapper</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">apply_ensemble_fixes</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">barostat</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get or set the `str` which specifies the barostat</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        AttributeError</span>
<span class="sd">            If ``self.pressure`` has not been set.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_barostat</span>

    <span class="nd">@barostat</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">barostat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">value</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pressure</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s1">&#39;all ensembles with a barostat must have a&#39;</span>
                                 <span class="s1">&#39; pressure&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_barostat</span> <span class="o">=</span> <span class="n">value</span>
        <span class="c1"># Set the thermostat and barostat in LAMMPS wrapper</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">apply_ensemble_fixes</span><span class="p">()</span>

<div class="viewcode-block" id="Ensemble.remove_ensemble_fixes"><a class="viewcode-back" href="../../../../pages/modules/md/engine_facades/lammps_engine.html#MDMC.MD.engine_facades.lammps_engine.Ensemble.remove_ensemble_fixes">[docs]</a>    <span class="k">def</span> <span class="nf">remove_ensemble_fixes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Removes all LAMMPS ``fixes`` relating to the ensemble i.e. removes all</span>
<span class="sd">        thermostats and barostats</span>

<span class="sd">        This must be done before thermostat and barostat fixes are added, so</span>
<span class="sd">        that there is no conflict with existing thermostat and barostats</span>
<span class="sd">        ``fixes``. It is also required for Shake and Rattle ``fixes`` which</span>
<span class="sd">        cannot be added after barostat fixes have been applied.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fix_names</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;nve&#39;</span><span class="p">,</span> <span class="s1">&#39;nvt&#39;</span><span class="p">,</span> <span class="s1">&#39;npt&#39;</span><span class="p">,</span> <span class="s1">&#39;nph&#39;</span><span class="p">,</span> <span class="s1">&#39;t_berendsen&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;p_berendsen&#39;</span><span class="p">,</span> <span class="s1">&#39;langevin&#39;</span><span class="p">,</span> <span class="s1">&#39;rescale&#39;</span><span class="p">]:</span>
                <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> Remove </span><span class="si">%s</span><span class="s1"> fix.&#39;</span><span class="p">,</span>
                             <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span>
                             <span class="n">name</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lmp</span><span class="o">.</span><span class="n">unfix</span><span class="p">(</span><span class="n">name</span><span class="p">)</span></div>

<div class="viewcode-block" id="Ensemble.apply_ensemble_fixes"><a class="viewcode-back" href="../../../../pages/modules/md/engine_facades/lammps_engine.html#MDMC.MD.engine_facades.lammps_engine.Ensemble.apply_ensemble_fixes">[docs]</a>    <span class="k">def</span> <span class="nf">apply_ensemble_fixes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Passes the required LAMMPS ``fixes`` to apply a specific thermodynamic</span>
<span class="sd">        ensemble to the simulation</span>

<span class="sd">        Removes all pre-existing thermostat and barostat fixes</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">remove_ensemble_fixes</span><span class="p">()</span>

        <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> apply_ensemble_fixes before fixes applied:&#39;</span>
                     <span class="s1">&#39; {fixes: </span><span class="si">%s</span><span class="s1">}&#39;</span><span class="p">,</span>
                     <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">fixes</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">thermostat</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">barostat</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lmp</span><span class="o">.</span><span class="n">fix</span><span class="p">(</span><span class="s1">&#39;nve&#39;</span><span class="p">,</span> <span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="s1">&#39;nve&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">thermostat</span><span class="p">:</span>
                <span class="n">temp</span> <span class="o">=</span> <span class="n">convert_unit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">temperature</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">thermostat</span> <span class="o">!=</span> <span class="s1">&#39;rescale&#39;</span><span class="p">:</span>
                    <span class="n">t_damp</span> <span class="o">=</span> <span class="n">convert_unit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t_damp</span><span class="p">)</span>
                    <span class="n">thermo_parameters</span> <span class="o">=</span> <span class="p">[</span><span class="n">temp</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="n">t_damp</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">barostat</span><span class="p">:</span>
                <span class="n">press</span> <span class="o">=</span> <span class="n">convert_unit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pressure</span><span class="p">)</span>
                <span class="n">p_damp</span> <span class="o">=</span> <span class="n">convert_unit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p_damp</span><span class="p">)</span>
                <span class="n">press_parameters</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;iso&#39;</span><span class="p">,</span> <span class="n">press</span><span class="p">,</span> <span class="n">press</span><span class="p">,</span> <span class="n">p_damp</span><span class="p">]</span>

            <span class="c1"># Apply thermostat</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">thermostat</span> <span class="o">==</span> <span class="s1">&#39;nose&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">barostat</span> <span class="o">==</span> <span class="s1">&#39;nose&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">lmp</span><span class="o">.</span><span class="n">fix</span><span class="p">(</span><span class="s1">&#39;npt&#39;</span><span class="p">,</span> <span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="s1">&#39;npt&#39;</span><span class="p">,</span> <span class="s1">&#39;temp&#39;</span><span class="p">,</span>
                                 <span class="o">*</span><span class="n">thermo_parameters</span> <span class="o">+</span> <span class="n">press_parameters</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">lmp</span><span class="o">.</span><span class="n">fix</span><span class="p">(</span><span class="s1">&#39;nvt&#39;</span><span class="p">,</span> <span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="s1">&#39;nvt&#39;</span><span class="p">,</span> <span class="s1">&#39;temp&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">thermo_parameters</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">thermostat</span> <span class="o">==</span> <span class="s1">&#39;berendsen&#39;</span><span class="p">:</span>
                <span class="c1"># berendsen does not do time integration so also requires nve</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lmp</span><span class="o">.</span><span class="n">fix</span><span class="p">(</span><span class="s1">&#39;nve&#39;</span><span class="p">,</span> <span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="s1">&#39;nve&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lmp</span><span class="o">.</span><span class="n">fix</span><span class="p">(</span><span class="s1">&#39;t_berendsen&#39;</span><span class="p">,</span> <span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="s1">&#39;temp/berendsen&#39;</span><span class="p">,</span>
                             <span class="o">*</span><span class="n">thermo_parameters</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">thermostat</span> <span class="o">==</span> <span class="s1">&#39;langevin&#39;</span><span class="p">:</span>
                <span class="c1"># langevin does not do time integration so also requires nve</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lmp</span><span class="o">.</span><span class="n">fix</span><span class="p">(</span><span class="s1">&#39;nve&#39;</span><span class="p">,</span> <span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="s1">&#39;nve&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lmp</span><span class="o">.</span><span class="n">fix</span><span class="p">(</span><span class="s1">&#39;langevin&#39;</span><span class="p">,</span> <span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="s1">&#39;langevin&#39;</span><span class="p">,</span>
                             <span class="o">*</span><span class="n">thermo_parameters</span> <span class="o">+</span> <span class="p">[</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">9999</span><span class="p">)])</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">thermostat</span> <span class="o">==</span> <span class="s1">&#39;rescale&#39;</span><span class="p">:</span>
                <span class="c1"># temp/rescale does not do time integration so also requires nve</span>
                <span class="n">t_window</span> <span class="o">=</span> <span class="n">convert_unit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t_window</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lmp</span><span class="o">.</span><span class="n">fix</span><span class="p">(</span><span class="s1">&#39;nve&#39;</span><span class="p">,</span> <span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="s1">&#39;nve&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lmp</span><span class="o">.</span><span class="n">fix</span><span class="p">(</span><span class="s1">&#39;rescale&#39;</span><span class="p">,</span> <span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="s1">&#39;temp/rescale&#39;</span><span class="p">,</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">rescale_step</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="n">t_window</span><span class="p">,</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">t_fraction</span><span class="p">)</span>
            <span class="c1"># Apply barostat</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">barostat</span> <span class="o">==</span> <span class="s1">&#39;berendsen&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lmp</span><span class="o">.</span><span class="n">fix</span><span class="p">(</span><span class="s1">&#39;p_berendsen&#39;</span><span class="p">,</span> <span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="s1">&#39;press/berendsen&#39;</span><span class="p">,</span>
                             <span class="o">*</span><span class="n">press_parameters</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">barostat</span> <span class="o">==</span> <span class="s1">&#39;nose&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">thermostat</span> <span class="o">!=</span> <span class="s1">&#39;nose&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;nve&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fix_names</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">lmp</span><span class="o">.</span><span class="n">unfix</span><span class="p">(</span><span class="s1">&#39;nve&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lmp</span><span class="o">.</span><span class="n">fix</span><span class="p">(</span><span class="s1">&#39;nph&#39;</span><span class="p">,</span> <span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="s1">&#39;nph&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">press_parameters</span><span class="p">)</span>

        <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> apply_ensemble_fixes after fixes applied:&#39;</span>
                     <span class="s1">&#39; {fixes: </span><span class="si">%s</span><span class="s1">}&#39;</span><span class="p">,</span>
                     <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">fixes</span><span class="p">)</span></div></div>

<span class="c1"># Define the unit system used in LAMMPS</span>
<span class="c1"># NB: LAMMPS uses deg for angle but radian for derived quantities of angle:</span>
<span class="c1"># e.g. harmonic angle potential strength is in kcal / mol radian ^ 2</span>
<span class="n">SYSTEM</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;LENGTH&#39;</span><span class="p">:</span><span class="n">units</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="s1">&#39;Ang&#39;</span><span class="p">),</span>
    <span class="s1">&#39;TIME&#39;</span><span class="p">:</span><span class="n">units</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="s1">&#39;fs&#39;</span><span class="p">),</span>
    <span class="s1">&#39;MASS&#39;</span><span class="p">:</span><span class="n">units</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="s1">&#39;g&#39;</span><span class="p">)</span> <span class="o">/</span> <span class="n">units</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="s1">&#39;mol&#39;</span><span class="p">),</span>
    <span class="s1">&#39;CHARGE&#39;</span><span class="p">:</span><span class="n">units</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="s1">&#39;e&#39;</span><span class="p">),</span>
    <span class="s1">&#39;ANGLE&#39;</span><span class="p">:</span><span class="n">units</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="s1">&#39;deg&#39;</span><span class="p">),</span>
    <span class="s1">&#39;TEMPERATURE&#39;</span><span class="p">:</span><span class="n">units</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="s1">&#39;K&#39;</span><span class="p">),</span>
    <span class="s1">&#39;ENERGY&#39;</span><span class="p">:</span><span class="n">units</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="s1">&#39;kcal&#39;</span><span class="p">)</span> <span class="o">/</span> <span class="n">units</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="s1">&#39;mol&#39;</span><span class="p">),</span>
    <span class="s1">&#39;FORCE&#39;</span><span class="p">:</span><span class="n">units</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="s1">&#39;kcal&#39;</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">units</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="s1">&#39;Ang&#39;</span><span class="p">)</span> <span class="o">*</span> <span class="n">units</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="s1">&#39;mol&#39;</span><span class="p">)),</span>
    <span class="s1">&#39;PRESSURE&#39;</span><span class="p">:</span><span class="n">units</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="s1">&#39;atm&#39;</span><span class="p">)</span>
<span class="p">}</span>


<div class="viewcode-block" id="convert_unit"><a class="viewcode-back" href="../../../../pages/modules/md/engine_facades/lammps_engine.html#MDMC.MD.engine_facades.lammps_engine.convert_unit">[docs]</a><span class="k">def</span> <span class="nf">convert_unit</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">to_lammps</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Converts between MDMC units and LAMMPS real units</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    value : array_like or float_like</span>
<span class="sd">        The value of the physical property to be converted, in MDMC units.</span>
<span class="sd">        Must derive from either ``ndarray`` or `float`.</span>
<span class="sd">    unit : Unit, optional</span>
<span class="sd">        The unit of the ``value``. If `None`, the ``value`` must possess a</span>
<span class="sd">        ``unit`` attribute i.e. derive from ``UnitFloat`` or ``UnitArray``.</span>
<span class="sd">        Default is `None`.</span>
<span class="sd">    to_lammps : bool, optional</span>
<span class="sd">        If `True` the conversion is from MDMC units to LAMMPS units. Default is</span>
<span class="sd">        `True`.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    `float` or `numpy.ndarray`</span>
<span class="sd">        Value in LAMMPS units if ``to_lammps`` is `True`, otherwise value in</span>
<span class="sd">        MDMC units. Return type is same as ``value`` type.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">expand_components</span><span class="p">(</span><span class="n">unit</span><span class="p">,</span> <span class="n">system</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Expands out the ``components`` of a ``Unit``, so that the ``Unit`` is</span>
<span class="sd">        expressed purely in terms of ``base`` ``Unit`` objects. The only</span>
<span class="sd">        exception to this is ``Unit`` objects which occur in ``System``: these</span>
<span class="sd">        are kept in the `list` of ``components``.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        unit : Unit</span>
<span class="sd">            The ``Unit`` to be expanded out</span>
<span class="sd">        system : dict</span>
<span class="sd">            A `dict` of {``Property``: ``Unit``} pairs, which is used to</span>
<span class="sd">            substitute ``System`` ``Unit`` objects into the expanded</span>
<span class="sd">            ``components``.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        `tuple`</span>
<span class="sd">            A `tuple` of (``num``, ``denom``), where ``num`` is a `list` of all</span>
<span class="sd">            ``base`` ``Unit`` objects in the numerator, and ``denom`` is a</span>
<span class="sd">            `list` of all ``base`` ``Unit`` objects in the denominator</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">is_sublist_of_list</span><span class="p">(</span><span class="n">sub</span><span class="p">,</span> <span class="n">lst</span><span class="p">):</span>

            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Determines if all of the elements in a sublist are in a `list`,</span>
<span class="sd">            including ensuring that any duplicates in the sublist have at least</span>
<span class="sd">            the same number of duplicates in the `list`</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            sub : list</span>
<span class="sd">                The sublist to be tested</span>
<span class="sd">            lst : list</span>
<span class="sd">                The `list` the ``sub`` is tested against</span>

<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            `bool`</span>
<span class="sd">                `True` if all of the elements of ``sub`` are in ``lst``, and</span>
<span class="sd">                `False` if not</span>
<span class="sd">            &quot;&quot;&quot;</span>

            <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="n">sub</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">lst</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">sub</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">remove_components</span><span class="p">(</span><span class="n">remove_comps</span><span class="p">,</span> <span class="n">comps</span><span class="p">):</span>

            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Removes all elements of a `list` of ``components`` from another</span>
<span class="sd">            `list` of ``components``</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            remove_comps : list</span>
<span class="sd">                The ``components`` to be removed</span>
<span class="sd">            comps : list</span>
<span class="sd">                The ``components`` from which ``remove_comps`` is removed</span>

<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            `list`</span>
<span class="sd">                A `list` of ``components`` from which ``remove_comps`` have been</span>
<span class="sd">                removed</span>
<span class="sd">            &quot;&quot;&quot;</span>

            <span class="k">for</span> <span class="n">remove_comp</span> <span class="ow">in</span> <span class="n">remove_comps</span><span class="p">:</span>
                <span class="n">comps</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">remove_comp</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">comps</span>

        <span class="n">num</span><span class="p">,</span> <span class="n">denom</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="c1"># If unit is in system of units, don&#39;t break down to components, as</span>
        <span class="c1"># a unit in the system of units always has a conversion, even if it is</span>
        <span class="c1"># a compound unit.</span>
        <span class="k">if</span> <span class="n">unit</span><span class="o">.</span><span class="n">base</span> <span class="ow">or</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">system</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">num</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># tuple unpacking style below appends to num and denom lists</span>
            <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">unit</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="s1">&#39;numerator&#39;</span><span class="p">]:</span>
                <span class="n">num</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">num</span><span class="p">):],</span> <span class="n">denom</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">denom</span><span class="p">):]</span> <span class="o">=</span> <span class="n">expand_components</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span>
                                                                       <span class="n">system</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">unit</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="s1">&#39;denominator&#39;</span><span class="p">]:</span>
                <span class="n">denom</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">denom</span><span class="p">):],</span> <span class="n">num</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">num</span><span class="p">):]</span> <span class="o">=</span> <span class="n">expand_components</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span>
                                                                       <span class="n">system</span><span class="p">)</span>

            <span class="c1"># Substitute in units rather than separated out components if a unit</span>
            <span class="c1"># exists in the system of units.  This is because the conversion can</span>
            <span class="c1"># always be determined for units in the system of units. Base units</span>
            <span class="c1"># are filtered as they can only replace themselves (as they are</span>
            <span class="c1"># their only component).</span>
            <span class="k">for</span> <span class="n">sys_unit</span> <span class="ow">in</span> <span class="p">(</span><span class="n">unit</span> <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">system</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">unit</span><span class="o">.</span><span class="n">base</span><span class="p">):</span>
                <span class="c1"># while is required for powers of sys_unit, as otherwise only</span>
                <span class="c1"># a single power will be removed</span>
                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">sys_unit_num</span> <span class="o">=</span> <span class="n">sys_unit</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="s1">&#39;numerator&#39;</span><span class="p">]</span>
                    <span class="n">sys_unit_denom</span> <span class="o">=</span> <span class="n">sys_unit</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="s1">&#39;denominator&#39;</span><span class="p">]</span>
                    <span class="c1"># Determine if all of the components of unit are in the</span>
                    <span class="c1"># numerator and denominator lists. If so, remove them and</span>
                    <span class="c1"># replace with the unit in the numerator.</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">is_sublist_of_list</span><span class="p">(</span><span class="n">sys_unit_num</span><span class="p">,</span> <span class="n">num</span><span class="p">)</span> <span class="ow">and</span>
                            <span class="n">is_sublist_of_list</span><span class="p">(</span><span class="n">sys_unit_denom</span><span class="p">,</span> <span class="n">denom</span><span class="p">)):</span>
                        <span class="n">num</span> <span class="o">=</span> <span class="n">remove_components</span><span class="p">(</span><span class="n">sys_unit_num</span><span class="p">,</span> <span class="n">num</span><span class="p">)</span>
                        <span class="n">denom</span> <span class="o">=</span> <span class="n">remove_components</span><span class="p">(</span><span class="n">sys_unit_denom</span><span class="p">,</span> <span class="n">denom</span><span class="p">)</span>
                        <span class="n">num</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sys_unit</span><span class="p">)</span>
                    <span class="c1"># Do the same for the inverse (i.e. unit&#39;s numberator</span>
                    <span class="c1"># components in the denominator list and vice versa). If so,</span>
                    <span class="c1"># remove them and replace with the unit in the denominator.</span>
                    <span class="k">elif</span> <span class="p">(</span><span class="n">is_sublist_of_list</span><span class="p">(</span><span class="n">sys_unit_num</span><span class="p">,</span> <span class="n">denom</span><span class="p">)</span> <span class="ow">and</span>
                          <span class="n">is_sublist_of_list</span><span class="p">(</span><span class="n">sys_unit_denom</span><span class="p">,</span> <span class="n">num</span><span class="p">)):</span>
                        <span class="n">denom</span> <span class="o">=</span> <span class="n">remove_components</span><span class="p">(</span><span class="n">sys_unit_num</span><span class="p">,</span> <span class="n">denom</span><span class="p">)</span>
                        <span class="n">num</span> <span class="o">=</span> <span class="n">remove_components</span><span class="p">(</span><span class="n">sys_unit_denom</span><span class="p">,</span> <span class="n">num</span><span class="p">)</span>
                        <span class="n">denom</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sys_unit</span><span class="p">)</span>
                    <span class="c1"># Breaks if the components of sys_unit are not found in num</span>
                    <span class="c1"># and denom</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">break</span>
        <span class="k">return</span> <span class="n">num</span><span class="p">,</span> <span class="n">denom</span>

    <span class="c1"># If no unit argument is passed, the value must possess a unit</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">unit</span><span class="p">:</span>
        <span class="c1"># If value is unitless, no conversion is required</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">unit</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">unit</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Cannot convert NoneType value&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">value</span>
    <span class="c1"># Expand the unit in terms of its base units (for numerator and denominator)</span>
    <span class="k">if</span> <span class="n">to_lammps</span><span class="p">:</span>
        <span class="c1"># SYSTEM represents the LAMMPS system units, units.SYSTEM the MDMC</span>
        <span class="c1"># system units</span>
        <span class="n">l_sys</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">SYSTEM</span><span class="p">)</span>
        <span class="n">mdmc_sys</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">units</span><span class="o">.</span><span class="n">SYSTEM</span><span class="p">)</span>

        <span class="c1"># For angular potential strength LAMMPS uses units derived from &#39;rad&#39;,</span>
        <span class="c1"># namely &#39;kcal / mol rad^2&#39;, but uses &#39;deg&#39; when measuring angles</span>
        <span class="c1"># themselves. As a result &#39;deg&#39; is recorded as their system unit. In</span>
        <span class="c1"># order to prevent us from erroneously expressing potential strength in</span>
        <span class="c1"># &#39;kcal / mol deg^2&#39;, we must override the LAMMPS system unit for angle</span>
        <span class="c1"># ONLY in the case where we are dealing with angular potential, namely</span>
        <span class="c1"># when the MDMC unit is measuring &#39;energy / angle^2&#39;.</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">unit</span> <span class="ow">in</span> <span class="p">(</span><span class="n">mdmc_sys</span><span class="p">[</span><span class="s1">&#39;ENERGY&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">mdmc_sys</span><span class="p">[</span><span class="s1">&#39;ANGLE&#39;</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span>
                     <span class="n">mdmc_sys</span><span class="p">[</span><span class="s1">&#39;ENERGY&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">units</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="s1">&#39;rad&#39;</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)):</span>
            <span class="n">l_sys</span><span class="p">[</span><span class="s1">&#39;ANGLE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">units</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="s1">&#39;rad&#39;</span><span class="p">)</span>

        <span class="n">expanded_unit</span> <span class="o">=</span> <span class="n">expand_components</span><span class="p">(</span><span class="n">unit</span><span class="p">,</span> <span class="n">mdmc_sys</span><span class="p">)</span>
        <span class="c1"># For each MDMC unit, determine the LAMMPS system unit that corresponds</span>
        <span class="c1"># to that physical property (e.g. &#39;kJ / mol&#39; -&gt; &#39;ENERGY&#39; -&gt; &#39;kcal / mol&#39;)</span>
        <span class="n">l_unit_nums</span><span class="p">,</span> <span class="n">l_unit_denoms</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">unit_comps</span><span class="p">:</span> <span class="p">[</span><span class="n">l_sys</span><span class="p">[</span><span class="n">comp</span><span class="o">.</span><span class="n">physical_property</span><span class="p">]</span>
                                                             <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">unit_comps</span><span class="p">],</span>
                                         <span class="n">expanded_unit</span><span class="p">)</span>

        <span class="c1"># In general we may have an MDMC measurement that is not wholly</span>
        <span class="c1"># expressed in MDMC system units, for example &#39;kJ / mol rad^2&#39; uses</span>
        <span class="c1"># &#39;rad&#39; rather than &#39;deg&#39;. To account for this, multiply by the</span>
        <span class="c1"># conversion_factor of the original MDMC unit to get the value in terms</span>
        <span class="c1"># of MDMC system units only.</span>
        <span class="n">value</span> <span class="o">*=</span> <span class="n">unit</span><span class="o">.</span><span class="n">conversion_factor</span>

        <span class="c1"># Then, for each component of the LAMMPS unit, divide by the</span>
        <span class="c1"># conversion_factor to go from MDMC system units to LAMMPS system units.</span>
        <span class="k">for</span> <span class="n">component</span> <span class="ow">in</span> <span class="n">l_unit_nums</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">/=</span> <span class="n">component</span><span class="o">.</span><span class="n">conversion_factor</span>
        <span class="k">for</span> <span class="n">component</span> <span class="ow">in</span> <span class="n">l_unit_denoms</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">*=</span> <span class="n">component</span><span class="o">.</span><span class="n">conversion_factor</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">*=</span> <span class="n">unit</span><span class="o">.</span><span class="n">conversion_factor</span>

    <span class="k">return</span> <span class="n">value</span></div>


<div class="viewcode-block" id="parse_bonded_styles"><a class="viewcode-back" href="../../../../pages/modules/md/engine_facades/lammps_engine.html#MDMC.MD.engine_facades.lammps_engine.parse_bonded_styles">[docs]</a><span class="k">def</span> <span class="nf">parse_bonded_styles</span><span class="p">(</span><span class="n">interaction</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Converts MDMC ``InteractionFunction`` names for ``BondedInteractions`` to</span>
<span class="sd">    LAMMP bond styles</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    interaction : BondedInteraction</span>
<span class="sd">        ``BondedInteraction`` to be parsed into LAMMPS bond style.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    `str`</span>
<span class="sd">        LAMMPS bond style corresponding to ``interaction``</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    NotImplementedError</span>
<span class="sd">        If ``interaction`` has a ``function`` that has not been implemented in</span>
<span class="sd">        the LAMMPS facade.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">interaction</span><span class="o">.</span><span class="n">function_name</span> <span class="o">==</span> <span class="s1">&#39;HarmonicPotential&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">interaction</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;DihedralAngle&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">interaction</span><span class="o">.</span><span class="n">improper</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;LAMMPS does not support harmonic proper dihedrals&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;harmonic&#39;</span>
    <span class="k">if</span> <span class="n">interaction</span><span class="o">.</span><span class="n">function_name</span> <span class="o">==</span> <span class="s1">&#39;Periodic&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">interaction</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s1">&#39;DihedralAngle&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;LAMMPS only supports periodic interaction function&#39;</span>
                            <span class="s1">&#39; for Dihedrals&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">interaction</span><span class="o">.</span><span class="n">improper</span><span class="p">:</span>
            <span class="c1"># LAMMPS has an improper_style called cvff, which is a Simplified</span>
            <span class="c1"># version of Periodic (it is only first order and d1=0). Return cvff</span>
            <span class="c1"># here and deal with incompatible Periodic interactions (e.g. d1!=0)</span>
            <span class="c1"># in parse_bonded_coefficients</span>
            <span class="k">return</span> <span class="s1">&#39;cvff&#39;</span>
        <span class="k">return</span> <span class="s1">&#39;fourier&#39;</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;This InteractionFunction has not been&#39;</span>
                              <span class="s1">&#39; implemented in the LAMMPS facade&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="parse_nonbonded_styles"><a class="viewcode-back" href="../../../../pages/modules/md/engine_facades/lammps_engine.html#MDMC.MD.engine_facades.lammps_engine.parse_nonbonded_styles">[docs]</a><span class="k">def</span> <span class="nf">parse_nonbonded_styles</span><span class="p">(</span><span class="n">interaction</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Converts MDMC ``InteractionFunction`` names for ``NonBondedInteractions`` to</span>
<span class="sd">    LAMMPS pair styles</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    interaction : NonBondedInteraction</span>
<span class="sd">        ``NonBondedInteraction`` to be parsed into LAMMPS pair style.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    `tuple`</span>
<span class="sd">        (``styles``, ``mods``) where ``styles`` is a `list` of `str` of LAMMPS</span>
<span class="sd">        pair style corresponding to the ``interaction``, and ``mods`` is a</span>
<span class="sd">        `list` of `str` of LAMMPS pair modifications corresponding to the</span>
<span class="sd">        interaction</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    NotImplementedError</span>
<span class="sd">        If ``interaction`` has a ``function`` that has not been implemented in</span>
<span class="sd">        the LAMMPS facade.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">lmp_str</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">interaction</span><span class="o">.</span><span class="n">function_name</span> <span class="o">==</span> <span class="s1">&#39;Buckingham&#39;</span><span class="p">:</span>
        <span class="n">lmp_str</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;buck&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">interaction</span><span class="o">.</span><span class="n">function_name</span> <span class="o">==</span> <span class="s1">&#39;LennardJones&#39;</span><span class="p">:</span>
        <span class="n">lmp_str</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;lj&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">interaction</span><span class="o">.</span><span class="n">function_name</span> <span class="o">==</span> <span class="s1">&#39;Coulomb&#39;</span><span class="p">:</span>
        <span class="n">lmp_str</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;coul&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;This InteractionFunction has not been&#39;</span>
                                  <span class="s1">&#39; implemented in the LAMMPS facade&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">interaction</span><span class="o">.</span><span class="n">cutoff</span><span class="p">:</span>
        <span class="n">cutoff</span> <span class="o">=</span> <span class="n">convert_unit</span><span class="p">(</span><span class="n">interaction</span><span class="o">.</span><span class="n">cutoff</span><span class="p">)</span>
        <span class="n">kspace</span> <span class="o">=</span> <span class="n">interaction</span><span class="o">.</span><span class="n">universe</span><span class="o">.</span><span class="n">kspace_solver</span>
        <span class="n">electrostatic</span> <span class="o">=</span> <span class="n">interaction</span><span class="o">.</span><span class="n">universe</span><span class="o">.</span><span class="n">electrostatic_solver</span>
        <span class="n">dispersive</span> <span class="o">=</span> <span class="n">interaction</span><span class="o">.</span><span class="n">universe</span><span class="o">.</span><span class="n">dispersive_solver</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">kspace</span> <span class="ow">or</span> <span class="p">(</span><span class="n">electrostatic</span> <span class="ow">and</span> <span class="n">interaction</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Coulombic&#39;</span><span class="p">)</span>
                <span class="ow">or</span> <span class="p">(</span><span class="n">dispersive</span> <span class="ow">and</span> <span class="n">interaction</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Dispersion&#39;</span><span class="p">)):</span>

            <span class="n">lmp_str</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;/long&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">interaction</span><span class="o">.</span><span class="n">function_name</span> <span class="o">!=</span> <span class="s1">&#39;Buckingham&#39;</span><span class="p">:</span>
                <span class="n">lmp_str</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;/cut&#39;</span>
        <span class="n">lmp_str</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cutoff</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;This InteractionFunction has not been&#39;</span>
                                  <span class="s1">&#39; implemented in the LAMMPS facade&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">lmp_str</span><span class="p">,</span> <span class="n">parse_nonbonded_modifications</span><span class="p">(</span><span class="n">interaction</span><span class="p">)</span></div>


<div class="viewcode-block" id="parse_nonbonded_modifications"><a class="viewcode-back" href="../../../../pages/modules/md/engine_facades/lammps_engine.html#MDMC.MD.engine_facades.lammps_engine.parse_nonbonded_modifications">[docs]</a><span class="k">def</span> <span class="nf">parse_nonbonded_modifications</span><span class="p">(</span><span class="n">interaction</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parses MDMC ``Interaction`` attributes into `list` that can be used with</span>
<span class="sd">    LAMMPS ``pair_modify`` command</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    interaction : Interaction</span>
<span class="sd">        The ``Interaction`` for which the attributes are parsed</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    `list`</span>
<span class="sd">        A `list` of `str` which are a valid ``pair_modify`` command, or an empty</span>
<span class="sd">        `list` if no ``Interaction`` attributes require setting ``pair_modify``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># LAMMPS pair_modify is of the following form:</span>
    <span class="c1"># pair_modify(&#39;pair&#39;, &#39;lj/cut&#39;, &#39;mix&#39;, &#39;geometric&#39;, &#39;tail&#39;, &#39;yes&#39;)</span>
    <span class="c1"># pair_modify(&#39;coul/long&#39;, &#39;mix&#39;, &#39;arithmetic&#39;)</span>
    <span class="c1"># where each pair style (lj/cut, coul/long etc) has any mix or tail keywords</span>
    <span class="c1"># defined after the pair style. If the same pair_style occurs multiple times</span>
    <span class="c1"># but with different modifiers</span>
    <span class="c1"># (e.g. &#39;lj/cut&#39;, &#39;mix&#39;, &#39;geometric&#39; and &#39;lj/cut&#39;, &#39;mix&#39;, &#39;arithmetic&#39;)</span>
    <span class="c1"># whichever pair_modify occurs last will be applied to all identical</span>
    <span class="c1"># pair_styles.</span>

    <span class="n">mods</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">interaction</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Dispersion&#39;</span> <span class="ow">and</span> <span class="n">interaction</span><span class="o">.</span><span class="n">vdw_tail_correction</span><span class="p">:</span>
        <span class="n">mods</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s1">&#39;tail yes&#39;</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">mods</span></div>


<div class="viewcode-block" id="parse_all_nonbonded_styles"><a class="viewcode-back" href="../../../../pages/modules/md/engine_facades/lammps_engine.html#MDMC.MD.engine_facades.lammps_engine.parse_all_nonbonded_styles">[docs]</a><span class="k">def</span> <span class="nf">parse_all_nonbonded_styles</span><span class="p">(</span><span class="n">interactions</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Converts all ``NonBondedInteractions`` to LAMMPS pair styles</span>

<span class="sd">    This is required because LAMMPS frequently treats ``Coulombic`` and</span>
<span class="sd">    ``Disperion`` interactions together; these cases need to be dealt with to</span>
<span class="sd">    generate the correct input to LAMMPS ``pair_styles``.  For example, while</span>
<span class="sd">    the ``pair_styles`` ``buck``, ``lj/cut``, ``coul/cut`` and ``coul/long`` can</span>
<span class="sd">    all be passed separately, the dispersive and coulombic styles are combined</span>
<span class="sd">    (dispersive always preceding coulombic) as this is dealt with more</span>
<span class="sd">    efficiently in the LAMMPS engine. ``buck/long`` and ``lj/long`` only exist</span>
<span class="sd">    as part of other pair styles, such as ``buck/long/coul/long`` and</span>
<span class="sd">    ``lj/long/coul/long``, so must be combined.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    interactions : list of NonBondedInteractions</span>
<span class="sd">        ``NonBondedInteractions`` to be parsed into LAMMPS ``pair_styles``.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    `dict`</span>
<span class="sd">        A `dict` with {``pair_styles``: ``pair_modifiers``} where</span>
<span class="sd">        ``pair_styles`` is a `tuple` of all of the combined LAMMPS pair styles</span>
<span class="sd">        corresponding to ``interactions``. Each `tuple` contains the combined</span>
<span class="sd">        ``pair_style`` as one element, and the ``cutoffs`` as the second element</span>
<span class="sd">        e.g. ``(&#39;lj/cut/coul/cut&#39;, 5.0 10.0)``. If additional arguments are</span>
<span class="sd">        required when combining styles, they will be added and returned in the</span>
<span class="sd">        `tuple` as the third and middle element</span>
<span class="sd">        e.g. ``(&#39;buck/long/coul/long&#39;, &#39;long long&#39;, &#39;10.0&#39;``).</span>
<span class="sd">        ``pair_modifiers`` is a `list` of `str` for setting ``pair_modify`` for</span>
<span class="sd">        the corresponding ``pair_style``.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        If ``Dispersion`` and ``Coulombic`` interactions have different long</span>
<span class="sd">        range ``cutoff``, which is not implemented in LAMMPS.</span>
<span class="sd">    ValueError</span>
<span class="sd">        If long range ``Dispersion`` not defined in conjunction with a long</span>
<span class="sd">        range ``Coulombic``.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">check_validity</span><span class="p">(</span><span class="n">pair_style</span><span class="p">,</span> <span class="n">cutoffs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Tests the validity of a LAMMPS ``pair_style``.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        pair_style : str</span>
<span class="sd">            The LAMMPS ``pair_style`` to be checked.</span>
<span class="sd">        cutoffs : list of float</span>
<span class="sd">            The cutoff distances for each style in the ``pair_style``.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        `list` of `str`</span>
<span class="sd">            Contains the inputted ``pair_style`` (if valid) as well as any extra</span>
<span class="sd">            terms required in specific cases (i.e. ``&#39;long long&#39;`` if the pair</span>
<span class="sd">            style ``&#39;buck/long/coul/long&#39;`` is passed).</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If the ``pair_style`` passed is not valid.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">pair_style</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;buck/long/coul/cut&#39;</span><span class="p">,</span> <span class="s1">&#39;lj/long/coul/cut&#39;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid pair_style: &#39;</span> <span class="o">+</span> <span class="n">pair_style</span>
                             <span class="o">+</span> <span class="s1">&#39;. LAMMPS requires long range Coulombics to be&#39;</span>
                             <span class="s1">&#39; defined in conjunction with long range Dispersion&#39;</span>
                             <span class="s1">&#39; interactions.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pair_style</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;buck/long/coul/long&#39;</span><span class="p">,</span> <span class="s1">&#39;lj/long/coul/long&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">cutoffs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">cutoffs</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;LAMMPS requires both cutoffs to be the same&#39;</span>
                                 <span class="s1">&#39; for long range Dispersion and Coulombic pair&#39;</span>
                                 <span class="s1">&#39; styles.&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">pair_style</span><span class="p">,</span> <span class="s1">&#39;long long&#39;</span><span class="p">]</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">pair_style</span><span class="p">]</span>

    <span class="c1"># Some pair styles cannot have vdw tail corrections modifiers - exclude</span>
    <span class="c1"># these and warn about this exclusion</span>
    <span class="c1"># This is dealth with here rather than in parse_nonbonded_modifications as</span>
    <span class="c1"># it is dependent on combined pair_styles</span>
    <span class="n">excluded</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;lj/long/coul/long&#39;</span><span class="p">]</span>

    <span class="c1"># Change parse_nonbonded_styles to return the parsed nonbonded style and the</span>
    <span class="c1"># parsed_ modifiers from that interaction</span>
    <span class="c1"># Create a dictionary of parsed_interactions (keys) and modifiers (values)</span>
    <span class="n">single_parsed_inters</span> <span class="o">=</span> <span class="p">{</span><span class="nb">tuple</span><span class="p">(</span><span class="n">parsed</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span> <span class="n">parsed</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">parsed</span> <span class="ow">in</span>
                            <span class="p">[</span><span class="n">parse_nonbonded_styles</span><span class="p">(</span><span class="n">nb</span><span class="p">)</span> <span class="k">for</span> <span class="n">nb</span> <span class="ow">in</span> <span class="n">interactions</span><span class="p">]}</span>
    <span class="n">combined_parsed_inters</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">single_parsed_inters</span><span class="p">)</span>
    <span class="c1"># Define all Dispersion and Coulombic styles currently supported</span>
    <span class="c1"># Dispersion styles always precede coulombic styles in LAMMPS pair styles</span>
    <span class="n">disp_styles</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;buck&#39;</span><span class="p">,</span> <span class="s1">&#39;buck/long&#39;</span><span class="p">,</span> <span class="s1">&#39;lj/cut&#39;</span><span class="p">,</span> <span class="s1">&#39;lj/long&#39;</span><span class="p">]</span>
    <span class="n">coul_styles</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;coul/cut&#39;</span><span class="p">,</span> <span class="s1">&#39;coul/long&#39;</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">d_style</span><span class="p">,</span> <span class="n">c_style</span> <span class="ow">in</span> <span class="n">product</span><span class="p">(</span><span class="n">disp_styles</span><span class="p">,</span> <span class="n">coul_styles</span><span class="p">):</span>
        <span class="n">dc_styles</span> <span class="o">=</span> <span class="p">[</span><span class="n">d_style</span><span class="p">,</span> <span class="n">c_style</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">int1</span><span class="p">,</span> <span class="n">int2</span> <span class="ow">in</span> <span class="n">combinations</span><span class="p">(</span><span class="n">single_parsed_inters</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="mi">2</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">int1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">dc_styles</span> <span class="ow">and</span> <span class="n">int2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">dc_styles</span><span class="p">):</span>
                <span class="n">indiv_cmd</span> <span class="o">=</span> <span class="n">check_validity</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dc_styles</span><span class="p">),</span>
                                           <span class="n">cutoffs</span><span class="o">=</span><span class="p">[</span><span class="n">int1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">int2</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
                <span class="c1"># Format cutoffs so that disp cutoff precedes coul cutoff if</span>
                <span class="c1"># they are different</span>
                <span class="k">if</span> <span class="n">int1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">int2</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="n">cutoffs</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">int1</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">d_cut</span><span class="p">,</span> <span class="n">c_cut</span> <span class="o">=</span> <span class="p">((</span><span class="n">int1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">int2</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">if</span> <span class="n">int1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">d_style</span>
                                    <span class="k">else</span> <span class="p">(</span><span class="n">int2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">int1</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                    <span class="n">cutoffs</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d_cut</span><span class="p">,</span> <span class="n">c_cut</span><span class="p">)</span>

                <span class="c1"># Add indiv_cmd to parsed_interactions dict instead. Use</span>
                <span class="c1"># modifier from parsed_interactions as value. set is used to</span>
                <span class="c1"># remove duplicated modifiers which occur for both interactions.</span>
                <span class="c1"># Delete int1 and int2 from parsed_interactions</span>
                <span class="n">mod</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">single_parsed_inters</span><span class="p">[</span><span class="n">int1</span><span class="p">]</span>
                          <span class="o">+</span> <span class="n">single_parsed_inters</span><span class="p">[</span><span class="n">int2</span><span class="p">])</span>
                <span class="c1"># Warn if incompatible pair_style and pair_modification have</span>
                <span class="c1"># been used</span>
                <span class="k">if</span> <span class="n">indiv_cmd</span> <span class="ow">in</span> <span class="n">excluded</span> <span class="ow">and</span> <span class="s1">&#39;tail yes&#39;</span> <span class="ow">in</span> <span class="n">mod</span><span class="p">:</span>
                    <span class="n">LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;parse_all_nonbonded_styles: </span><span class="si">%s</span><span class="s1"> pair style&#39;</span>
                                   <span class="s1">&#39; cannot have a vdw tail correction applied&#39;</span><span class="p">,</span>
                                   <span class="n">indiv_cmd</span><span class="p">)</span>
                    <span class="n">mod</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">md</span> <span class="k">for</span> <span class="n">md</span> <span class="ow">in</span> <span class="n">mod</span> <span class="k">if</span> <span class="n">md</span> <span class="o">!=</span> <span class="s1">&#39;tail yes&#39;</span><span class="p">)</span>
                <span class="n">combined_parsed_inters</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">indiv_cmd</span> <span class="o">+</span> <span class="p">[</span><span class="n">cutoffs</span><span class="p">])]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">mod</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="n">int1</span><span class="p">,</span> <span class="n">int2</span><span class="p">]:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">del</span> <span class="n">combined_parsed_inters</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="k">pass</span>

    <span class="k">return</span> <span class="n">combined_parsed_inters</span></div>


<div class="viewcode-block" id="parse_bonded_coefficients"><a class="viewcode-back" href="../../../../pages/modules/md/engine_facades/lammps_engine.html#MDMC.MD.engine_facades.lammps_engine.parse_bonded_coefficients">[docs]</a><span class="k">def</span> <span class="nf">parse_bonded_coefficients</span><span class="p">(</span><span class="n">interaction</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Orders MDMC ``Parameter`` objects for input to LAMMPS ``bond_coeff`` and</span>
<span class="sd">    ``angle_coeff``</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    interaction : BondedInteraction</span>
<span class="sd">        ``BondedInteraction`` where its style and parameters will be parsed.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    `list` of `str`</span>
<span class="sd">        Style and parameters converted to the input format for LAMMPS</span>
<span class="sd">        ``bond_coeff`` and ``angle_coeff``</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    NotImplementedError</span>
<span class="sd">        If ``interaction`` has a ``function`` that has not been implemented in</span>
<span class="sd">        the LAMMPS facade.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">parameters</span> <span class="o">=</span> <span class="p">{</span><span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="p">:</span><span class="n">convert_unit</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
                  <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">interaction</span><span class="o">.</span><span class="n">parameters</span><span class="p">}</span>
    <span class="n">style</span> <span class="o">=</span> <span class="n">parse_bonded_styles</span><span class="p">(</span><span class="n">interaction</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">style</span> <span class="o">==</span> <span class="s1">&#39;harmonic&#39;</span><span class="p">:</span>
        <span class="n">ordered_parameters</span> <span class="o">=</span> <span class="p">[</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;potential_strength&#39;</span><span class="p">],</span>
                              <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;equilibrium_state&#39;</span><span class="p">]]</span>
    <span class="k">elif</span> <span class="n">style</span> <span class="o">==</span> <span class="s1">&#39;fourier&#39;</span><span class="p">:</span>
        <span class="c1"># There are three parameters (K, n and d) for each order of the equation</span>
        <span class="n">fourier_order</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">interaction</span><span class="o">.</span><span class="n">parameters</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span>
        <span class="c1"># LAMMPS requires parameters to be ordered K1, n1, d1, K2, n2, d2 etc</span>
        <span class="c1"># So the letter sequence is:</span>
        <span class="n">ord_let</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;K&#39;</span><span class="p">,</span> <span class="s1">&#39;n&#39;</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">)</span>
        <span class="c1"># Sort by fourier_order first and then by letter sequence</span>
        <span class="n">ordered_p_names</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span>
                                 <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">p_name</span><span class="p">:</span> <span class="p">(</span><span class="n">p_name</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                                     <span class="n">ord_let</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">p_name</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
        <span class="c1"># Get parameters values and prepend the order of the equation</span>
        <span class="n">ordered_parameters</span> <span class="o">=</span> <span class="p">[</span><span class="n">fourier_order</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">parameters</span><span class="p">[</span><span class="n">p_name</span><span class="p">]</span> <span class="k">for</span> <span class="n">p_name</span>
                                                <span class="ow">in</span> <span class="n">ordered_p_names</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">style</span> <span class="o">==</span> <span class="s1">&#39;cvff&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;LAMMPS improper dihedrals can only have a Periodic&#39;</span>
                            <span class="s1">&#39; interaction function with first order&#39;</span>
                            <span class="s1">&#39; coefficients (e.g. K1, n1, d1)&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;d1&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mf">0.</span> <span class="ow">and</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;d1&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mf">180.</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;LAMMPS improper dihedrals can only have a Periodic&#39;</span>
                            <span class="s1">&#39; interaction with d1 = 0 deg or d = 180 deg&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;n1&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">6</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;LAMMPS improper dihedrals can only have a Periodic&#39;</span>
                            <span class="s1">&#39; interaction 0 &lt;= n1 &lt;= 6&#39;</span><span class="p">)</span>
        <span class="c1"># fourier and cvff have different d parameters. The definition of</span>
        <span class="c1"># Periodic is the same as the fourier style, so need to convert to cvff</span>
        <span class="c1"># d parameter (which can only take values of 1 or -1)</span>
        <span class="n">cvff_d</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;d1&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">ordered_parameters</span> <span class="o">=</span> <span class="p">[</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;K1&#39;</span><span class="p">],</span> <span class="n">cvff_d</span><span class="p">,</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;n1&#39;</span><span class="p">]]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;This InteractionFunction has not been&#39;</span>
                                  <span class="s1">&#39; implemented in the LAMMPS facade&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">[</span><span class="n">style</span><span class="p">]</span> <span class="o">+</span> <span class="n">ordered_parameters</span></div>


<div class="viewcode-block" id="parse_dispersion_coefficients"><a class="viewcode-back" href="../../../../pages/modules/md/engine_facades/lammps_engine.html#MDMC.MD.engine_facades.lammps_engine.parse_dispersion_coefficients">[docs]</a><span class="k">def</span> <span class="nf">parse_dispersion_coefficients</span><span class="p">(</span><span class="n">interactions</span><span class="p">,</span> <span class="n">nonbonded_styles</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Orders MDMC ``Parameter`` objects for input to LAMMPS ``pair_coeff``</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    interactions : list of NonBondedInteraction</span>
<span class="sd">        ``NonBondedInteractions`` where their style and parameters will be</span>
<span class="sd">        parsed.</span>
<span class="sd">    nonbonded_styles : list of tuple</span>
<span class="sd">        The parsed ``NonBondedInteractions``, where the combined ``pair_styles``</span>
<span class="sd">        have been created by the ``parse_all_nonbonded_styles`` function.</span>
<span class="sd">        If `None` (default), the ``interactions`` are parsed manually.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    `list` of `str`</span>
<span class="sd">        Each element is a partial ``pair_coeff`` command, containing a</span>
<span class="sd">        ``pair_style``, the ordered ``Dispersion`` ``Parameter`` objects</span>
<span class="sd">        converted to the correct input format for LAMMPS ``pair_coeff``, and the</span>
<span class="sd">        ``cutoff``.</span>
<span class="sd">        For example, if interactions contains a ``Buckingham`` with</span>
<span class="sd">        ``Parameter`` ``A, B, C = 4.184, 1.0, 4.184``, and ``cutoff = 20.0``,</span>
<span class="sd">        and a ``Coulombic`` with a ``cutoff`` of ``10.0``, the `str` element of</span>
<span class="sd">        the `list` will be::</span>

<span class="sd">            &#39;buck/coul/cut 1.0 1.0 1.0 20.0 10.0&#39;</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    NotImplementedError</span>
<span class="sd">        If ``interaction`` has a ``function`` that has not been implemented in</span>
<span class="sd">        the LAMMPS facade.</span>
<span class="sd">    ValueError</span>
<span class="sd">        If the LAMMPS Buckingham parameter rho is less than or equal to zero.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">nonbonded_styles</span><span class="p">:</span>
        <span class="n">nonbonded_styles</span> <span class="o">=</span> <span class="n">parse_all_nonbonded_styles</span><span class="p">(</span><span class="n">interactions</span><span class="p">)</span>

    <span class="n">coul_styles</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;coul/cut&#39;</span><span class="p">,</span> <span class="s1">&#39;coul/long&#39;</span><span class="p">]</span>
    <span class="n">coeff_cmds</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">style</span> <span class="ow">in</span> <span class="n">nonbonded_styles</span><span class="p">:</span>
        <span class="n">pair_style</span> <span class="o">=</span> <span class="n">style</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">cutoffs</span> <span class="o">=</span> <span class="n">style</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;buck&#39;</span> <span class="ow">in</span> <span class="n">pair_style</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">inter</span> <span class="ow">in</span> <span class="n">interactions</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">inter</span><span class="o">.</span><span class="n">function</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Buckingham&#39;</span><span class="p">:</span>
                    <span class="n">parameters</span> <span class="o">=</span> <span class="p">{</span><span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="p">:</span><span class="n">convert_unit</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
                              <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">inter</span><span class="o">.</span><span class="n">parameters</span><span class="p">}</span>
            <span class="n">ordered_parameters</span> <span class="o">=</span> <span class="p">[</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">],</span>
                              <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;B&#39;</span><span class="p">]</span> <span class="o">**</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                              <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">ordered_parameters</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="k">except</span> <span class="ne">AssertionError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;LAMMPS Buckingham parameter rho (= 1 / B)&#39;</span>
                                 <span class="s1">&#39; must be greater than 0&#39;</span><span class="p">)</span>
            <span class="n">coeff_cmd</span> <span class="o">=</span> <span class="p">(</span><span class="n">pair_style</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span>
                         <span class="o">+</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">ordered_parameters</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span>
                         <span class="o">+</span> <span class="n">cutoffs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s1">&#39;lj&#39;</span> <span class="ow">in</span> <span class="n">pair_style</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">inter</span> <span class="ow">in</span> <span class="n">interactions</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">inter</span><span class="o">.</span><span class="n">function</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;LennardJones&#39;</span><span class="p">:</span>
                    <span class="n">parameters</span> <span class="o">=</span> <span class="p">{</span><span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="p">:</span><span class="n">convert_unit</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
                              <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">inter</span><span class="o">.</span><span class="n">parameters</span><span class="p">}</span>
            <span class="n">ordered_parameters</span> <span class="o">=</span> <span class="p">[</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;epsilon&#39;</span><span class="p">],</span>
                              <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;sigma&#39;</span><span class="p">]]</span>
            <span class="n">coeff_cmd</span> <span class="o">=</span> <span class="p">(</span><span class="n">pair_style</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span>
                         <span class="o">+</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">ordered_parameters</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span>
                         <span class="o">+</span> <span class="n">cutoffs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">pair_style</span> <span class="ow">in</span> <span class="n">coul_styles</span><span class="p">:</span>
            <span class="n">coeff_cmd</span> <span class="o">=</span> <span class="n">pair_style</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;This InteractionFunction has not been&#39;</span>
                                      <span class="s1">&#39; implemented in the LAMMPS facade&#39;</span><span class="p">)</span>
        <span class="n">coeff_cmds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">coeff_cmd</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">coeff_cmds</span></div>


<div class="viewcode-block" id="parse_kspace_solver"><a class="viewcode-back" href="../../../../pages/modules/md/engine_facades/lammps_engine.html#MDMC.MD.engine_facades.lammps_engine.parse_kspace_solver">[docs]</a><span class="k">def</span> <span class="nf">parse_kspace_solver</span><span class="p">(</span><span class="n">solver</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Converts an MDMC ``KSpaceSolver`` for input to LAMMPS ``kspace_style``</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    solver : KSpaceSolver</span>
<span class="sd">        A ``KSpaceSolver`` to be parsed.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    `list`</span>
<span class="sd">        Style and parameters for input to LAMMPS ``kspace_style``</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    NotImplementedError</span>
<span class="sd">        If ``solver`` type has has not been implemented in the LAMMPS facade.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">lmp_str</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Add algorithm name</span>
    <span class="k">if</span> <span class="n">solver</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;ewald&#39;</span><span class="p">:</span>
        <span class="n">lmp_str</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;ewald&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">solver</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;pppm&#39;</span><span class="p">:</span>
        <span class="n">lmp_str</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;pppm&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;This k-space solver has not been implemented&#39;</span>
                                  <span class="s1">&#39; in the LAMMPS facade&#39;</span><span class="p">)</span>

    <span class="c1"># Add accuracy</span>
    <span class="n">lmp_str</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">solver</span><span class="o">.</span><span class="n">accuracy</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">lmp_str</span></div>

<div class="viewcode-block" id="parse_constraint"><a class="viewcode-back" href="../../../../pages/modules/md/engine_facades/lammps_engine.html#MDMC.MD.engine_facades.lammps_engine.parse_constraint">[docs]</a><span class="k">def</span> <span class="nf">parse_constraint</span><span class="p">(</span><span class="n">constraint_algorithm</span><span class="p">,</span> <span class="n">bonds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bond_ID_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">angles</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">angle_ID_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="c1"># ID is an acronym</span>
    <span class="c1">#pylint: disable=invalid-name</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Converts an MDMC ``ConstraintAlgorithm`` for input to LAMMPS fix</span>

<span class="sd">    At least one of bonds and angles must be passed.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    constraint_algorithm : ConstraintAlgorithm</span>
<span class="sd">        An object that derives from ``ConstraintAlgorithm`` to be parsed.</span>
<span class="sd">    bonds : list of Bonds, optional</span>
<span class="sd">        Constrained ``Bond`` interactions.</span>
<span class="sd">    bond_ID_dict : dict, optional</span>
<span class="sd">        `dict` with {``bond``: ``ID pairs``} relating each ``Bond`` object to a</span>
<span class="sd">        LAMMPS ``ID``.</span>
<span class="sd">    angles : list of BondAngles, optional</span>
<span class="sd">        Constrained ``BondAngle`` interactions.</span>
<span class="sd">    angle_ID_dict : dict, optional</span>
<span class="sd">        `dict` with {``angle``: ``ID pairs``} relating each ``BondAngle`` object</span>
<span class="sd">        to a LAMMPS ``ID``.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    `list`</span>
<span class="sd">        Input parameters for LAMMPS ``fix``, not including the first two terms</span>
<span class="sd">        (``fix ID``, ``group-ID``).  The output list has a maximum length of 7,</span>
<span class="sd">        where the last four entries are optional but a minimum of two is</span>
<span class="sd">        required::</span>

<span class="sd">            [algorithm name, accuracy, max iterations, &#39;b&#39;, bond IDs,</span>
<span class="sd">             &#39;a&#39;, angle IDs]</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    TypeError</span>
<span class="sd">        If there is not at least one ``constrained`` ``Interaction`` passed.</span>
<span class="sd">    NotImplementedError</span>
<span class="sd">        If ``constraint_algorithm`` not been implemented in the LAMMPS facade.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Raise error if there is not at least one constrained interaction passed</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">bonds</span> <span class="ow">or</span> <span class="n">angles</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;A LAMMPS constraint fix must have constraints on at&#39;</span>
                        <span class="s1">&#39; least one bond or one bond angle&#39;</span><span class="p">)</span>

    <span class="n">lmp_str</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Add algorithm name</span>
    <span class="k">if</span> <span class="n">constraint_algorithm</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;SHAKE&#39;</span><span class="p">:</span>
        <span class="n">lmp_str</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;shake&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">constraint_algorithm</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;RATTLE&#39;</span><span class="p">:</span>
        <span class="n">lmp_str</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;rattle&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;This constraint is not implemented in the&#39;</span>
                                  <span class="s1">&#39; LAMMPS facade&#39;</span><span class="p">)</span>

    <span class="c1"># Add accuracy and max iterations</span>
    <span class="n">lmp_str</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">constraint_algorithm</span><span class="o">.</span><span class="n">accuracy</span><span class="p">))</span>
    <span class="n">lmp_str</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">constraint_algorithm</span><span class="o">.</span><span class="n">max_iterations</span><span class="p">))</span>

    <span class="c1"># Never display the constraint statistics</span>
    <span class="n">lmp_str</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Add bonds and their LAMMPS IDs and angles and their LAMMPS IDs</span>
    <span class="k">if</span> <span class="n">bonds</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">bond_ID_dict</span><span class="p">:</span>
            <span class="n">bond_ID_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">lmp_str</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>
        <span class="n">lmp_str</span> <span class="o">+=</span> <span class="p">[</span><span class="n">bond_ID_dict</span><span class="p">[</span><span class="n">bond</span><span class="p">]</span> <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">bonds</span> <span class="k">if</span> <span class="n">bond</span><span class="o">.</span><span class="n">constrained</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">angles</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">angle_ID_dict</span><span class="p">:</span>
            <span class="n">angle_ID_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">lmp_str</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>
        <span class="n">lmp_str</span> <span class="o">+=</span> <span class="p">[</span><span class="n">angle_ID_dict</span><span class="p">[</span><span class="n">angle</span><span class="p">]</span> <span class="k">for</span> <span class="n">angle</span> <span class="ow">in</span> <span class="n">angles</span>
                    <span class="k">if</span> <span class="n">angle</span><span class="o">.</span><span class="n">constrained</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">lmp_str</span></div>


<div class="viewcode-block" id="partition"><a class="viewcode-back" href="../../../../pages/modules/md/engine_facades/lammps_engine.html#MDMC.MD.engine_facades.lammps_engine.partition">[docs]</a><span class="k">def</span> <span class="nf">partition</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">predicate</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Partitions an ``iterable`` using a predicate</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    items : iterable</span>
<span class="sd">        An ``interable`` to be partitioned.</span>
<span class="sd">    predicate : function</span>
<span class="sd">        A predicate that can be applied to items to returned `True` or `False`.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    `tuple`</span>
<span class="sd">        A `tuple` of (``gen_true``, ``gen_false``), where ``gen_true`` is a</span>
<span class="sd">        generator of all items for which the ``predicate`` returned `True`, and</span>
<span class="sd">        ``gen_false is a generator of all items for which the ``predicate``</span>
<span class="sd">        returned `False`</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">iter_a</span><span class="p">,</span> <span class="n">iter_b</span> <span class="o">=</span> <span class="n">tee</span><span class="p">((</span><span class="n">predicate</span><span class="p">(</span><span class="n">item</span><span class="p">),</span> <span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">((</span><span class="n">item</span> <span class="k">for</span> <span class="n">pred</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">iter_a</span> <span class="k">if</span> <span class="n">pred</span><span class="p">),</span>
            <span class="p">(</span><span class="n">item</span> <span class="k">for</span> <span class="n">pred</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">iter_b</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">pred</span><span class="p">))</span></div>


<div class="viewcode-block" id="partition_interactions"><a class="viewcode-back" href="../../../../pages/modules/md/engine_facades/lammps_engine.html#MDMC.MD.engine_facades.lammps_engine.partition_interactions">[docs]</a><span class="k">def</span> <span class="nf">partition_interactions</span><span class="p">(</span><span class="n">interactions</span><span class="p">,</span> <span class="n">names</span><span class="p">,</span> <span class="n">unpartitioned</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">lst</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Partitions an ``iterable`` of ``Interaction`` objects using a `list` of</span>
<span class="sd">    ``Interaction`` ``names``</span>

<span class="sd">    This occurs by using ``partition`` to filter out one ``Interaction`` type</span>
<span class="sd">    for each loop, so previously identified ``Interactions`` are no longer</span>
<span class="sd">    considered.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    interactions : iterable of Interactions</span>
<span class="sd">        An ``interable`` of ``Interaction`` objects to be partitioned.</span>
<span class="sd">    names : list of str</span>
<span class="sd">        Names of ``Interaction`` classes.</span>
<span class="sd">    unpartitioned : bool, optional</span>
<span class="sd">        If `True`, then a generator containing any ``Interaction`` objects that</span>
<span class="sd">        did not have a name in ``names`` is returned as an additional item in</span>
<span class="sd">        the `tuple`. Default is `False`.</span>
<span class="sd">    lst : bool, optional</span>
<span class="sd">        If `True`, then the returned `tuple` contains `list` rather than</span>
<span class="sd">        generators. ``Interaction`` objects which have the name specified by</span>
<span class="sd">        ``names[n]``. Default is `False`.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    `tuple`</span>
<span class="sd">        A `tuple` of length ``len(names)`` where ``index`` ``n`` is a generator</span>
<span class="sd">        of all of the ``Interaction`` objects which have the name specified by</span>
<span class="sd">        ``names[n]``. If ``unpartitioned`` is `True`, `tuple` is length ``n+1``.</span>
<span class="sd">        If ``lst`` is `True`, the generators are replaced by `list`.</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    Partion ``interactions`` into ``Bonds`` and ``BondAngles``:</span>

<span class="sd">        .. highlight:: python</span>
<span class="sd">        .. code-block:: python</span>

<span class="sd">            bonds, angles = partition_interactions(interactions,</span>
<span class="sd">                                                   [&#39;Bond, BondAngle&#39;])</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">interaction_lst</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
        <span class="n">predicate</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">name</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">n</span>
        <span class="n">interaction_lst</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">interactions</span> <span class="o">=</span> <span class="n">partition</span><span class="p">(</span><span class="n">interactions</span><span class="p">,</span> <span class="n">predicate</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">unpartitioned</span><span class="p">:</span>
        <span class="n">interaction_lst</span> <span class="o">+=</span> <span class="p">[</span><span class="n">interactions</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">lst</span><span class="p">:</span>
        <span class="n">interaction_lst</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">interaction_lst</span><span class="p">]</span>
    <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">interaction_lst</span><span class="p">)</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>